<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XCTrack Layout Editor</title>
    <!--
        XCTrack Layout Editor
        Created by: Laurent Fischer & Claude (Anthropic)
        For the paragliding community
        License: MIT - https://opensource.org/licenses/MIT
        GitHub: https://github.com/fidozbox-dev/XCTrackLayoutEditor
    -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úèÔ∏è</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap');

        :root {
            --sky: #0ea5e9;
            --sky-dim: #0284c7;
            --sky-glow: rgba(14, 165, 233, 0.15);
            --deep: #060d1a;
            --deeper: #040910;
            --card: #0d1b2e;
            --card-hover: #122236;
            --panel: #0f1f33;
            --border: rgba(14, 165, 233, 0.12);
            --border-bright: rgba(14, 165, 233, 0.35);
            --text: #d4e4f5;
            --text-dim: #6b8fae;
            --text-muted: #3d5a73;
            --green: #10b981;
            --green-dim: #059669;
            --red: #ef4444;
            --amber: #f59e0b;
            --radius: 8px;
            
            /* Phone screen - HYBRID: light blue for better widget visibility */
            --phone-bg: #e0f2fe;
            --phone-bezel: #0a0f1a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: #040910;
            min-height: 100vh;
            padding: 16px;
            color: var(--text);
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 300px;
            background: radial-gradient(ellipse at 50% -10%, rgba(14,165,233,0.08) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .container { max-width: 1700px; margin: 0 auto; position: relative; z-index: 1; }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            padding: 0 4px;
        }

        .header h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 3px;
            color: #fff;
            line-height: 1;
        }

        .header h1 span { color: var(--sky); }

        .header p {
            font-size: 0.75rem;
            color: var(--text-dim);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-top: 2px;
        }

        .header-center { text-align: center; }

        .github-link {
            position: absolute;
            top: 0; right: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            text-decoration: none;
            color: var(--text-dim);
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .github-link:hover { border-color: var(--sky); color: var(--sky); }
        .github-icon { width: 18px; height: 18px; }

        .header-buttons {
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            gap: 8px;
        }

        .lang-switch, .lang-toggle {
            position: relative;
        }

        .lang-toggle {
            display: flex;
            gap: 4px;
            padding: 6px 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }

        .lang-button {
            background: transparent;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            opacity: 0.4;
            transition: all 0.2s;
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--text);
        }

        .lang-button:hover { opacity: 0.7; }
        .lang-button.active { opacity: 1; background: var(--sky-glow); }

        /* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
        .main-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 16px;
            align-items: start;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
        .controls {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .controls h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 2px;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            margin-bottom: 4px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-group label {
            font-weight: 500;
            color: var(--text-dim);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-group.checkbox {
            flex-direction: row;
            align-items: center;
            gap: 8px;
        }

        .control-group.checkbox label {
            text-transform: none;
            font-size: 0.9rem;
            color: var(--text);
        }

        .control-group.checkbox input[type="checkbox"] {
            width: 16px; height: 16px; cursor: pointer;
            accent-color: var(--sky);
        }

        /* ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ */
        select {
            padding: 9px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--panel);
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
        }

        select:hover, select:focus {
            border-color: var(--sky);
            outline: none;
            box-shadow: 0 0 0 2px var(--sky-glow);
        }

        /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
        button {
            padding: 9px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--sky);
            color: white;
            font-weight: 500;
            font-family: 'DM Sans', sans-serif;
        }

        button:hover { background: var(--sky-dim); border-color: var(--sky-dim); }
        button.full-width { width: 100%; }

        /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
        .stats {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 0.85rem;
            padding: 12px;
            background: var(--panel);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-dim);
        }

        .stat strong { color: var(--sky); font-weight: 600; }

        /* ‚îÄ‚îÄ VIEWER ‚îÄ‚îÄ */
        .viewer {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            overflow-y: auto;
            overflow-x: hidden;
            height: calc(100vh - 120px);
            position: sticky;
            top: 16px;
            align-self: start;
        }

        .viewer::-webkit-scrollbar { width: 6px; }
        .viewer::-webkit-scrollbar-track { background: transparent; }
        .viewer::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 6px; }
        .viewer::-webkit-scrollbar-thumb:hover { background: var(--sky); }

        /* ‚îÄ‚îÄ PHONE ‚îÄ‚îÄ */
        .phone-container {
            position: relative;
            background: var(--phone-bezel);
            border-radius: 16px;
            padding: 12px;
            box-shadow: 0 0 0 1px rgba(14,165,233,0.2), 0 20px 60px rgba(0,0,0,0.6);
            width: fit-content;
        }

        .phone-screen {
            position: relative;
            background: var(--phone-bg);
            border-radius: 6px;
            overflow: hidden;
        }

        /* ‚îÄ‚îÄ WIDGETS ‚îÄ‚îÄ */
        .widget {
            position: absolute;
            border: 2px solid rgba(100,116,139,0.45);
            background: rgba(255,255,255,0.18);
            transition: all 0.15s;
            overflow: hidden;
        }

        .widget:hover {
            background: rgba(100,116,139,0.25);
            border-color: #0284c7;
            z-index: 10;
            box-shadow: 0 0 8px rgba(2,132,199,0.2);
        }

        .widget.selected {
            border-color: #0284c7 !important;
            background: rgba(2,132,199,0.25) !important;
            box-shadow: 0 0 0 2px #0284c7, 0 0 15px rgba(2,132,199,0.25) !important;
            z-index: 20;
        }

        .widget-label {
            position: absolute;
            top: 2px; left: 2px;
            font-size: 0.65rem;
            font-weight: 600;
            color: #1e293b;
            background: rgba(255,255,255,0.85);
            padding: 2px 6px;
            border-radius: 3px;
            pointer-events: none;
            z-index: 50;
            max-width: calc(100% - 8px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ‚îÄ‚îÄ WIDGET EDITOR ‚îÄ‚îÄ */
        .widget-editor {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
        }

        .widget-editor h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-bottom: 14px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .widget-props {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .prop-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .prop-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .prop-field label {
            font-size: 0.75rem;
            color: var(--text-dim);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .prop-field input, .prop-field select {
            padding: 7px 10px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.85rem;
            font-family: 'DM Sans', sans-serif;
            width: 100%;
        }

        .prop-field input:focus, .prop-field select:focus {
            outline: none;
            border-color: var(--sky);
            box-shadow: 0 0 0 2px var(--sky-glow);
        }

        /* ‚îÄ‚îÄ WIDGET LIBRARY ‚îÄ‚îÄ */
        .widget-library-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 6px;
        }

        .widget-library-item {
            padding: 8px 12px;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 0.82rem;
            font-weight: 500;
            color: var(--text-dim);
            font-family: 'DM Sans', sans-serif;
            text-align: left;
        }

        .widget-library-item:hover {
            background: var(--sky-glow);
            border-color: var(--sky);
            color: var(--sky);
            transform: translateX(3px);
        }

        /* ‚îÄ‚îÄ PAGE MANAGEMENT ‚îÄ‚îÄ */
        .page-management {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
        }

        .page-management h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-bottom: 14px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .page-type-buttons {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .page-type-btn {
            padding: 9px 12px;
            background: rgba(16,185,129,0.1);
            color: var(--green);
            border: 1px solid rgba(16,185,129,0.3);
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.2s;
            text-align: left;
        }

        .page-type-btn:hover {
            background: rgba(16,185,129,0.2);
            border-color: var(--green);
            transform: translateX(3px);
        }

        /* ‚îÄ‚îÄ UNDO TOAST ‚îÄ‚îÄ */
        .undo-toast {
            position: fixed;
            bottom: 24px; right: 24px;
            background: var(--card);
            border: 1px solid var(--border-bright);
            color: var(--text);
            padding: 10px 20px;
            border-radius: var(--radius);
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            z-index: 1000;
            animation: slideIn 0.25s ease-out;
            font-weight: 500;
            font-size: 0.9rem;
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to   { transform: translateY(0); opacity: 1; }
        }

        /* ‚îÄ‚îÄ VIEW MODE TOGGLE ‚îÄ‚îÄ */
        .view-mode-toggle {
            display: flex;
            gap: 0;
            border-radius: var(--radius);
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .view-mode-toggle button {
            border-radius: 0;
            border: none;
            border-right: 1px solid var(--border);
            background: var(--panel);
            color: var(--text-dim);
            padding: 7px 14px;
            font-weight: 500;
            font-size: 0.85rem;
        }

        .view-mode-toggle button:last-child { border-right: none; }
        .view-mode-toggle button.active { background: var(--sky); color: white; }
        .view-mode-toggle button:not(.active):hover { background: var(--sky-glow); color: var(--sky); }

        /* ‚îÄ‚îÄ PAGE GRID ‚îÄ‚îÄ */
        .page-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
            padding: 16px;
        }

        .page-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .page-card:hover {
            border-color: var(--border-bright);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
            transform: translateY(-2px);
        }

        .page-card.active {
            border-color: var(--sky);
            box-shadow: 0 0 0 1px var(--sky), 0 4px 16px var(--sky-glow);
        }

        .page-card h4 { color: var(--text); margin-bottom: 8px; font-size: 0.9rem; }

        .page-preview {
            background: var(--panel);
            border-radius: 6px;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .page-preview.portrait { aspect-ratio: 9/16; }
        .page-preview-screen { width: 100%; height: 100%; position: relative; }

        .page-widget-mini {
            position: absolute;
            border: 1px solid rgba(14,165,233,0.4);
            background: rgba(14,165,233,0.08);
        }

        .page-info-mini { font-size: 0.75rem; color: var(--text-dim); margin-top: 6px; }

        /* ‚îÄ‚îÄ DROP ZONE ‚îÄ‚îÄ */
        .drop-zone {
            border: 2px dashed var(--border-bright);
            border-radius: 12px;
            padding: 48px 40px;
            text-align: center;
            background: var(--card);
            transition: all 0.3s;
            cursor: pointer;
        }

        .drop-zone:hover, .drop-zone.drag-over {
            border-color: var(--sky);
            background: var(--sky-glow);
        }

        .drop-zone h2 { color: var(--text); margin-bottom: 12px; font-family: 'Bebas Neue', sans-serif; letter-spacing: 2px; font-size: 1.8rem; }
        .drop-zone p { color: var(--text-dim); margin-bottom: 20px; font-size: 0.9rem; }

        /* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(4, 9, 16, 0.88);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--card);
            border: 1px solid var(--border-bright);
            border-radius: 10px;
            padding: 28px;
            max-width: 480px;
            width: 90%;
            max-height: 82vh;
            overflow-y: auto;
            box-shadow: 0 24px 60px rgba(0,0,0,0.6);
        }

        .modal-header {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.6rem;
            letter-spacing: 2px;
            margin-bottom: 20px;
            color: #fff;
        }

        .form-group { margin-bottom: 18px; }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-dim);
            font-size: 0.82rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 9px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            background: var(--panel);
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--sky);
            box-shadow: 0 0 0 2px var(--sky-glow);
        }

        .form-group textarea { min-height: 80px; resize: vertical; }

        .modal-buttons {
            display: flex;
            gap: 8px;
            margin-top: 22px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 11px;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 500;
            font-family: 'DM Sans', sans-serif;
        }

        .btn-primary { background: var(--sky); color: white; }
        .btn-primary:hover { background: var(--sky-dim); border: none; }
        .btn-secondary { background: var(--panel); color: var(--text-dim); border: 1px solid var(--border) !important; }
        .btn-secondary:hover { background: var(--card-hover); color: var(--text); border: 1px solid var(--border) !important; }

        /* ‚îÄ‚îÄ PAGE LIST ITEMS (inline editor) ‚îÄ‚îÄ */
        .page-list-item {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .page-list-item:hover { border-color: var(--border-bright); }
        .page-list-item.active { border-color: var(--sky); background: var(--sky-glow); }

        /* ‚îÄ‚îÄ RESIZE & MOVE HANDLES ‚îÄ‚îÄ */
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ef4444;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 101;
        }

        .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }

        .move-handle {
            position: absolute;
            width: 32px;
            height: 32px;
            border: 2px dashed #ef4444;
            border-radius: 50%;
            background: rgba(239,68,68,0.12);
            cursor: move;
            z-index: 101;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: background 0.15s;
        }

        .move-handle:hover { background: rgba(239,68,68,0.25); }

        /* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
        .grid-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1;
        }

        .grid-line {
            position: absolute;
        }
        
        /* Grid visibility for hybrid theme (light phone) */
        .grid-line { background: rgba(100,116,139,0.2); }

        .grid-line.vertical  { width: 1px; height: 100%; }
        .grid-line.horizontal { height: 1px; width: 100%; }

        /* ‚îÄ‚îÄ WIDGET PREVIEW TEXT (light on dark screen) ‚îÄ‚îÄ */
        .widget-preview-value {
            color: #e2eaf5;
            font-weight: 700;
            line-height: 1;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        .widget-preview-unit {
            color: #7baabf;
            line-height: 1;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        /* ‚îÄ‚îÄ WIDGET INFO PANEL ‚îÄ‚îÄ */
        .widget-info-panel {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
        }

        .widget-info-panel h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-bottom: 14px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .widget-info-panel h4 {
            color: var(--sky);
            margin: 0 0 10px 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .widget-info-panel .coords {
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            color: var(--text-dim);
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-bottom: 14px;
            padding: 10px;
            background: var(--panel);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .widget-info-panel .no-selection {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            padding: 16px;
            font-size: 0.85rem;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .action-buttons button { width: 100%; }

        .delete-btn {
            background: rgba(239,68,68,0.12) !important;
            border: 1px solid rgba(239,68,68,0.35) !important;
            color: var(--red) !important;
        }
        .delete-btn:hover { background: rgba(239,68,68,0.22) !important; }

        .export-btn {
            background: rgba(16,185,129,0.12) !important;
            border: 1px solid rgba(16,185,129,0.35) !important;
            color: var(--green) !important;
        }
        .export-btn:hover { background: rgba(16,185,129,0.22) !important; }

        .import-btn {
            background: rgba(99,102,241,0.12) !important;
            border: 1px solid rgba(99,102,241,0.35) !important;
            color: #818cf8 !important;
        }
        .import-btn:hover { background: rgba(99,102,241,0.22) !important; }

        /* ‚îÄ‚îÄ WIDGET LIBRARY WRAPPER ‚îÄ‚îÄ */
        .widget-library {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            max-height: 800px;
            overflow-y: auto;
        }

        .widget-library h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1rem;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }

        .widget-library-section-title {
            font-weight: 600;
            color: var(--text-dim);
            margin-top: 12px;
            margin-bottom: 5px;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 4px;
        }

        /* ‚îÄ‚îÄ TIPS BOX ‚îÄ‚îÄ */
        .tips-box {
            background: rgba(14,165,233,0.05);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 14px;
        }

        .tips-box h3 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 0.9rem;
            letter-spacing: 2px;
            color: var(--sky);
            margin-bottom: 10px;
        }

        .tips-box ul {
            margin: 0;
            padding-left: 18px;
            font-size: 0.82rem;
            color: var(--text-dim);
            line-height: 1.7;
        }

        /* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
        .page-header-title {
            color: var(--text);
            font-size: 1rem;
            font-weight: 600;
            margin: 0;
        }

        .page-header-sub {
            font-size: 0.82rem;
            color: var(--text-dim);
            margin-left: 8px;
        }

        .page-btn {
            padding: 5px 10px !important;
            font-size: 0.85rem !important;
        }

        .page-btn-up   { background: rgba(14,165,233,0.1) !important; border: 1px solid var(--border) !important; color: var(--sky) !important; }
        .page-btn-down { background: rgba(14,165,233,0.1) !important; border: 1px solid var(--border) !important; color: var(--sky) !important; }
        .page-btn-del  { background: rgba(239,68,68,0.1)  !important; border: 1px solid rgba(239,68,68,0.3) !important; color: var(--red) !important; }
        .page-btn-up:hover   { background: rgba(14,165,233,0.2) !important; }
        .page-btn-down:hover { background: rgba(14,165,233,0.2) !important; }
        .page-btn-del:hover  { background: rgba(239,68,68,0.2)  !important; }
        .page-btn-up:disabled, .page-btn-down:disabled { opacity: 0.25 !important; cursor: not-allowed !important; }

        /* ‚îÄ‚îÄ SCROLLBARS ‚îÄ‚îÄ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-bright); border-radius: 6px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--sky); }

        /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
        @media (max-width: 1200px) {
            .main-layout { grid-template-columns: 1fr; }
            .sidebar { order: 2; }
            .viewer { order: 1; }
        }

        @media (max-width: 768px) {
            .header h1 { font-size: 1.5rem; }
        }
    </style>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- html2canvas for screenshots -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Initialize Supabase BEFORE Babel -->
    <script>
        console.log('Pre-Babel: window.supabase =', window.supabase);
        
        const SUPABASE_URL = 'https://ovhbpujablpfunnpkuxh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGJwdWphYmxwZnVubnBrdXhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MDE2MDIsImV4cCI6MjA4NjQ3NzYwMn0.3wKwiUyUMOKR3RFIlFPlLFiQFwrH6aOf7NQ8OKvLZ0U';
        
        // Create Supabase client in global scope BEFORE React
        window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase client created:', window.supabaseClient);
    </script>

    <script type="text/babel">
        const { useState, useMemo, useRef, useEffect } = React;

        // Use Supabase client created before Babel
        let supabase = window.supabaseClient || null;
        console.log('In React: supabase =', supabase);

        const RESOLUTION_PRESETS = [
            { name: 'Samsung A51 (1080√ó2400)', width: 2400, height: 1080, gridCols: 44, gridRows: 22 },
            { name: 'Standard HD (1080√ó1920)', width: 1920, height: 1080, gridCols: 35, gridRows: 20 },
        ];

        const getWidgetName = (className) => {
            const match = className.match(/\.([^.]+)$/);
            if (!match) return className;
            const name = match[1];
            // Retirer le pr√©fixe "W" pour les widgets et "WP" pour les pages
            if (name.startsWith('WP')) return name.substring(2);
            if (name.startsWith('W')) return name.substring(1);
            return name;
        };

        const calculateGridSize = (resolution) => {
            return {
                horizontal: 10000 / resolution.gridCols,
                vertical: 10000 / resolution.gridRows
            };
        };

        const snapToGrid = (value, gridSize, enabled) => {
            if (!enabled) return value;
            return Math.round(value / gridSize) * gridSize;
        };

        // Templates de widgets pour la biblioth√®que
        const WIDGET_LIBRARY = {
            "WAltitude": { CLASS: "org.xcontest.XCTrack.widget.w.WAltitude", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, _units: "SYS_UNIT" },
            "WSpeed": { CLASS: "org.xcontest.XCTrack.widget.w.WSpeed", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, _units: "SYS_UNIT", backwardDetection: false },
            "WVerticalSpeed": { CLASS: "org.xcontest.XCTrack.widget.w.WVerticalSpeed", _border: false, _bg: 100, _theme: "", _title: false, titletext: "", _unit: false, _hide_labels: false, avg: 2000 },
            "WGlide": { CLASS: "org.xcontest.XCTrack.widget.w.WGlide", _border: false, _bg: 100, _theme: "", _title: false, titletext: "", _unit: true, _hide_labels: false, showVario: false, avg: 2000, headless: true },
            "WTime": { CLASS: "org.xcontest.XCTrack.widget.w.WTime", _border: false, _bg: 100, _theme: "", _title: false, titletext: "", showSec: false },
            "WWindSpeed": { CLASS: "org.xcontest.XCTrack.widget.w.WWindSpeed", _border: true, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WAltitudeAboveGround": { CLASS: "org.xcontest.XCTrack.widget.w.WAltitudeAboveGround", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WAltitudeMaximum": { CLASS: "org.xcontest.XCTrack.widget.w.WAltitudeMaximum", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WThermalAltGain": { CLASS: "org.xcontest.XCTrack.widget.w.WThermalAltGain", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WAirTime": { CLASS: "org.xcontest.XCTrack.widget.w.WAirTime", _border: true, _bg: 100, _theme: "", _title: true, titletext: "" },
            "WStatusLine": { CLASS: "org.xcontest.XCTrack.widget.w.WStatusLine", _border: false, _bg: 100, _theme: "", showGps: true, showSensors: true, showLive: true, showLiveLabel: false, showBatteryIcon: true, showBatteryPercent: true, showTime: false },
            "WCompass": { CLASS: "org.xcontest.XCTrack.widget.w.WCompass", _border: true, _bg: 100, _theme: "", rotation: "BEARING", navigation_target: "OPTIMIZED", showWind: true, newWindArrow: true, showHeading: false, showBearing: false, showBackground: false },
            "WOptiResult": { CLASS: "org.xcontest.XCTrack.widget.w.WOptiResult", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WAirspaceProximity": { CLASS: "org.xcontest.XCTrack.widget.w.WAirspaceProximity", _border: true, _bg: 60, _theme: "", maxDistance: 5000, _shownearinside: true, _showoriginalheightline: true, _showrecomputedheightline: false, _splitdirection: "HORIZONTAL", postponedFloorLimit: 2500, postponedDisplayDistance: 300 },
            "WThermalAssistant": { CLASS: "org.xcontest.XCTrack.widget.w.WThermalAssistant", _border: false, _bg: 80, _theme: "", rotation: { value: "BEARING_AT_TOP", showCompass: false }, mapScale: { value: 36, auto: false }, drawScale: false, fontSize: "LARGE", mapWidget_heading_arrow_sizecoef: 152, mapWidget_showAirspaces: true, postponedFloorLimit: 2500, postponedDisplayDistance: 600, interval: 330, drawCircle: true, includeWindAlgorithm: "ALGO_PARTICLE_DRIFT", nav_target: "OPTIMIZED", nav_use_brackets: true, nav_line: true, thermals: 3, nav_showWind: true, nav_showSun: false, line_thickness: 20, mapWidget_drawBearing: true },
            "WXCAssistant": { CLASS: "org.xcontest.XCTrack.widget.w.WXCAssistant", _border: false, _bg: 80, _theme: "", rotation: { value: "BEARING_AT_TOP", showCompass: false }, mapScale: { value: 100, auto: false }, drawScale: false, fontSize: "LARGE", mapWidget_heading_arrow_sizecoef: 152, mapWidget_showAirspaces: true, postponedFloorLimit: 2500, postponedDisplayDistance: 600, nav_target: "OPTIMIZED", nav_use_brackets: true, nav_line: true, nav_showWind: true, nav_showSun: false, line_thickness: 20, mapWidget_drawBearing: true },
            "WCompMap": { CLASS: "org.xcontest.XCTrack.widget.w.WCompMap", _border: false, _bg: 80, _theme: "", rotation: { value: "BEARING_AT_TOP", showCompass: false }, mapScale: { value: 100, auto: false }, drawScale: false, fontSize: "LARGE", mapWidget_heading_arrow_sizecoef: 152, mapWidget_showAirspaces: true, postponedFloorLimit: 2500, postponedDisplayDistance: 600, nav_target: "OPTIMIZED", nav_use_brackets: true, nav_line: true, line_thickness: 20, mapWidget_drawBearing: true },
            "WCompDistanceToGoal": { CLASS: "org.xcontest.XCTrack.widget.w.WCompDistanceToGoal", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WCompGlideToGoal": { CLASS: "org.xcontest.XCTrack.widget.w.WCompGlideToGoal", _border: true, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, headless: false },
            "WCompAltitudeOverGoal": { CLASS: "org.xcontest.XCTrack.widget.w.WCompAltitudeOverGoal", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WCompTimeToStart": { CLASS: "org.xcontest.XCTrack.widget.w.WCompTimeToStart", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _hide_labels: false },
            "WCompTimeAtStart": { CLASS: "org.xcontest.XCTrack.widget.w.WCompTimeAtStart", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, navigation_target: "OPTIMIZED", use_brackets: true, speed_type: "GROUND", speed_avg: 10000, time_format: "COMPACT" },
            "WNextTurnpointDistance": { CLASS: "org.xcontest.XCTrack.widget.w.WNextTurnpointDistance", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, navigation_target: "OPTIMIZED", use_brackets: true },
            "WNextTurnpointAlt": { CLASS: "org.xcontest.XCTrack.widget.w.WNextTurnpointAlt", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, navigation_target: "OPTIMIZED", use_brackets: false, speed_avg: 8000, altitude: "AMSL", glide: "COMPUTED" },
            "WNextTurnpointGlideTo": { CLASS: "org.xcontest.XCTrack.widget.w.WNextTurnpointGlideTo", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, navigation_target: "OPTIMIZED", use_brackets: false, alt_above: 600, headless: false },
            "WNextTurnpointTimeOfArrival": { CLASS: "org.xcontest.XCTrack.widget.w.WNextTurnpointTimeOfArrival", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, navigation_target: "OPTIMIZED", use_brackets: false, speed_type: "GROUND", speed_avg: 8000, time_format: "COMPACT" },
            "WXCSpeed": { CLASS: "org.xcontest.XCTrack.widget.w.WXCSpeed", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WFreeText": { CLASS: "org.xcontest.XCTrack.widget.w.WFreeText", _border: false, _theme: "BlackTheme", text: "Text", color_text: -5000269, color_bg: 16777215, text_size: 40, text_bold: true, text_italic: false, text_padding: 10 },
            "WVerticalGraph": { CLASS: "org.xcontest.XCTrack.widget.w.WVerticalGraph", _border: false, _bg: 100, _theme: "", interval: 90000, vertical_step: 50, dot_size: 10, dot_color: -8355585 },
            "WSideView": { CLASS: "org.xcontest.XCTrack.widget.w.WSideView", _border: false, _bg: 100, _theme: "", type: "SIDE_NAVIG", distance: 15000, finalGlideAvg: 9000 },
            "WAltitudeDataGraph": { CLASS: "org.xcontest.XCTrack.widget.w.WAltitudeDataGraph", _border: true, _bg: 100, _theme: "", type: "GRAPH_WIND", text_size: 20, line_thickness: 10, color_thermal: -2147483393, color_wind: -2136956896 },
            "WButtonZoomOut": { CLASS: "org.xcontest.XCTrack.widget.w.WButtonZoom", _border: true, _bg: 100, _theme: "", type: "ACTION_ZOOM_OUT" },
            "WButtonZoomIn": { CLASS: "org.xcontest.XCTrack.widget.w.WButtonZoom", _border: true, _bg: 100, _theme: "", type: "ACTION_ZOOM_IN" },
            "WButtonNavigPrev": { CLASS: "org.xcontest.XCTrack.widget.w.WButtonNavig", _border: true, _bg: 100, _theme: "", longClick: true, type: "ACTION_PREV_WAYPOINT" },
            "WButtonNavigNext": { CLASS: "org.xcontest.XCTrack.widget.w.WButtonNavig", _border: true, _bg: 100, _theme: "", longClick: true, type: "ACTION_NEXT_WAYPOINT" },
        };

        // Types de pages disponibles
        const PAGE_TYPES = [
            { name: "Thermal Assistant", CLASS: "org.xcontest.XCTrack.widget.wp.WPThermalAssistant", navigations: "all" },
            { name: "XC Assistant", CLASS: "org.xcontest.XCTrack.widget.wp.WPXCAssistant", navigations: "all" },
            { name: "Competition", CLASS: "org.xcontest.XCTrack.widget.wp.WPCompetition", navigations: ["org.xcontest.XCTrack.navig.TaskCompetition"] },
            { name: "Empty (Blank)", CLASS: "org.xcontest.XCTrack.widget.wp.WPEmpty", navigations: "all" },
        ];

        // Previews pour les widgets
        const WIDGET_PREVIEWS = {
            "WAltitude": { text: "1234", unit: "m", baseSize: 2.5 },
            "WAltitudeAboveGround": { text: "856", unit: "m", baseSize: 2.5 },
            "WAltitudeMaximum": { text: "2891", unit: "m", baseSize: 2.5 },
            "WSpeed": { text: "24", unit: "km/h", baseSize: 2.5 },
            "WXCSpeed": { text: "32", unit: "km/h", baseSize: 2.5 },
            "WVerticalSpeed": { text: "+1.2", unit: "m/s", baseSize: 2.5 },
            "WGlide": { text: "8.5", unit: "", baseSize: 2.5 },
            "WWindSpeed": { text: "12", unit: "km/h", baseSize: 2 },
            "WTime": { text: "14:32", baseSize: 2.5 },
            "WAirTime": { text: "01:23:45", baseSize: 2 },
            "WThermalAltGain": { text: "+180", unit: "m", baseSize: 2 },
            "WOptiResult": { text: "42.3", unit: "km", baseSize: 2 },
            "WStatusLine": { icon: "üì∂ üîã üíö", baseSize: 1.2 },
            "WCompass": { icon: "üß≠", baseSize: 2.8 },
            "WThermalAssistant": { icon: "üåÄ", baseSize: 3 },
            "WXCAssistant": { icon: "üó∫Ô∏è", baseSize: 3 },
            "WCompMap": { icon: "üó∫Ô∏è", baseSize: 3 },
            "WAirspaceProximity": { text: "2.5km", unit: "", baseSize: 1.5 },
            "WCompDistanceToGoal": { text: "18.2", unit: "km", baseSize: 2 },
            "WCompGlideToGoal": { text: "7.2", unit: "", baseSize: 2 },
            "WCompAltitudeOverGoal": { text: "+450", unit: "m", baseSize: 2 },
            "WCompTimeToStart": { text: "12:30", unit: "", baseSize: 2 },
            "WCompTimeAtStart": { text: "00:15", unit: "", baseSize: 2 },
            "WNextTurnpointDistance": { text: "5.8", unit: "km", baseSize: 2 },
            "WNextTurnpointAlt": { text: "1650", unit: "m", baseSize: 2 },
            "WNextTurnpointGlideTo": { text: "9.2", unit: "", baseSize: 2 },
            "WNextTurnpointTimeOfArrival": { text: "15:45", unit: "", baseSize: 1.8 },
            "WVerticalGraph": { icon: "üìà", baseSize: 2 },
            "WSideView": { icon: "‚õ∞Ô∏è", baseSize: 2 },
            "WAltitudeDataGraph": { icon: "üìä", baseSize: 2 },
            "WFreeText": { text: "TEXT", unit: "", baseSize: 2 },
            "WButtonZoomOut": { icon: "üîç‚ûñ", baseSize: 1.75 },
            "WButtonZoomIn": { icon: "üîç‚ûï", baseSize: 1.75 },
            "WButtonNavigPrev": { icon: "‚óÄÔ∏è", baseSize: 2.5 },
            "WButtonNavigNext": { icon: "‚ñ∂Ô∏è", baseSize: 2.5 },
        };

        const XCTrackViewer = () => {
            // ‚îÄ‚îÄ ANALYTICS SYSTEM ‚îÄ‚îÄ
            const getOrCreateSessionId = () => {
                let sessionId = sessionStorage.getItem('xctrack_session_id');
                if (!sessionId) {
                    sessionId = crypto.randomUUID();
                    sessionStorage.setItem('xctrack_session_id', sessionId);
                }
                return sessionId;
            };

            const trackEvent = async (eventType, metadata = {}) => {
                try {
                    const sessionId = getOrCreateSessionId();
                    const userId = user?.id || null;
                    
                    await supabase.from('analytics_events').insert({
                        event_type: eventType,
                        user_id: userId,
                        session_id: sessionId,
                        metadata: metadata
                    });
                } catch (error) {
                    // Silent fail - analytics shouldn't break the app
                    console.debug('Analytics error:', error);
                }
            };

            const updateSession = async () => {
                try {
                    const sessionId = getOrCreateSessionId();
                    const userId = user?.id || null;
                    
                    // Upsert session (insert or update)
                    await supabase.from('analytics_sessions').upsert({
                        session_id: sessionId,
                        user_id: userId,
                        last_activity_at: new Date().toISOString(),
                        theme: theme,
                        lang: language,
                        user_agent: navigator.userAgent
                    }, {
                        onConflict: 'session_id'
                    });
                } catch (error) {
                    console.debug('Session update error:', error);
                }
            };

            const [configData, setConfigData] = useState(null);
            const [orientation, setOrientation] = useState('landscape');
            const [selectedWidget, setSelectedWidget] = useState(null);
            const [selectedPage, setSelectedPage] = useState(0);
            const [showGrid, setShowGrid] = useState(true);
            const [snapEnabled, setSnapEnabled] = useState(true);
            const [resolutionIndex, setResolutionIndex] = useState(0);
            const [dragState, setDragState] = useState(null);
            const [isDragOver, setIsDragOver] = useState(false);
            const [copiedWidget, setCopiedWidget] = useState(null);
            const [showWidgetLibrary, setShowWidgetLibrary] = useState(false);
            const [widgetFilter, setWidgetFilter] = useState('');
            
            // Undo/Redo history
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [undoMessage, setUndoMessage] = useState('');
            
            // Community states
            const [user, setUser] = useState(null);
            const [showCommunityModal, setShowCommunityModal] = useState(false);
            const [showBrowseModal, setShowBrowseModal] = useState(false);
            const [showPreviewModal, setShowPreviewModal] = useState(false);
            const [previewConfig, setPreviewConfig] = useState(null);
            const [communityConfigs, setCommunityConfigs] = useState([]);
            const [communityFilters, setCommunityFilters] = useState([]);
            const [communitySortBy, setCommunitySortBy] = useState('upvotes');
            
            // CSS Live Editor
            const [showCSSEditor, setShowCSSEditor] = useState(false);
            const [liveCSS, setLiveCSS] = useState('');
            const [cssSearch, setCSSSearch] = useState('');
            
            // Save modal form states
            const [configName, setConfigName] = useState('');
            const [configDescription, setConfigDescription] = useState('');
            const [configTags, setConfigTags] = useState([]);
            
            const toggleTag = (tag) => {
                if (configTags.includes(tag)) {
                    setConfigTags(configTags.filter(t => t !== tag));
                } else {
                    setConfigTags([...configTags, tag]);
                }
            };

            const toggleFilter = (tag) => {
                if (communityFilters.includes(tag)) {
                    setCommunityFilters(communityFilters.filter(t => t !== tag));
                } else {
                    setCommunityFilters([...communityFilters, tag]);
                }
            };
            
            const screenRef = useRef(null);
            const fileInputRef = useRef(null);

            // Syst√®me de langue avec persistance
            const [language, setLanguage] = useState(() => {
                const saved = localStorage.getItem('xctrackEditorLang');
                return saved || (navigator.language.startsWith('fr') ? 'fr' : 'en');
            });

            const toggleLanguage = () => {
                const newLang = language === 'fr' ? 'en' : 'fr';
                setLanguage(newLang);
                localStorage.setItem('xctrackEditorLang', newLang);
            };

            // Analytics: Track page view on mount
            useEffect(() => {
                trackEvent('page_view');
                updateSession();
            }, []);

            // Analytics: Track language changes
            useEffect(() => {
                if (language) {
                    trackEvent('lang_switched', { lang: language });
                    updateSession();
                }
            }, [language]);

            const lang = language;
            
            // Traductions
            const t = {
                fr: {
                    title: "XCTrack Layout Editor",
                    subtitle: "Visualisez et √©ditez vos layouts XCTrack",
                    loadFile: "Chargez votre fichier de configuration",
                    dropFile: "Glissez-d√©posez votre fichier .xcfg ici",
                    selectFile: "S√©lectionner un fichier",
                    config: "Configuration",
                    undo: "Undo",
                    redo: "Redo",
                    resolution: "R√©solution",
                    orientation: "Orientation",
                    landscape: "Paysage",
                    portrait: "Portrait",
                    showGrid: "Afficher la grille",
                    snapToGrid: "Magn√©tisme grille",
                    export: "Exporter xcfg file",
                    widgetLibrary: "Biblioth√®que de widgets",
                    pages: "‚ûï Ajouter une page",
                    selectedWidget: "Widget s√©lectionn√©",
                    noWidget: "Aucun widget s√©lectionn√©.",
                    clickWidget: "Cliquez sur un widget pour le modifier.",
                    ctrlClickTip: "Astuce : Utilisez",
                    ctrlClickTip2: "pour s√©lectionner des widgets superpos√©s",
                    copy: "Copier",
                    duplicate: "Dupliquer",
                    delete: "Supprimer",
                    deselect: "D√©s√©lectionner",
                    widgetCopied: "Widget copi√© :",
                    pasteCenter: "Coller au centre",
                    totalPages: "Total pages:",
                    totalWidgets: "Total widgets:",
                    widgets: "widgets",
                    moveUp: "Monter la page",
                    moveDown: "Descendre la page",
                    deletePage: "Supprimer cette page",
                    tips: "üí° Astuces",
                    tip1: "Ctrl+Click pour s√©lectionner des widgets superpos√©s",
                    tip2: "Utilisez Google Drive comme pont entre Android et l'√©diteur",
                    tip3: "Ctrl+Z pour annuler, Ctrl+Y pour r√©tablir",
                    tip4: "Activez le magn√©tisme grille pour un alignement parfait",
                    tip5: "Copiez des widgets entre pages avec Ctrl+C / Ctrl+V",
                    filterWidgets: "Filtrer les widgets...",
                    importConfig: "Importer une configuration",
                    importDesc: "Glissez-d√©posez votre fichier .xcfg ici",
                    importDescOr: "ou cliquez pour parcourir",
                    createConfig: "Cr√©er une nouvelle configuration",
                    createDesc: "Commencez avec une page vide",
                    createDescAnd: "et ajoutez vos widgets",
                    newConfig: "Nouvelle configuration",
                    importButton: "üìÇ Importer xcfg file",
                    exportButton: "üíæ Exporter xcfg file",
                    addPage: "‚ûï Ajouter une page",
                    noPageFound: "Aucune page trouv√©e pour cette orientation",
                    reloadFile: "Recharger le fichier",
                    page: "Page",
                    // Community Library
                    community: "Biblioth√®que Communaut√©",
                    signIn: "Se connecter",
                    signInWith: "Se connecter avec",
                    signOut: "Se d√©connecter",
                    myConfigs: "Mes Configs",
                    saveToCloud: "üíæ Sauvegarder dans le cloud",
                    browseConfigs: "üìÇ Parcourir la communaut√©",
                    uploadConfig: "Partager cette config",
                    configName: "Nom de la configuration",
                    configDescription: "Description (optionnel)",
                    category: "Cat√©gorie",
                    categoryCross: "üèîÔ∏è Cross-country",
                    categoryCompete: "üèÅ Comp√©tition",
                    categoryCasual: "‚òÄÔ∏è Thermique/Loisir",
                    categoryExperimental: "üÜï Exp√©rimental",
                    upload: "Partager",
                    cancel: "Annuler",
                    close: "Fermer",
                    popular: "Populaire",
                    recent: "R√©cent",
                    mostDownloaded: "Plus t√©l√©charg√©",
                    upvote: "üëç Vote",
                    download: "‚¨áÔ∏è T√©l√©charger",
                    downloads: "t√©l√©chargements",
                    by: "par",
                    anonymous: "Anonyme",
                    signInToUpload: "Connectez-vous pour sauvegarder vos configs",
                    signInToVote: "Connectez-vous pour voter",
                    uploadSuccess: "Configuration partag√©e avec succ√®s !",
                    uploadError: "Erreur lors du partage",
                    deleteConfig: "Supprimer",
                    editConfig: "Modifier",
                    confirmDelete: "Supprimer cette configuration ?",
                },
                en: {
                    title: "XCTrack Layout Editor",
                    subtitle: "View and edit your XCTrack layouts",
                    loadFile: "Load your configuration file",
                    dropFile: "Drag and drop your .xcfg file here",
                    selectFile: "Select a file",
                    config: "Configuration",
                    undo: "Undo",
                    redo: "Redo",
                    resolution: "Resolution",
                    orientation: "Orientation",
                    landscape: "Landscape",
                    portrait: "Portrait",
                    showGrid: "Show grid",
                    snapToGrid: "Snap to grid",
                    export: "Export xcfg file",
                    widgetLibrary: "Widget Library",
                    pages: "‚ûï Add Page",
                    selectedWidget: "Selected Widget",
                    noWidget: "No widget selected.",
                    clickWidget: "Click on a widget to edit it.",
                    ctrlClickTip: "Tip: Use",
                    ctrlClickTip2: "to select overlapping widgets",
                    copy: "Copy",
                    duplicate: "Duplicate",
                    delete: "Delete",
                    deselect: "Deselect",
                    widgetCopied: "Widget copied:",
                    pasteCenter: "Paste at center",
                    totalPages: "Total pages:",
                    totalWidgets: "Total widgets:",
                    widgets: "widgets",
                    moveUp: "Move page up",
                    moveDown: "Move page down",
                    deletePage: "Delete this page",
                    tips: "üí° Tips",
                    tip1: "Ctrl+Click to select overlapping widgets",
                    tip2: "Use Google Drive as a bridge between Android and the editor",
                    tip3: "Ctrl+Z to undo, Ctrl+Y to redo",
                    tip4: "Enable snap to grid for perfect alignment",
                    tip5: "Copy widgets between pages with Ctrl+C / Ctrl+V",
                    filterWidgets: "Filter widgets...",
                    importConfig: "Import a configuration",
                    importDesc: "Drag and drop your .xcfg file here",
                    importDescOr: "or click to browse",
                    createConfig: "Create a new configuration",
                    createDesc: "Start with an empty page",
                    createDescAnd: "and add your widgets",
                    newConfig: "New configuration",
                    importButton: "üìÇ Import xcfg file",
                    exportButton: "üíæ Export xcfg file",
                    addPage: "‚ûï Add page",
                    noPageFound: "No page found for this orientation",
                    reloadFile: "Reload file",
                    page: "Page",
                    // Community Library
                    community: "Community Library",
                    signIn: "Sign in",
                    signInWith: "Sign in with",
                    signOut: "Sign out",
                    myConfigs: "My Configs",
                    saveToCloud: "üíæ Save to cloud",
                    browseConfigs: "üìÇ Browse community",
                    uploadConfig: "Share this config",
                    configName: "Configuration name",
                    configDescription: "Description (optional)",
                    category: "Category",
                    categoryCross: "üèîÔ∏è Cross-country",
                    categoryCompete: "üèÅ Competition",
                    categoryCasual: "‚òÄÔ∏è Thermal/Casual",
                    categoryExperimental: "üÜï Experimental",
                    upload: "Share",
                    cancel: "Cancel",
                    close: "Close",
                    popular: "Popular",
                    recent: "Recent",
                    mostDownloaded: "Most Downloaded",
                    upvote: "üëç Upvote",
                    download: "‚¨áÔ∏è Download",
                    downloads: "downloads",
                    by: "by",
                    anonymous: "Anonymous",
                    signInToUpload: "Sign in to save your configs",
                    signInToVote: "Sign in to vote",
                    uploadSuccess: "Configuration shared successfully!",
                    uploadError: "Error sharing configuration",
                    deleteConfig: "Delete",
                    editConfig: "Edit",
                    confirmDelete: "Delete this configuration?",
                }
            }[lang];

            const currentResolution = RESOLUTION_PRESETS[resolutionIndex];

            const loadConfig = (jsonText, source = 'import') => {
                try {
                    const data = JSON.parse(jsonText);
                    setConfigData(data);
                    setSelectedWidget(null);
                    setSelectedPage(0);
                    setHistory([data]);
                    setHistoryIndex(0);
                    // Auto-switch to the orientation that has pages
                    if (data?.layout) {
                        setOrientation(prev => {
                            const hasCurrentOrientation = (data.layout[prev] || []).length > 0;
                            if (!hasCurrentOrientation) {
                                const other = prev === 'landscape' ? 'portrait' : 'landscape';
                                return (data.layout[other] || []).length > 0 ? other : prev;
                            }
                            return prev;
                        });
                    }
                    
                    // Track import (don't track on initial localStorage load)
                    if (source !== 'localStorage') {
                        trackEvent('config_imported', { source });
                    }
                } catch (e) {
                    alert('Erreur de parsing JSON : ' + e.message);
                }
            };

            // Fonction pour ajouter une action dans l'historique
            const pushHistory = (newConfig, actionName = '') => {
                const newHistory = history.slice(0, historyIndex + 1);
                newHistory.push(JSON.parse(JSON.stringify(newConfig))); // Deep clone
                
                // Limiter l'historique √† 50 actions
                if (newHistory.length > 50) {
                    newHistory.shift();
                } else {
                    setHistoryIndex(historyIndex + 1);
                }
                
                setHistory(newHistory);
                
                // Afficher le message d'action
                if (actionName) {
                    showUndoMessage(actionName);
                }
            };

            // Fonction pour afficher un message temporaire
            const showUndoMessage = (message) => {
                setUndoMessage(message);
                setTimeout(() => setUndoMessage(''), 2000);
            };

            // Undo
            const undo = () => {
                if (historyIndex > 0) {
                    const newIndex = historyIndex - 1;
                    setHistoryIndex(newIndex);
                    setConfigData(JSON.parse(JSON.stringify(history[newIndex])));
                    localStorage.setItem('xctrackConfig', JSON.stringify(history[newIndex]));
                    showUndoMessage('Action annul√©e');
                    setSelectedWidget(null);
                }
            };

            // Redo
            const redo = () => {
                if (historyIndex < history.length - 1) {
                    const newIndex = historyIndex + 1;
                    setHistoryIndex(newIndex);
                    setConfigData(JSON.parse(JSON.stringify(history[newIndex])));
                    localStorage.setItem('xctrackConfig', JSON.stringify(history[newIndex]));
                    showUndoMessage('Action r√©tablie');
                    setSelectedWidget(null);
                }
            };

            // Check auth session on mount
            useEffect(() => {
                if (!supabase) return;
                
                // Get current session (Supabase reads hash automatically)
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setUser(session?.user ?? null);
                    // Clean up hash AFTER Supabase has read it
                    if (window.location.hash && window.location.hash.includes('access_token')) {
                        window.history.replaceState(null, '', window.location.pathname);
                    }
                });

                // Listen for auth changes
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setUser(session?.user ?? null);
                });

                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                const savedConfig = localStorage.getItem('xctrackConfig');
                if (savedConfig) {
                    loadConfig(savedConfig, 'localStorage');
                }
                // Restore orientation if set (e.g. by browser.html)
                const savedOrientation = localStorage.getItem('xctrackOrientation');
                if (savedOrientation) {
                    setOrientation(savedOrientation);
                    localStorage.removeItem('xctrackOrientation'); // consume once
                }
            }, []);

            // Load community configs when browse modal opens
            useEffect(() => {
                if (showBrowseModal) {
                    loadCommunityConfigs();
                }
            }, [showBrowseModal, communityFilters, communitySortBy]);

            // Auto-detect tags when save modal opens
            useEffect(() => {
                if (showCommunityModal && configData) {
                    setConfigTags(detectTags(configData, orientation));
                }
            }, [showCommunityModal]);

            // ESC key to close any open modal
            useEffect(() => {
                function handleKeyDown(e) {
                    if (e.key !== 'Escape') return;
                    if (showPreviewModal) { setShowPreviewModal(false); return; }
                    if (showBrowseModal)  { setShowBrowseModal(false);  return; }
                    if (showCommunityModal) { setShowCommunityModal(false); return; }
                }
                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [showPreviewModal, showBrowseModal, showCommunityModal]);

            const allPages = useMemo(() => {
                if (!configData?.layout) return null;
                return configData.layout[orientation] || [];
            }, [configData, orientation]);

            const gridSize = useMemo(() => {
                const sizes = calculateGridSize(currentResolution);
                if (orientation === 'landscape') {
                    return { horizontal: sizes.horizontal, vertical: sizes.vertical };
                } else {
                    return { horizontal: sizes.vertical, vertical: sizes.horizontal };
                }
            }, [currentResolution, orientation]);

            const gridCols = orientation === 'landscape' ? currentResolution.gridCols : currentResolution.gridRows;
            const gridRows = orientation === 'landscape' ? currentResolution.gridRows : currentResolution.gridCols;

            const screenDimensions = useMemo(() => {
                const scale = 0.3;
                if (orientation === 'portrait') {
                    return { 
                        width: currentResolution.height * scale, 
                        height: currentResolution.width * scale 
                    };
                } else {
                    return { 
                        width: currentResolution.width * scale, 
                        height: currentResolution.height * scale 
                    };
                }
            }, [orientation, currentResolution]);

            const handleFileUpload = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const text = event.target.result;
                        loadConfig(text);
                        localStorage.setItem('xctrackConfig', text);
                    };
                    reader.readAsText(file);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(false);
                
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.xcfg') || file.name.endsWith('.json'))) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const text = event.target.result;
                        loadConfig(text);
                        localStorage.setItem('xctrackConfig', text);
                    };
                    reader.readAsText(file);
                } else {
                    alert('Veuillez d√©poser un fichier .xcfg ou .json');
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(false);
            };

            const handleMouseDown = (e, pageIdx, widgetIndex, handleType) => {
                e.stopPropagation();
                setSelectedWidget(widgetIndex);
                setSelectedPage(pageIdx);
                
                const widget = allPages[pageIdx].widgets[widgetIndex];
                const rect = e.currentTarget.closest('.phone-screen').getBoundingClientRect();
                
                setDragState({
                    type: handleType,
                    pageIndex: pageIdx,
                    widgetIndex,
                    startX: e.clientX,
                    startY: e.clientY,
                    originalWidget: { ...widget },
                    screenRect: rect
                });
            };

            const handleMouseMove = (e) => {
                if (!dragState) return;
                
                const deltaX = e.clientX - dragState.startX;
                const deltaY = e.clientY - dragState.startY;
                
                const rect = dragState.screenRect;
                const deltaXNorm = (deltaX / rect.width) * 10000;
                const deltaYNorm = (deltaY / rect.height) * 10000;
                
                const widget = { ...dragState.originalWidget };
                
                if (dragState.type === 'move') {
                    const newX1 = snapToGrid(widget.X1 + deltaXNorm, gridSize.horizontal, snapEnabled);
                    const newY1 = snapToGrid(widget.Y1 + deltaYNorm, gridSize.vertical, snapEnabled);
                    const width = widget.X2 - widget.X1;
                    const height = widget.Y2 - widget.Y1;
                    
                    widget.X1 = Math.max(0, Math.min(10000 - width, newX1));
                    widget.Y1 = Math.max(0, Math.min(10000 - height, newY1));
                    widget.X2 = widget.X1 + width;
                    widget.Y2 = widget.Y1 + height;
                } else {
                    const minSize = Math.max(gridSize.horizontal, gridSize.vertical);
                    
                    if (dragState.type.includes('n')) {
                        widget.Y1 = snapToGrid(
                            Math.max(0, Math.min(widget.Y2 - minSize, widget.Y1 + deltaYNorm)), 
                            gridSize.vertical, 
                            snapEnabled
                        );
                    }
                    if (dragState.type.includes('s')) {
                        widget.Y2 = snapToGrid(
                            Math.max(widget.Y1 + minSize, Math.min(10000, widget.Y2 + deltaYNorm)), 
                            gridSize.vertical, 
                            snapEnabled
                        );
                    }
                    if (dragState.type.includes('w')) {
                        widget.X1 = snapToGrid(
                            Math.max(0, Math.min(widget.X2 - minSize, widget.X1 + deltaXNorm)), 
                            gridSize.horizontal, 
                            snapEnabled
                        );
                    }
                    if (dragState.type.includes('e')) {
                        widget.X2 = snapToGrid(
                            Math.max(widget.X1 + minSize, Math.min(10000, widget.X2 + deltaXNorm)), 
                            gridSize.horizontal, 
                            snapEnabled
                        );
                    }
                }
                
                updateWidget(dragState.pageIndex, dragState.widgetIndex, widget);
            };

            const handleMouseUp = () => {
                if (dragState) {
                    // Sauvegarder dans l'historique √† la fin du drag
                    const actionType = dragState.type === 'move' ? 'D√©placement' : 'Redimensionnement';
                    pushHistory(configData, actionType);
                }
                setDragState(null);
            };

            useEffect(() => {
                if (dragState) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                    return () => {
                        window.removeEventListener('mousemove', handleMouseMove);
                        window.removeEventListener('mouseup', handleMouseUp);
                    };
                }
            }, [dragState, configData]);

            const updateWidget = (pageIdx, widgetIndex, newWidget) => {
                const newConfigData = { ...configData };
                newConfigData.layout[orientation][pageIdx].widgets[widgetIndex] = newWidget;
                setConfigData(newConfigData);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const deleteWidget = (pageIdx, widgetIndex) => {
                const newConfigData = { ...configData };
                const widgetName = getWidgetName(newConfigData.layout[orientation][pageIdx].widgets[widgetIndex].CLASS);
                newConfigData.layout[orientation][pageIdx].widgets.splice(widgetIndex, 1);
                setConfigData(newConfigData);
                setSelectedWidget(null);
                pushHistory(newConfigData, `Suppression ${widgetName}`);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const copyWidget = () => {
                if (selectedWidget === null || selectedPage === null) return;
                const widget = allPages[selectedPage].widgets[selectedWidget];
                setCopiedWidget({ ...widget });
            };

            const pasteWidget = (targetPageIdx = null) => {
                if (!copiedWidget) return;
                
                const pageIdx = targetPageIdx !== null ? targetPageIdx : selectedPage;
                
                const centerX = 5000;
                const centerY = 5000;
                
                const widgetWidth = copiedWidget.X2 - copiedWidget.X1;
                const widgetHeight = copiedWidget.Y2 - copiedWidget.Y1;
                
                const newWidget = {
                    ...copiedWidget,
                    X1: snapToGrid(centerX - widgetWidth / 2, gridSize.horizontal, snapEnabled),
                    Y1: snapToGrid(centerY - widgetHeight / 2, gridSize.vertical, snapEnabled),
                };
                newWidget.X2 = newWidget.X1 + widgetWidth;
                newWidget.Y2 = newWidget.Y1 + widgetHeight;
                
                if (newWidget.X2 > 10000) {
                    const overflow = newWidget.X2 - 10000;
                    newWidget.X1 -= overflow;
                    newWidget.X2 -= overflow;
                }
                if (newWidget.Y2 > 10000) {
                    const overflow = newWidget.Y2 - 10000;
                    newWidget.Y1 -= overflow;
                    newWidget.Y2 -= overflow;
                }
                
                const newConfigData = { ...configData };
                newConfigData.layout[orientation][pageIdx].widgets.push(newWidget);
                setConfigData(newConfigData);
                setSelectedWidget(newConfigData.layout[orientation][pageIdx].widgets.length - 1);
                setSelectedPage(pageIdx);
                pushHistory(newConfigData, `Collage ${getWidgetName(newWidget.CLASS)}`);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const duplicateWidget = () => {
                copyWidget();
                setTimeout(() => pasteWidget(), 10);
            };

            const addWidgetFromLibrary = (widgetKey) => {
                const template = WIDGET_LIBRARY[widgetKey];
                if (!template || selectedPage === null) return;
                
                // Taille par d√©faut : 8√ó8 cellules de grille
                const widgetWidth = gridSize.horizontal * 8;
                const widgetHeight = gridSize.vertical * 8;
                
                const centerX = 5000;
                const centerY = 5000;
                
                const newWidget = {
                    ...template,
                    X1: snapToGrid(centerX - widgetWidth / 2, gridSize.horizontal, true),
                    Y1: snapToGrid(centerY - widgetHeight / 2, gridSize.vertical, true),
                };
                newWidget.X2 = newWidget.X1 + widgetWidth;
                newWidget.Y2 = newWidget.Y1 + widgetHeight;
                
                const newConfigData = { ...configData };
                newConfigData.layout[orientation][selectedPage].widgets.push(newWidget);
                setConfigData(newConfigData);
                setSelectedWidget(newConfigData.layout[orientation][selectedPage].widgets.length - 1);
                pushHistory(newConfigData, `Ajout ${widgetKey}`);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const addNewPage = (pageType) => {
                const newConfigData = { ...configData };
                const newPage = {
                    CLASS: pageType.CLASS,
                    navigations: pageType.navigations,
                    widgets: []
                };
                newConfigData.layout[orientation].push(newPage);
                setConfigData(newConfigData);
                setSelectedPage(newConfigData.layout[orientation].length - 1);
                pushHistory(newConfigData, `Nouvelle page ${pageType.name}`);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const deletePage = (pageIdx) => {
                if (allPages.length <= 1) {
                    alert("Impossible de supprimer la derni√®re page !");
                    return;
                }
                
                const newConfigData = { ...configData };
                const pageName = getWidgetName(newConfigData.layout[orientation][pageIdx].CLASS);
                newConfigData.layout[orientation].splice(pageIdx, 1);
                setConfigData(newConfigData);
                setSelectedWidget(null);
                setSelectedPage(Math.max(0, pageIdx - 1));
                pushHistory(newConfigData, `Suppression page ${pageName}`);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const movePageUp = (pageIdx) => {
                if (pageIdx === 0) return;
                
                const newConfigData = { ...configData };
                const pages = newConfigData.layout[orientation];
                [pages[pageIdx - 1], pages[pageIdx]] = [pages[pageIdx], pages[pageIdx - 1]];
                
                setConfigData(newConfigData);
                setSelectedPage(pageIdx - 1);
                pushHistory(newConfigData, 'R√©organisation pages');
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const movePageDown = (pageIdx) => {
                if (pageIdx === allPages.length - 1) return;
                
                const newConfigData = { ...configData };
                const pages = newConfigData.layout[orientation];
                [pages[pageIdx], pages[pageIdx + 1]] = [pages[pageIdx + 1], pages[pageIdx]];
                
                setConfigData(newConfigData);
                setSelectedPage(pageIdx + 1);
                pushHistory(newConfigData, 'R√©organisation pages');
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            // Fonction pour obtenir le contenu preview d'un widget
            const getWidgetPreview = (widget, width, height) => {
                const widgetKey = widget.CLASS.split('.').pop(); // Extraire WSpeed, WAltitude, etc.
                
                // G√©rer les variantes de boutons selon leur type
                let previewKey = widgetKey;
                if (widgetKey === 'WButtonZoom') {
                    previewKey = widget.type === 'ACTION_ZOOM_IN' ? 'WButtonZoomIn' : 'WButtonZoomOut';
                } else if (widgetKey === 'WButtonNavig') {
                    previewKey = widget.type === 'ACTION_NEXT_WAYPOINT' ? 'WButtonNavigNext' : 'WButtonNavigPrev';
                }
                
                const preview = WIDGET_PREVIEWS[previewKey];
                
                if (!preview) return null;
                
                // Taille de police calibr√©e sur ~57px pour widgets standards
                const fontSize = Math.max(12, height * 0.57 * (preview.baseSize / 2.5));
                const unitSize = fontSize * 0.4;
                
                return { ...preview, fontSize, unitSize };
            };

            // Fonction pour trouver les widgets √† une position donn√©e (pour Ctrl+Click)
            const getWidgetsAtPosition = (pageIdx, clientX, clientY, screenRect) => {
                if (!allPages[pageIdx]) return [];
                
                const relX = ((clientX - screenRect.left) / screenRect.width) * 10000;
                const relY = ((clientY - screenRect.top) / screenRect.height) * 10000;
                
                const overlapping = [];
                allPages[pageIdx].widgets.forEach((widget, idx) => {
                    if (relX >= widget.X1 && relX <= widget.X2 && 
                        relY >= widget.Y1 && relY <= widget.Y2) {
                        overlapping.push(idx);
                    }
                });
                
                return overlapping;
            };

            // Gestion des raccourcis clavier
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // Ignorer si on est dans un input/textarea (sauf pour CSS editor toggle)
                    const isInputField = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA';
                    
                    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                    const cmdOrCtrl = isMac ? e.metaKey : e.ctrlKey;
                    
                    // CSS Editor toggle (works everywhere)
                    if (cmdOrCtrl && e.shiftKey && e.key === 'C') {
                        e.preventDefault();
                        setShowCSSEditor(prev => !prev);
                        return;
                    }
                    
                    // Skip other shortcuts if in input field
                    if (isInputField) return;
                    
                    if (cmdOrCtrl && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        undo();
                    } else if (cmdOrCtrl && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                        e.preventDefault();
                        redo();
                    } else if (cmdOrCtrl && e.key === 'c') {
                        e.preventDefault();
                        copyWidget();
                    } else if (cmdOrCtrl && e.key === 'v') {
                        e.preventDefault();
                        pasteWidget();
                    } else if (cmdOrCtrl && e.key === 'd') {
                        e.preventDefault();
                        duplicateWidget();
                    } else if (e.key === 'Delete' || e.key === 'Backspace') {
                        if (selectedWidget !== null && selectedPage !== null) {
                            e.preventDefault();
                            deleteWidget(selectedPage, selectedWidget);
                        }
                    }
                };
                
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selectedWidget, selectedPage, copiedWidget, configData, orientation, historyIndex]);

            const exportConfig = async () => {
                const dataStr = JSON.stringify(configData, null, 2);
                
                // V√©rifier si l'API File System Access est disponible
                if ('showSaveFilePicker' in window) {
                    try {
                        const handle = await window.showSaveFilePicker({
                            suggestedName: 'xctrack-layout-edited.xcfg',
                            types: [{
                                description: 'XCTrack Configuration',
                                accept: { 'application/json': ['.xcfg'] }
                            }]
                        });
                        const writable = await handle.createWritable();
                        await writable.write(dataStr);
                        await writable.close();
                    } catch (err) {
                        // User cancelled or error - silently ignore
                        if (err.name !== 'AbortError') {
                            console.error('Save error:', err);
                        }
                    }
                } else {
                    // Fallback pour les navigateurs qui ne supportent pas l'API
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'xctrack-layout-edited.xcfg';
                    link.click();
                    URL.revokeObjectURL(url);
                }
                
                // Track export
                trackEvent('config_exported');
            };

            // CSS Live Editor functions
            const extractCurrentCSS = () => {
                // Get all style tags and find the main one (not #live-css)
                const styleTags = Array.from(document.querySelectorAll('style'));
                const mainStyle = styleTags.find(tag => tag.id !== 'live-css');
                return mainStyle ? mainStyle.textContent : '';
            };

            const applyCSSLive = (css) => {
                let liveStyleTag = document.getElementById('live-css');
                if (!liveStyleTag) {
                    liveStyleTag = document.createElement('style');
                    liveStyleTag.id = 'live-css';
                    document.head.appendChild(liveStyleTag);
                }
                liveStyleTag.textContent = css;
            };

            const exportCSSToClipboard = () => {
                navigator.clipboard.writeText(liveCSS).then(() => {
                    alert('‚úÖ CSS copied to clipboard!');
                }).catch(err => {
                    console.error('Copy failed:', err);
                    alert('‚ùå Failed to copy CSS');
                });
            };

            const saveCSS = () => {
                localStorage.setItem('xctrackEditorCustomCSS', liveCSS);
                alert('üíæ CSS saved to localStorage');
            };

            const loadSavedCSS = () => {
                const saved = localStorage.getItem('xctrackEditorCustomCSS');
                if (saved) {
                    setLiveCSS(saved);
                    applyCSSLive(saved);
                    alert('üìÇ CSS loaded from localStorage');
                } else {
                    alert('‚ÑπÔ∏è No saved CSS found');
                }
            };

            const resetCSS = () => {
                const original = extractCurrentCSS();
                setLiveCSS(original);
                const liveStyleTag = document.getElementById('live-css');
                if (liveStyleTag) {
                    liveStyleTag.remove();
                }
                localStorage.removeItem('xctrackEditorCustomCSS');
                alert('üîÑ CSS reset to original');
            };

            // Initialize CSS editor content when opened
            useEffect(() => {
                if (showCSSEditor && !liveCSS) {
                    const css = extractCurrentCSS();
                    setLiveCSS(css);
                }
            }, [showCSSEditor]);

            // Apply live CSS changes
            useEffect(() => {
                if (showCSSEditor && liveCSS) {
                    applyCSSLive(liveCSS);
                }
            }, [liveCSS, showCSSEditor]);

            const createNewConfig = () => {
                const newConfig = {
                    "CLASS": "org.xcontest.XCTrack.model.preferences.Preferences",
                    "layout": {
                        "landscape": [
                            {
                                "CLASS": "org.xcontest.XCTrack.widget.wp.WPEmpty",
                                "navigations": "all",
                                "widgets": []
                            }
                        ],
                        "portrait": [
                            {
                                "CLASS": "org.xcontest.XCTrack.widget.wp.WPEmpty",
                                "navigations": "all",
                                "widgets": []
                            }
                        ]
                    }
                };
                setConfigData(newConfig);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfig));
                pushHistory(newConfig, 'Nouvelle configuration');
                trackEvent('config_created', { source: 'new' });
            };

            // Community functions - vanilla JS style that works!
            function signInWithGoogle() {
                if (!supabase) {
                    alert('Supabase not loaded');
                    return;
                }
                // Strip hash completely to avoid ##access_token double hash bug
                const cleanUrl = window.location.origin + window.location.pathname;
                supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: cleanUrl
                    }
                }).then(function(result) {
                    if (result.error) {
                        alert('Error: ' + result.error.message);
                    } else if (result.data && result.data.url) {
                        window.location.href = result.data.url;
                    }
                }).catch(function(e) {
                    alert('Error: ' + e.message);
                });
            }

            function signOut() {
                if (!supabase) return;
                supabase.auth.signOut();
            }

            // Generate composite screenshot of all pages
            async function generateScreenshot() {
                if (!screenRef.current || !window.html2canvas) return null;
                
                try {
                    const pages = screenRef.current.querySelectorAll('.phone-screen');
                    if (pages.length === 0) return null;
                    
                    const n = pages.length;
                    const scale = 0.5;
                    const padding = 12;

                    // Grid columns: ‚â§4 ‚Üí 2 cols, 5-8 ‚Üí 3 cols, 9+ ‚Üí 4 cols
                    const cols = n <= 4 ? Math.min(n, 2) : n <= 8 ? 3 : 4;
                    const rows = Math.ceil(n / cols);

                    // Capture each page
                    const pageCanvases = [];
                    for (let i = 0; i < pages.length; i++) {
                        const pc = await html2canvas(pages[i], {
                            scale: scale,
                            backgroundColor: '#1a1a2e',
                            logging: false,
                            useCORS: true
                        });
                        pageCanvases.push(pc);
                    }

                    const pw = pageCanvases[0].width;
                    const ph = pageCanvases[0].height;

                    const finalCanvas = document.createElement('canvas');
                    const ctx = finalCanvas.getContext('2d');
                    finalCanvas.width  = cols * pw + (cols + 1) * padding;
                    finalCanvas.height = rows * ph + (rows + 1) * padding;

                    // Dark background
                    ctx.fillStyle = '#0a1628';
                    ctx.fillRect(0, 0, finalCanvas.width, finalCanvas.height);

                    pageCanvases.forEach((pc, i) => {
                        const col = i % cols;
                        const row = Math.floor(i / cols);
                        const x = padding + col * (pw + padding);
                        const y = padding + row * (ph + padding);
                        ctx.drawImage(pc, x, y);
                    });

                    return finalCanvas.toDataURL('image/jpeg', 0.7);
                } catch (e) {
                    console.error('Screenshot error:', e);
                    return null;
                }
            }

            async function saveToCloud() {
                if (!supabase || !user || !configData) return;
                
                if (configTags.length === 0) {
                    alert(lang === 'fr' ? 'S√©lectionnez au moins un tag' : 'Select at least one tag');
                    return;
                }
                
                // Generate auto name
                const autoName = await generateConfigName(user.email);
                
                // Generate screenshot
                const screenshot = await generateScreenshot();
                
                const result = await supabase.from('configs').insert({
                    user_id: user.id,
                    user_email: getUsername(user.email),
                    name: autoName,
                    description: null,
                    config_json: configData,
                    category: configTags[0],
                    tags: configTags,
                    screenshot: screenshot
                });

                if (result.error) {
                    alert(t.uploadError + ': ' + result.error.message);
                } else {
                    setShowCommunityModal(false);
                    setConfigTags([]);
                    trackEvent('config_uploaded', { tags: configTags });
                }
            }

            async function loadCommunityConfigs() {
                if (!supabase) return;
                
                let query = supabase.from('configs').select('*');
                
                // Filter by tags if any selected
                if (communityFilters.length > 0) {
                    query = query.contains('tags', communityFilters);
                }
                
                if (communitySortBy === 'upvotes') {
                    query = query.order('upvotes', { ascending: false });
                } else if (communitySortBy === 'downloads') {
                    query = query.order('downloads', { ascending: false });
                } else {
                    query = query.order('created_at', { ascending: false });
                }
                
                const result = await query.limit(20);
                if (!result.error && result.data) {
                    setCommunityConfigs(result.data);
                }
            }

            function openPreview(config) {
                setPreviewConfig(config);
                setShowPreviewModal(true);
            }

            const isAdmin = user?.email === 'thrombose@gmail.com';

            // Auto-detect tags from config pages - current orientation only
            function detectTags(config, currentOrientation) {
                if (!config?.layout) return ['casual'];
                const tags = new Set();
                const pages = config.layout[currentOrientation] || [];
                pages.forEach(page => {
                    const cls = (page.CLASS || '').toLowerCase();
                    if (cls.includes('xcassistant')) tags.add('cross');
                    if (cls.includes('competition')) tags.add('compete');
                });
                if (tags.size === 0) tags.add('casual');
                return Array.from(tags);
            }

            // Get username from email: thrombose@gmail.com ‚Üí thrombose
            function getUsername(email) {
                if (!email) return 'anonymous';
                return email.split('@')[0];
            }

            // Generate config name: thrombose_01
            async function generateConfigName(email) {
                const base = getUsername(email);
                const result = await supabase
                    .from('configs')
                    .select('id', { count: 'exact' })
                    .eq('user_id', user.id);
                const count = (result.count || 0) + 1;
                return base + '_' + String(count).padStart(2, '0');
            }

            function canEdit(config) {
                return user && (user.id === config.user_id || isAdmin);
            }

            async function deleteConfig(config) {
                if (!supabase || !canEdit(config)) return;
                const confirmMsg = lang === 'fr' 
                    ? 'Supprimer cette configuration ?' 
                    : 'Delete this configuration?';
                if (!window.confirm(confirmMsg)) return;
                
                const result = await supabase.from('configs').delete().eq('id', config.id);
                if (result.error) {
                    alert('Error: ' + result.error.message);
                } else {
                    setShowPreviewModal(false);
                    loadCommunityConfigs();
                }
            }

            async function downloadConfig(config) {
                if (!supabase) return;
                
                await supabase.from('configs').update({ 
                    downloads: (config.downloads || 0) + 1 
                }).eq('id', config.id);
                
                setConfigData(config.config_json);
                localStorage.setItem('xctrackConfig', JSON.stringify(config.config_json));
                setShowCommunityModal(false);
                
                trackEvent('config_downloaded', { 
                    config_id: config.id,
                    tags: config.tags 
                });
            }

            if (!configData) {
                return (
                    <div className="container">
                        <div className="header">
                            {/* Language switch */}
                            <button 
                                className="lang-switch"
                                onClick={toggleLanguage}
                                title={lang === 'fr' ? 'Switch to English' : 'Passer en fran√ßais'}
                            >
                                {lang === 'fr' ? 'üá¨üáß EN' : 'üá´üá∑ FR'}
                            </button>

                            {/* GitHub link */}
                            <a 
                                href="https://github.com/fidozbox-dev/XCTrackLayoutEditor" 
                                target="_blank" 
                                rel="noopener noreferrer"
                                className="github-link"
                                title="View on GitHub"
                            >
                                <svg className="github-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                </svg>
                                GitHub
                            </a>
                            <h1>{t.title}</h1>
                            <p>{t.subtitle}</p>
                        </div>
                        <div className="viewer" style={{ display: 'flex', gap: '30px', justifyContent: 'center', padding: '40px 20px' }}>
                            {/* Option 1: Importer */}
                            <div 
                                className={`drop-zone ${isDragOver ? 'drag-over' : ''}`}
                                onDrop={handleDrop}
                                onDragOver={handleDragOver}
                                onDragLeave={handleDragLeave}
                                onClick={() => fileInputRef.current?.click()}
                                style={{ flex: '1', maxWidth: '400px' }}
                            >
                                <h2>üìÇ {t.importConfig}</h2>
                                <p>{t.importDesc}<br/>{t.importDescOr}</p>
                                <button>{t.selectFile}</button>
                                <input 
                                    ref={fileInputRef}
                                    type="file" 
                                    accept=".xcfg,.json"
                                    onChange={handleFileUpload}
                                    style={{ display: 'none' }}
                                />
                            </div>

                            {/* Option 2: Cr√©er nouvelle config */}
                            <div 
                                className="drop-zone"
                                style={{ 
                                    flex: '1', 
                                    maxWidth: '400px',
                                    cursor: 'pointer',
                                    background: 'linear-gradient(135deg, rgba(14,165,233,0.15) 0%, rgba(99,102,241,0.15) 100%)',
                                    borderColor: 'rgba(14,165,233,0.4)'
                                }}
                                onClick={createNewConfig}
                            >
                                <h2>‚ú® {t.createConfig}</h2>
                                <p>{t.createDesc}<br/>{t.createDescAnd}</p>
                                <button style={{ 
                                    background: 'var(--sky)',
                                    color: 'white',
                                    border: 'none',
                                    fontWeight: 'bold'
                                }}>
                                    {t.newConfig}
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            console.log('Config loaded:', configData);
            console.log('Orientation:', orientation);
            console.log('All pages:', allPages);

            if (!allPages || allPages.length === 0) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>XCTrack Layout Editor</h1>
                        </div>
                        <div style={{ 
                            background: '#fee2e2', 
                            border: '2px solid #ef4444', 
                            borderRadius: '8px', 
                            padding: '20px', 
                            color: '#991b1b', 
                            textAlign: 'center' 
                        }}>
                            <h2>{t.noPageFound}</h2>
                            <button onClick={() => setConfigData(null)} style={{ marginTop: '20px' }}>
                                {t.reloadFile}
                            </button>
                        </div>
                    </div>
                );
            }

            const selectedWidgetData = (selectedWidget !== null && selectedPage !== null) 
                ? allPages[selectedPage]?.widgets[selectedWidget] 
                : null;

            return (
                <div className="container">
                    <div className="header">
                        <div className="header-buttons">
                            {/* Language switch */}
                            <button 
                                className="lang-switch"
                                onClick={toggleLanguage}
                                title={lang === 'fr' ? 'Switch to English' : 'Passer en fran√ßais'}
                            >
                                {lang === 'fr' ? 'üá¨üáß EN' : 'üá´üá∑ FR'}
                            </button>
                        </div>
                        
                        {/* GitHub link */}
                        <a 
                            href="https://github.com/fidozbox-dev/XCTrackLayoutEditor" 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="github-link"
                            title="View on GitHub"
                        >
                            <svg className="github-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                            </svg>
                            GitHub
                        </a>
                        <h1>{t.title}</h1>
                        <p>{t.subtitle}</p>
                        <div style={{ fontSize: '0.75rem', opacity: 0.6, marginTop: '5px' }}>
                            v2025.02.20-hybrid-theme
                        </div>
                    </div>

                    <div className="main-layout">
                        <div className="sidebar">
                            <div className="controls">
                                <h3>‚öôÔ∏è {t.config}</h3>

                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button 
                                        onClick={undo}
                                        disabled={historyIndex <= 0}
                                        style={{ 
                                            flex: 1,
                                            opacity: historyIndex <= 0 ? 0.5 : 1,
                                            cursor: historyIndex <= 0 ? 'not-allowed' : 'pointer'
                                        }}
                                        title="Annuler (Ctrl+Z)"
                                    >
                                        ‚Ü∂ Undo
                                    </button>
                                    <button 
                                        onClick={redo}
                                        disabled={historyIndex >= history.length - 1}
                                        style={{ 
                                            flex: 1,
                                            opacity: historyIndex >= history.length - 1 ? 0.5 : 1,
                                            cursor: historyIndex >= history.length - 1 ? 'not-allowed' : 'pointer'
                                        }}
                                        title="R√©tablir (Ctrl+Y)"
                                    >
                                        ‚Ü∑ Redo
                                    </button>
                                </div>
                                
                                <div className="control-group">
                                    <label>{t.resolution}</label>
                                    <select 
                                        value={resolutionIndex} 
                                        onChange={(e) => setResolutionIndex(parseInt(e.target.value))}
                                    >
                                        {RESOLUTION_PRESETS.map((preset, idx) => (
                                            <option key={idx} value={idx}>
                                                {preset.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                <div className="control-group">
                                    <label>{t.orientation}</label>
                                    <select 
                                        value={orientation} 
                                        onChange={(e) => {
                                            setOrientation(e.target.value);
                                            setSelectedWidget(null);
                                            setSelectedPage(0);
                                        }}
                                    >
                                        <option value="landscape">{t.landscape}</option>
                                        <option value="portrait">{t.portrait}</option>
                                    </select>
                                </div>

                                <div className="control-group checkbox">
                                    <input 
                                        type="checkbox" 
                                        id="showGrid"
                                        checked={showGrid}
                                        onChange={(e) => setShowGrid(e.target.checked)}
                                    />
                                    <label htmlFor="showGrid">
                                        {t.showGrid} ({gridCols}√ó{gridRows})
                                    </label>
                                </div>

                                <div className="control-group checkbox">
                                    <input 
                                        type="checkbox" 
                                        id="snapEnabled"
                                        checked={snapEnabled}
                                        onChange={(e) => setSnapEnabled(e.target.checked)}
                                    />
                                    <label htmlFor="snapEnabled">
                                        {t.snapToGrid}
                                    </label>
                                </div>

                                <button 
                                    onClick={() => fileInputRef.current?.click()} 
                                    className="full-width import-btn"
                                >
                                    {t.importButton}
                                </button>
                                <input 
                                    ref={fileInputRef}
                                    type="file" 
                                    accept=".xcfg,.json"
                                    onChange={handleFileUpload}
                                    style={{ display: 'none' }}
                                />

                                <button onClick={exportConfig} className="full-width export-btn">
                                    {t.exportButton}
                                </button>

                                {/* Community Section */}
                                <div style={{ marginTop: '15px', paddingTop: '15px', borderTop: '1px solid var(--border)' }}>
                                    <h3 style={{ margin: '0 0 10px 0', fontSize: '0.85rem', fontFamily: "'Bebas Neue', sans-serif", letterSpacing: '2px', color: 'var(--text-dim)' }}>‚òÅÔ∏è {t.community}</h3>
                                    {user ? (
                                        <>
                                            <div style={{ fontSize: '0.85rem', marginBottom: '10px', color: 'var(--text-dim)' }}>
                                                üë§ {user.email}
                                            </div>
                                            <button 
                                                onClick={() => setShowCommunityModal(true)} 
                                                className="full-width"
                                                style={{ marginBottom: '8px', background: 'rgba(14,165,233,0.12)', border: '1px solid rgba(14,165,233,0.35)', color: 'var(--sky)' }}
                                            >
                                                {t.saveToCloud}
                                            </button>
                                            <button 
                                                onClick={() => setShowBrowseModal(true)}
                                                className="full-width"
                                                style={{ marginBottom: '8px', background: 'rgba(16,185,129,0.12)', border: '1px solid rgba(16,185,129,0.35)', color: '#34d399' }}
                                            >
                                                {lang === 'fr' ? 'üìÇ Charger depuis le cloud' : 'üìÇ Load from cloud'}
                                            </button>
                                            <button 
                                                onClick={() => window.open('./browser.html', '_blank')}
                                                className="full-width"
                                                style={{ marginBottom: '8px', background: 'rgba(99,102,241,0.12)', border: '1px solid rgba(99,102,241,0.35)', color: '#818cf8' }}
                                            >
                                                {lang === 'fr' ? 'üåê Library Browser' : 'üåê Library Browser'}
                                            </button>
                                            <button 
                                                onClick={signOut}
                                                className="full-width"
                                                style={{ background: 'rgba(239,68,68,0.12)', border: '1px solid rgba(239,68,68,0.35)', color: '#f87171', fontSize: '0.9rem' }}
                                            >
                                                {t.signOut}
                                            </button>
                                        </>
                                    ) : (
                                        <button 
                                            onClick={signInWithGoogle}
                                            className="full-width"
                                            style={{ background: 'rgba(66,133,244,0.15)', border: '1px solid rgba(66,133,244,0.4)', color: '#60a5fa' }}
                                        >
                                            üîê {t.signInWith} Google
                                        </button>
                                    )}
                                </div>
                            </div>

                            {/* Biblioth√®que de widgets */}
                            <div className="widget-library">
                                <h3 style={{ cursor: 'pointer' }} onClick={() => setShowWidgetLibrary(!showWidgetLibrary)}>
                                    üìö {t.widgetLibrary} {showWidgetLibrary ? '‚ñº' : '‚ñ∂'}
                                </h3>
                                {showWidgetLibrary && (
                                    <>
                                        <input
                                            type="text"
                                            placeholder={t.filterWidgets}
                                            value={widgetFilter}
                                            onChange={(e) => setWidgetFilter(e.target.value)}
                                            style={{
                                                width: '100%',
                                                padding: '8px',
                                                marginBottom: '10px',
                                                border: '1px solid #d1d5db',
                                                borderRadius: '6px',
                                                fontSize: '0.9rem'
                                            }}
                                        />
                                        <div 
                                            className="widget-library-grid"
                                            style={{
                                                border: '1px solid rgba(14,165,233,0.12)',
                                                borderRadius: '6px',
                                                padding: '10px'
                                            }}
                                        >
                                        {/* Data/Metrics */}
                                        {(() => {
                                            const widgets = ['WAltitude', 'WAltitudeAboveGround', 'WAltitudeMaximum', 'WSpeed', 'WXCSpeed', 'WVerticalSpeed', 'WGlide', 'WWindSpeed', 'WTime', 'WAirTime'];
                                            const filtered = widgets.filter(w => {
                                                const name = w.startsWith('W') ? w.substring(1).toLowerCase() : w.toLowerCase();
                                                return name.includes(widgetFilter.toLowerCase());
                                            });
                                            if (filtered.length === 0) return null;
                                            return (
                                                <>
                                                    <div style={{ 
                                                        fontWeight: 'bold', 
                                                        color: '#1e293b', 
                                                        marginTop: '10px',
                                                        marginBottom: '5px',
                                                        fontSize: '0.9rem',
                                                        borderBottom: '1px solid rgba(14,165,233,0.12)',
                                                        paddingBottom: '3px'
                                                    }}>
                                                        üìä Data / Metrics
                                                    </div>
                                                    {filtered.map(widgetKey => {
                                                        const displayName = widgetKey.startsWith('W') ? widgetKey.substring(1) : widgetKey;
                                                        return (
                                                            <div
                                                                key={widgetKey}
                                                                className="widget-library-item"
                                                                onClick={() => addWidgetFromLibrary(widgetKey)}
                                                                title={`Cliquer pour ajouter ${displayName}`}
                                                            >
                                                                + {displayName}
                                                            </div>
                                                        );
                                                    })}
                                                </>
                                            );
                                        })()}

                                        {/* Navigation */}
                                        {(() => {
                                            const widgets = ['WNextTurnpointDistance', 'WNextTurnpointAlt', 'WNextTurnpointGlideTo', 'WNextTurnpointTimeOfArrival'];
                                            const filtered = widgets.filter(w => {
                                                const name = w.startsWith('W') ? w.substring(1).toLowerCase() : w.toLowerCase();
                                                return name.includes(widgetFilter.toLowerCase());
                                            });
                                            if (filtered.length === 0) return null;
                                            return (
                                                <>
                                                    <div style={{ 
                                                        fontWeight: 'bold', 
                                                        color: '#1e293b', 
                                                        marginTop: '15px',
                                                        marginBottom: '5px',
                                                        fontSize: '0.9rem',
                                                        borderBottom: '1px solid rgba(14,165,233,0.12)',
                                                        paddingBottom: '3px'
                                                    }}>
                                                        üéØ Navigation
                                                    </div>
                                                    {filtered.map(widgetKey => {
                                                        const displayName = widgetKey.startsWith('W') ? widgetKey.substring(1) : widgetKey;
                                                        return (
                                                            <div
                                                                key={widgetKey}
                                                                className="widget-library-item"
                                                                onClick={() => addWidgetFromLibrary(widgetKey)}
                                                                title={`Cliquer pour ajouter ${displayName}`}
                                                            >
                                                                + {displayName}
                                                            </div>
                                                        );
                                                    })}
                                                </>
                                            );
                                        })()}

                                        {/* Competition */}
                                        {(() => {
                                            const widgets = ['WCompDistanceToGoal', 'WCompGlideToGoal', 'WCompAltitudeOverGoal', 'WCompTimeToStart', 'WCompTimeAtStart'];
                                            const filtered = widgets.filter(w => {
                                                const name = w.startsWith('W') ? w.substring(1).toLowerCase() : w.toLowerCase();
                                                return name.includes(widgetFilter.toLowerCase());
                                            });
                                            if (filtered.length === 0) return null;
                                            return (
                                                <>
                                                    <div style={{ 
                                                        fontWeight: 'bold', 
                                                        color: '#1e293b', 
                                                        marginTop: '15px',
                                                        marginBottom: '5px',
                                                        fontSize: '0.9rem',
                                                        borderBottom: '1px solid rgba(14,165,233,0.12)',
                                                        paddingBottom: '3px'
                                                    }}>
                                                        üèÅ Competition
                                                    </div>
                                                    {filtered.map(widgetKey => {
                                                        const displayName = widgetKey.startsWith('W') ? widgetKey.substring(1) : widgetKey;
                                                        return (
                                                            <div
                                                                key={widgetKey}
                                                                className="widget-library-item"
                                                                onClick={() => addWidgetFromLibrary(widgetKey)}
                                                                title={`Cliquer pour ajouter ${displayName}`}
                                                            >
                                                                + {displayName}
                                                            </div>
                                                        );
                                                    })}
                                                </>
                                            );
                                        })()}

                                        {/* Maps/Visual */}
                                        {(() => {
                                            const widgets = ['WXCAssistant', 'WThermalAssistant', 'WCompMap', 'WCompass', 'WSideView', 'WAltitudeDataGraph'];
                                            const filtered = widgets.filter(w => {
                                                const name = w.startsWith('W') ? w.substring(1).toLowerCase() : w.toLowerCase();
                                                return name.includes(widgetFilter.toLowerCase());
                                            });
                                            if (filtered.length === 0) return null;
                                            return (
                                                <>
                                                    <div style={{ 
                                                        fontWeight: 'bold', 
                                                        color: '#1e293b', 
                                                        marginTop: '15px',
                                                        marginBottom: '5px',
                                                        fontSize: '0.9rem',
                                                        borderBottom: '1px solid rgba(14,165,233,0.12)',
                                                        paddingBottom: '3px'
                                                    }}>
                                                        üó∫Ô∏è Maps / Visual
                                                    </div>
                                                    {filtered.map(widgetKey => {
                                                        const displayName = widgetKey.startsWith('W') ? widgetKey.substring(1) : widgetKey;
                                                        return (
                                                            <div
                                                                key={widgetKey}
                                                                className="widget-library-item"
                                                                onClick={() => addWidgetFromLibrary(widgetKey)}
                                                                title={`Cliquer pour ajouter ${displayName}`}
                                                            >
                                                                + {displayName}
                                                            </div>
                                                        );
                                                    })}
                                                </>
                                            );
                                        })()}

                                        {/* Graphs/Stats */}
                                        {(() => {
                                            const widgets = ['WVerticalGraph', 'WThermalAltGain', 'WOptiResult'];
                                            const filtered = widgets.filter(w => {
                                                const name = w.startsWith('W') ? w.substring(1).toLowerCase() : w.toLowerCase();
                                                return name.includes(widgetFilter.toLowerCase());
                                            });
                                            if (filtered.length === 0) return null;
                                            return (
                                                <>
                                                    <div style={{ 
                                                        fontWeight: 'bold', 
                                                        color: '#1e293b', 
                                                        marginTop: '15px',
                                                        marginBottom: '5px',
                                                        fontSize: '0.9rem',
                                                        borderBottom: '1px solid rgba(14,165,233,0.12)',
                                                        paddingBottom: '3px'
                                                    }}>
                                                        üìà Graphs / Stats
                                                    </div>
                                                    {filtered.map(widgetKey => {
                                                        const displayName = widgetKey.startsWith('W') ? widgetKey.substring(1) : widgetKey;
                                                        return (
                                                            <div
                                                                key={widgetKey}
                                                                className="widget-library-item"
                                                                onClick={() => addWidgetFromLibrary(widgetKey)}
                                                                title={`Cliquer pour ajouter ${displayName}`}
                                                            >
                                                                + {displayName}
                                                            </div>
                                                        );
                                                    })}
                                                </>
                                            );
                                        })()}

                                        {/* UI/Controls */}
                                        {(() => {
                                            const widgets = ['WStatusLine', 'WFreeText', 'WButtonZoomOut', 'WButtonZoomIn', 'WButtonNavigPrev', 'WButtonNavigNext', 'WAirspaceProximity'];
                                            const filtered = widgets.filter(w => {
                                                const name = w.startsWith('W') ? w.substring(1).toLowerCase() : w.toLowerCase();
                                                return name.includes(widgetFilter.toLowerCase());
                                            });
                                            if (filtered.length === 0) return null;
                                            return (
                                                <>
                                                    <div style={{ 
                                                        fontWeight: 'bold', 
                                                        color: '#1e293b', 
                                                        marginTop: '15px',
                                                        marginBottom: '5px',
                                                        fontSize: '0.9rem',
                                                        borderBottom: '1px solid rgba(14,165,233,0.12)',
                                                        paddingBottom: '3px'
                                                    }}>
                                                        ‚öôÔ∏è UI / Controls
                                                    </div>
                                                    {filtered.map(widgetKey => {
                                                        const displayName = widgetKey.startsWith('W') ? widgetKey.substring(1) : widgetKey;
                                                        return (
                                                            <div
                                                                key={widgetKey}
                                                                className="widget-library-item"
                                                                onClick={() => addWidgetFromLibrary(widgetKey)}
                                                                title={`Cliquer pour ajouter ${displayName}`}
                                                            >
                                                                + {displayName}
                                                            </div>
                                                        );
                                                    })}
                                                </>
                                            );
                                        })()}
                                        </div>
                                    </>
                                )}
                            </div>

                            {/* Gestion des pages */}
                            <div className="page-management">
                                <h3>üìÑ {t.pages}</h3>
                                <div className="page-type-buttons">
                                    {PAGE_TYPES.map((pageType, idx) => (
                                        <button
                                            key={idx}
                                            className="page-type-btn"
                                            onClick={() => addNewPage(pageType)}
                                        >
                                            ‚ûï {pageType.name}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Info widget s√©lectionn√© */}
                            <div className="widget-info-panel">
                                <h3>üì¶ {t.selectedWidget}</h3>
                                {selectedWidgetData ? (
                                    <>
                                        <h4>{getWidgetName(selectedWidgetData.CLASS)}</h4>
                                        <div className="coords">
                                            <div>X1: {selectedWidgetData.X1}</div>
                                            <div>Y1: {selectedWidgetData.Y1}</div>
                                            <div>X2: {selectedWidgetData.X2}</div>
                                            <div>Y2: {selectedWidgetData.Y2}</div>
                                        </div>
                                        <div className="action-buttons">
                                            <button onClick={copyWidget}>
                                                üìã Copier (Ctrl+C)
                                            </button>
                                            <button onClick={duplicateWidget}>
                                                üìë Dupliquer (Ctrl+D)
                                            </button>
                                            <button 
                                                className="delete-btn"
                                                onClick={() => deleteWidget(selectedPage, selectedWidget)}
                                            >
                                                üóëÔ∏è Supprimer (Del)
                                            </button>
                                            <button onClick={() => setSelectedWidget(null)}
                                                style={{ background: 'transparent', border: '1px solid var(--border)', color: 'var(--text-dim)', whiteSpace: 'normal', textAlign: 'center' }}
                                            >
                                                ‚úï {lang === 'fr' ? 'D√©s√©lectionner' : 'Deselect'}
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <div className="no-selection">
                                        {copiedWidget ? (
                                            <>
                                                <p>Widget copi√© : <strong>{getWidgetName(copiedWidget.CLASS)}</strong></p>
                                                <button 
                                                    onClick={() => pasteWidget()}
                                                    style={{ marginTop: '10px' }}
                                                >
                                                    üìã Coller au centre (Ctrl+V)
                                                </button>
                                            </>
                                        ) : (
                                            <>
                                                {t.noWidget}<br/>
                                                {t.clickWidget}
                                            </>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Tips */}
                            <div className="tips-box">
                                <h3>{t.tips}</h3>
                                <ul>
                                    <li>{t.tip1}</li>
                                    <li>{t.tip2}</li>
                                    <li>{t.tip3}</li>
                                    <li>{t.tip4}</li>
                                    <li>{t.tip5}</li>
                                </ul>
                            </div>
                        </div>

                        <div className="viewer" ref={screenRef}>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '30px', alignItems: 'center' }}>
                                {allPages.map((page, pageIdx) => (
                                    <div key={pageIdx} style={{ 
                                        display: 'flex',
                                        flexDirection: 'column',
                                        alignItems: 'center',
                                        gap: '15px'
                                    }}>
                                        {/* Titre et boutons */}
                                        <div style={{ 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            justifyContent: 'center',
                                            gap: '10px',
                                            width: '100%'
                                        }}>
                                            <h3 className="page-header-title">
                                                {t.page} {pageIdx + 1} ‚Äî {getWidgetName(page.CLASS)}
                                                <span className="page-header-sub">
                                                    ({page.widgets?.length || 0} widgets)
                                                </span>
                                            </h3>
                                            <div style={{ display: 'flex', gap: '6px' }}>
                                                <button
                                                    className="page-btn page-btn-up"
                                                    onClick={() => movePageUp(pageIdx)}
                                                    disabled={pageIdx === 0}
                                                    title={t.moveUp}
                                                >‚Üë</button>
                                                <button
                                                    className="page-btn page-btn-down"
                                                    onClick={() => movePageDown(pageIdx)}
                                                    disabled={pageIdx === allPages.length - 1}
                                                    title={t.moveDown}
                                                >‚Üì</button>
                                                <button
                                                    className="page-btn page-btn-del"
                                                    onClick={() => deletePage(pageIdx)}
                                                    title={t.deletePage}
                                                >üóëÔ∏è</button>
                                            </div>
                                        </div>
                                        
                                        {/* Phone container - centr√© ind√©pendamment */}
                                        <div className="phone-container">
                                            <div 
                                                className="phone-screen"
                                                style={{
                                                    width: `${screenDimensions.width}px`,
                                                    height: `${screenDimensions.height}px`,
                                                    cursor: 'default'
                                                }}
                                                onClick={() => {
                                                    setSelectedWidget(null);
                                                    setSelectedPage(pageIdx);
                                                }}
                                            >
                                                {showGrid && (
                                                    <div className="grid-overlay">
                                                        {Array.from({ length: gridCols + 1 }).map((_, i) => (
                                                            <div
                                                                key={`v${i}`}
                                                                className="grid-line vertical"
                                                                style={{ left: `${(i / gridCols) * 100}%` }}
                                                            />
                                                        ))}
                                                        {Array.from({ length: gridRows + 1 }).map((_, i) => (
                                                            <div
                                                                key={`h${i}`}
                                                                className="grid-line horizontal"
                                                                style={{ top: `${(i / gridRows) * 100}%` }}
                                                            />
                                                        ))}
                                                    </div>
                                                )}

                                                {page.widgets?.map((widget, idx) => {
                                                    const x = (widget.X1 / 10000) * screenDimensions.width;
                                                    const y = (widget.Y1 / 10000) * screenDimensions.height;
                                                    const width = ((widget.X2 - widget.X1) / 10000) * screenDimensions.width;
                                                    const height = ((widget.Y2 - widget.Y1) / 10000) * screenDimensions.height;
                                                    const isSelected = selectedWidget === idx && selectedPage === pageIdx;
                                                    
                                                    // Obtenir le preview
                                                    const preview = getWidgetPreview(widget, width, height);

                                                    return (
                                                        <div
                                                            key={idx}
                                                            className={`widget ${isSelected ? 'selected' : ''}`}
                                                            style={{
                                                                left: `${x}px`,
                                                                top: `${y}px`,
                                                                width: `${width}px`,
                                                                height: `${height}px`,
                                                                cursor: 'pointer',
                                                                zIndex: isSelected ? 100 : 10
                                                            }}
                                                            title={widget.CLASS}
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                
                                                                // Ctrl+Click: cycle through overlapping widgets
                                                                if (e.ctrlKey || e.metaKey) {
                                                                    const rect = e.currentTarget.closest('.phone-screen').getBoundingClientRect();
                                                                    const overlapping = getWidgetsAtPosition(pageIdx, e.clientX, e.clientY, rect);
                                                                    
                                                                    if (overlapping.length > 1) {
                                                                        // Trouver l'index actuel et passer au suivant
                                                                        const currentIdx = overlapping.indexOf(selectedWidget);
                                                                        const nextIdx = (currentIdx + 1) % overlapping.length;
                                                                        setSelectedWidget(overlapping[nextIdx]);
                                                                        setSelectedPage(pageIdx);
                                                                        return;
                                                                    }
                                                                }
                                                                
                                                                // Click normal
                                                                setSelectedWidget(idx);
                                                                setSelectedPage(pageIdx);
                                                            }}
                                                        >
                                                            {/* Label du widget en haut √† gauche */}
                                                            <div className="widget-label">
                                                                {getWidgetName(widget.CLASS)}
                                                            </div>

                                                            {/* Preview du contenu */}
                                                            {preview && (
                                                                <div style={{
                                                                    position: 'absolute',
                                                                    top: 0,
                                                                    left: 0,
                                                                    width: '100%',
                                                                    height: '100%',
                                                                    display: 'flex',
                                                                    flexDirection: 'column',
                                                                    alignItems: 'center',
                                                                    justifyContent: 'center',
                                                                    pointerEvents: 'none'
                                                                }}>
                                                                    {preview.icon ? (
                                                                        <div style={{ fontSize: `${preview.fontSize}px`, opacity: 0.8 }}>
                                                                            {preview.icon}
                                                                        </div>
                                                                    ) : (
                                                                        <>
                                                                            <div style={{
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                gap: '6px'
                                                                            }}>
                                                                                <div style={{
                                                                                    fontSize: `${preview.fontSize}px`,
                                                                                    fontWeight: 'bold',
                                                                                    color: '#1e293b',
                                                                                    lineHeight: 1
                                                                                }}>
                                                                                    {preview.text}
                                                                                </div>
                                                                                {preview.unit && (
                                                                                    preview.unit.includes('/') ? (
                                                                                        // Affichage fraction verticale pour km/h, m/s, etc.
                                                                                        <div style={{
                                                                                            display: 'flex',
                                                                                            flexDirection: 'column',
                                                                                            alignItems: 'center',
                                                                                            fontSize: `${preview.unitSize}px`,
                                                                                            color: '#64748b',
                                                                                            lineHeight: 0.8,
                                                                                            gap: '1px'
                                                                                        }}>
                                                                                            <div>{preview.unit.split('/')[0]}</div>
                                                                                            <div style={{ 
                                                                                                borderTop: '1px solid #6b7280',
                                                                                                width: '100%',
                                                                                                margin: '0'
                                                                                            }}></div>
                                                                                            <div>{preview.unit.split('/')[1]}</div>
                                                                                        </div>
                                                                                    ) : (
                                                                                        // Affichage simple pour m, km, etc.
                                                                                        <div style={{
                                                                                            fontSize: `${preview.unitSize}px`,
                                                                                            color: '#64748b',
                                                                                            lineHeight: 1
                                                                                        }}>
                                                                                            {preview.unit}
                                                                                        </div>
                                                                                    )
                                                                                )}
                                                                            </div>
                                                                            {preview.subtext && (
                                                                                <div style={{
                                                                                    fontSize: `${preview.unitSize}px`,
                                                                                    color: '#4a6580',
                                                                                    marginTop: '4px'
                                                                                }}>
                                                                                    {preview.subtext}
                                                                                </div>
                                                                            )}
                                                                        </>
                                                                    )}
                                                                </div>
                                                            )}

                                                            {isSelected && (
                                                                <>
                                                                    <div 
                                                                        className="resize-handle nw"
                                                                        onMouseDown={(e) => handleMouseDown(e, pageIdx, idx, 'nw')}
                                                                    />
                                                                    <div 
                                                                        className="resize-handle ne"
                                                                        onMouseDown={(e) => handleMouseDown(e, pageIdx, idx, 'ne')}
                                                                    />
                                                                    <div 
                                                                        className="resize-handle sw"
                                                                        onMouseDown={(e) => handleMouseDown(e, pageIdx, idx, 'sw')}
                                                                    />
                                                                    <div 
                                                                        className="resize-handle se"
                                                                        onMouseDown={(e) => handleMouseDown(e, pageIdx, idx, 'se')}
                                                                    />
                                                                    
                                                                    <div 
                                                                        className="move-handle"
                                                                        onMouseDown={(e) => handleMouseDown(e, pageIdx, idx, 'move')}
                                                                    />
                                                                </>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Toast de notification undo/redo */}
                    {undoMessage && (
                        <div className="undo-toast">
                            {undoMessage}
                        </div>
                    )}

                    {/* Save to Cloud Modal */}
                    {showCommunityModal && (
                        <div className="modal-overlay" onClick={() => setShowCommunityModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <div className="modal-header">
                                    üíæ {t.uploadConfig}
                                </div>

                                <div style={{ 
                                    padding: '12px', 
                                    background: 'rgba(99,102,241,0.08)', 
                                    borderRadius: '6px',
                                    marginBottom: '20px',
                                    fontSize: '0.9rem',
                                    color: '#7ba7e0'
                                }}>
                                    {lang === 'fr' ? 'Partag√© par' : 'Shared by'} <strong>{getUsername(user?.email)}</strong>
                                </div>

                                <div className="form-group">
                                    <label>Tags *</label>
                                    <div style={{ 
                                        fontSize: '0.8rem', 
                                        color: '#64748b', 
                                        marginBottom: '10px' 
                                    }}>
                                        {lang === 'fr' 
                                            ? '‚ú® D√©tect√©s automatiquement depuis vos pages - modifiez si besoin'
                                            : '‚ú® Auto-detected from your pages - edit if needed'}
                                    </div>
                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '10px' }}>
                                        {[
                                            { value: 'cross', label: t.categoryCross },
                                            { value: 'compete', label: t.categoryCompete },
                                            { value: 'casual', label: t.categoryCasual },
                                            { value: 'experimental', label: t.categoryExperimental }
                                        ].map((tag) => (
                                            <label
                                                key={tag.value}
                                                style={{
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    gap: '6px',
                                                    padding: '8px 12px',
                                                    border: '2px solid',
                                                    borderColor: configTags.includes(tag.value) ? 'var(--sky)' : 'rgba(14,165,233,0.15)',
                                                    borderRadius: '6px',
                                                    cursor: 'pointer',
                                                    background: configTags.includes(tag.value) ? 'var(--sky-glow)' : 'var(--panel)',
                                                    transition: 'all 0.2s',
                                                    userSelect: 'none'
                                                }}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={configTags.includes(tag.value)}
                                                    onChange={() => toggleTag(tag.value)}
                                                    style={{ cursor: 'pointer' }}
                                                />
                                                <span style={{ fontSize: '0.95rem' }}>{tag.label}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                <div className="modal-buttons">
                                    <button 
                                        className="btn-secondary"
                                        onClick={() => setShowCommunityModal(false)}
                                    >
                                        {t.cancel}
                                    </button>
                                    <button 
                                        className="btn-primary"
                                        onClick={saveToCloud}
                                    >
                                        {t.upload}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Browse Community Modal */}
                    {showBrowseModal && (
                        <div className="modal-overlay" onClick={() => setShowBrowseModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '700px' }}>
                                <div className="modal-header">
                                    üìÇ {t.browseConfigs}
                                </div>

                                {/* Filters and Sort */}
                                <div style={{ marginBottom: '20px' }}>
                                    <div style={{ marginBottom: '10px' }}>
                                        <label style={{ fontWeight: '500', marginBottom: '8px', display: 'block' }}>
                                            {lang === 'fr' ? 'Trier par' : 'Sort by'}
                                        </label>
                                        <select 
                                            value={communitySortBy}
                                            onChange={(e) => setCommunitySortBy(e.target.value)}
                                            style={{ padding: '8px', borderRadius: '6px', border: '1px solid #d1d5db', width: '200px' }}
                                        >
                                            <option value="upvotes">{t.popular}</option>
                                            <option value="recent">{t.recent}</option>
                                            <option value="downloads">{t.mostDownloaded}</option>
                                        </select>
                                    </div>
                                    
                                    <div>
                                        <label style={{ fontWeight: '500', marginBottom: '8px', display: 'block' }}>
                                            {lang === 'fr' ? 'Filtrer par tags' : 'Filter by tags'}
                                        </label>
                                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                                            {[
                                                { value: 'cross', label: t.categoryCross },
                                                { value: 'compete', label: t.categoryCompete },
                                                { value: 'casual', label: t.categoryCasual },
                                                { value: 'experimental', label: t.categoryExperimental }
                                            ].map((tag) => (
                                                <label
                                                    key={tag.value}
                                                    style={{
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        gap: '6px',
                                                        padding: '6px 10px',
                                                        border: '2px solid',
                                                        borderColor: communityFilters.includes(tag.value) ? 'var(--sky)' : 'rgba(14,165,233,0.15)',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        background: communityFilters.includes(tag.value) ? 'var(--sky-glow)' : 'var(--panel)',
                                                        transition: 'all 0.2s',
                                                        userSelect: 'none',
                                                        fontSize: '0.9rem'
                                                    }}
                                                >
                                                    <input
                                                        type="checkbox"
                                                        checked={communityFilters.includes(tag.value)}
                                                        onChange={() => toggleFilter(tag.value)}
                                                        style={{ cursor: 'pointer' }}
                                                    />
                                                    {tag.label}
                                                </label>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                {/* Configs List */}
                                <div style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                    {communityConfigs.length === 0 ? (
                                        <div style={{ textAlign: 'center', padding: '40px', color: '#64748b' }}>
                                            {lang === 'fr' ? 'Aucune configuration trouv√©e' : 'No configurations found'}
                                        </div>
                                    ) : (
                                        communityConfigs.map((config) => (
                                            <div 
                                                key={config.id}
                                                style={{
                                                    padding: '15px',
                                                    marginBottom: '10px',
                                                    border: '1px solid rgba(14,165,233,0.12)',
                                                    borderRadius: '8px',
                                                    background: 'var(--panel)',
                                                    display: 'flex',
                                                    gap: '15px'
                                                }}
                                            >
                                                {/* Thumbnail */}
                                                {config.screenshot && (
                                                    <img
                                                        src={config.screenshot}
                                                        alt={config.name}
                                                        style={{
                                                            width: '120px',
                                                            height: 'auto',
                                                            borderRadius: '6px',
                                                            border: '1px solid #d1d5db',
                                                            cursor: 'pointer',
                                                            objectFit: 'contain'
                                                        }}
                                                        onClick={() => openPreview(config)}
                                                    />
                                                )}
                                                
                                                <div style={{ flex: 1, display: 'flex', justifyContent: 'space-between', alignItems: 'start' }}>
                                                    <div style={{ flex: 1 }}>
                                                        <h4 style={{ margin: '0 0 5px 0', fontSize: '1.1rem', color: '#1e293b' }}>
                                                            {config.name}
                                                        </h4>
                                                        <div style={{ fontSize: '0.85rem', color: '#64748b', marginBottom: '8px' }}>
                                                            {t.by} {config.user_email?.split('@')[0] || t.anonymous}
                                                        </div>
                                                        {config.description && (
                                                            <p style={{ margin: '0', fontSize: '0.9rem', color: '#8aaccc' }}>
                                                                {config.description}
                                                            </p>
                                                        )}
                                                        {config.tags && config.tags.length > 0 && (
                                                            <div style={{ display: 'flex', gap: '5px', marginTop: '8px', flexWrap: 'wrap' }}>
                                                                {config.tags.map((tag) => (
                                                                    <span
                                                                        key={tag}
                                                                        style={{
                                                                            padding: '3px 8px',
                                                                            background: '#e0e7ff',
                                                                            color: '#7ba7e0',
                                                                            borderRadius: '4px',
                                                                            fontSize: '0.75rem',
                                                                            fontWeight: '500'
                                                                        }}
                                                                    >
                                                                        {tag}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <button
                                                        onClick={() => openPreview(config)}
                                                        style={{
                                                            padding: '8px 16px',
                                                            background: 'var(--sky-glow)',
                                                            border: '1px solid var(--border-bright)',
                                                            color: 'var(--sky)',
                                                            borderRadius: '6px',
                                                            cursor: 'pointer',
                                                            fontSize: '0.9rem',
                                                            whiteSpace: 'nowrap',
                                                            marginLeft: '10px'
                                                        }}
                                                    >
                                                        {lang === 'fr' ? 'üëÅÔ∏è Voir' : 'üëÅÔ∏è View'}
                                                    </button>
                                                </div>
                                                <div style={{ fontSize: '0.8rem', color: '#4a6580', marginTop: '8px' }}>
                                                    üëç {config.upvotes || 0} ‚Ä¢ ‚¨áÔ∏è {config.downloads || 0} {t.downloads}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>

                                <div className="modal-buttons" style={{ marginTop: '20px' }}>
                                    <button 
                                        className="btn-secondary"
                                        onClick={() => setShowBrowseModal(false)}
                                        style={{ width: '100%' }}
                                    >
                                        {t.close}
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Preview Modal */}
                    {showPreviewModal && previewConfig && (
                        <div className="modal-overlay" onClick={() => setShowPreviewModal(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '900px' }}>
                                <div className="modal-header">
                                    üëÅÔ∏è {previewConfig.name}
                                </div>

                                <div style={{ marginBottom: '15px', color: '#64748b', fontSize: '0.9rem' }}>
                                    {t.by} {previewConfig.user_email?.split('@')[0] || t.anonymous}
                                </div>

                                {previewConfig.description && (
                                    <p style={{ marginBottom: '15px', color: '#8aaccc' }}>
                                        {previewConfig.description}
                                    </p>
                                )}

                                {previewConfig.tags && previewConfig.tags.length > 0 && (
                                    <div style={{ display: 'flex', gap: '5px', marginBottom: '15px', flexWrap: 'wrap' }}>
                                        {previewConfig.tags.map((tag) => (
                                            <span
                                                key={tag}
                                                style={{
                                                    padding: '4px 10px',
                                                    background: '#e0e7ff',
                                                    color: '#7ba7e0',
                                                    borderRadius: '4px',
                                                    fontSize: '0.85rem',
                                                    fontWeight: '500'
                                                }}
                                            >
                                                {tag}
                                            </span>
                                        ))}
                                    </div>
                                )}

                                {/* Screenshot */}
                                {previewConfig.screenshot ? (
                                    <div style={{ 
                                        marginBottom: '20px', 
                                        textAlign: 'center',
                                        background: 'var(--panel)',
                                        padding: '20px',
                                        borderRadius: '8px',
                                        border: '1px solid rgba(14,165,233,0.12)'
                                    }}>
                                        <img 
                                            src={previewConfig.screenshot} 
                                            alt="Config preview"
                                            style={{ 
                                                maxWidth: '100%', 
                                                height: 'auto',
                                                cursor: 'zoom-in',
                                                borderRadius: '4px'
                                            }}
                                            onClick={(e) => {
                                                if (e.target.style.maxWidth === '100%') {
                                                    e.target.style.maxWidth = 'none';
                                                    e.target.style.cursor = 'zoom-out';
                                                } else {
                                                    e.target.style.maxWidth = '100%';
                                                    e.target.style.cursor = 'zoom-in';
                                                }
                                            }}
                                        />
                                    </div>
                                ) : (
                                    <div style={{ 
                                        padding: '40px', 
                                        textAlign: 'center', 
                                        color: '#4a6580',
                                        background: 'var(--panel)',
                                        borderRadius: '8px',
                                        marginBottom: '20px'
                                    }}>
                                        {lang === 'fr' ? 'Pas d\'aper√ßu disponible' : 'No preview available'}
                                    </div>
                                )}

                                <div style={{ fontSize: '0.85rem', color: '#4a6580', marginBottom: '20px' }}>
                                    üëç {previewConfig.upvotes || 0} ‚Ä¢ ‚¨áÔ∏è {previewConfig.downloads || 0} {t.downloads}
                                </div>

                                {/* Warning and buttons */}
                                <div style={{
                                    background: 'rgba(245,158,11,0.08)',
                                    border: '1px solid rgba(245,158,11,0.3)',
                                    borderRadius: '6px',
                                    padding: '12px',
                                    marginBottom: '20px',
                                    fontSize: '0.9rem',
                                    color: '#fbbf24'
                                }}>
                                    ‚ö†Ô∏è {lang === 'fr' 
                                        ? 'Charger cette configuration remplacera votre configuration actuelle.' 
                                        : 'Loading this configuration will replace your current configuration.'}
                                </div>

                                <div className="modal-buttons">
                                    <button 
                                        className="btn-secondary"
                                        onClick={() => setShowPreviewModal(false)}
                                    >
                                        {t.cancel}
                                    </button>
                                    <button 
                                        className="btn-primary"
                                        onClick={() => {
                                            downloadConfig(previewConfig);
                                            setShowPreviewModal(false);
                                        }}
                                    >
                                        ‚¨áÔ∏è {lang === 'fr' ? 'Charger cette config' : 'Load this config'}
                                    </button>
                                    {canEdit(previewConfig) && (
                                        <button 
                                            onClick={() => deleteConfig(previewConfig)}
                                            style={{
                                                padding: '12px',
                                                background: 'rgba(239,68,68,0.12)',
                                                color: '#f87171',
                                                border: '1px solid rgba(239,68,68,0.35)',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '1rem'
                                            }}
                                            title={lang === 'fr' ? 'Supprimer' : 'Delete'}
                                        >
                                            üóëÔ∏è
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* CSS Live Editor Modal */}
                    {showCSSEditor && (
                        <div className="modal-backdrop" onClick={() => setShowCSSEditor(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()} 
                                style={{ 
                                    maxWidth: '95vw', 
                                    width: '95vw',
                                    height: '90vh',
                                    display: 'flex',
                                    flexDirection: 'column'
                                }}>
                                <div style={{ marginBottom: '12px' }}>
                                    <h2 style={{ marginBottom: '4px' }}>üé® CSS Live Editor</h2>
                                    <p style={{ fontSize: '0.85rem', color: 'var(--text-dim)' }}>
                                        Edit CSS in real-time. Changes apply instantly. Press <kbd style={{ 
                                            padding: '2px 6px', 
                                            background: 'var(--panel)', 
                                            border: '1px solid var(--border)', 
                                            borderRadius: '3px',
                                            fontFamily: 'monospace'
                                        }}>Ctrl+Shift+C</kbd> to toggle.
                                    </p>
                                </div>

                                <div style={{ display: 'flex', gap: '12px', flex: 1, minHeight: 0 }}>
                                    {/* Left: CSS Editor */}
                                    <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                                        <div style={{ 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            justifyContent: 'space-between',
                                            marginBottom: '8px'
                                        }}>
                                            <div style={{ 
                                                fontSize: '0.75rem', 
                                                color: 'var(--text-dim)',
                                                textTransform: 'uppercase',
                                                letterSpacing: '0.5px',
                                                fontWeight: '600'
                                            }}>
                                                CSS Code ({liveCSS.split('\n').length} lines)
                                            </div>
                                            <input 
                                                type="text"
                                                placeholder="Search CSS... (Ctrl+F)"
                                                value={cssSearch}
                                                onChange={(e) => setCSSSearch(e.target.value)}
                                                style={{
                                                    padding: '4px 8px',
                                                    fontSize: '0.75rem',
                                                    background: 'var(--panel)',
                                                    border: '1px solid var(--border)',
                                                    borderRadius: '4px',
                                                    color: 'var(--text)',
                                                    width: '200px'
                                                }}
                                            />
                                        </div>
                                        <textarea
                                            value={liveCSS}
                                            onChange={(e) => setLiveCSS(e.target.value)}
                                            style={{
                                                flex: 1,
                                                fontFamily: "'Courier New', monospace",
                                                fontSize: '0.8rem',
                                                lineHeight: '1.5',
                                                padding: '12px',
                                                background: 'var(--deeper)',
                                                color: 'var(--text)',
                                                border: '1px solid var(--border)',
                                                borderRadius: '6px',
                                                resize: 'none',
                                                overflowY: 'auto',
                                                tabSize: 4
                                            }}
                                            spellCheck="false"
                                            placeholder="/* Your CSS here */"
                                        />
                                    </div>

                                    {/* Right: Live Preview */}
                                    <div style={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
                                        <div style={{ 
                                            marginBottom: '8px', 
                                            fontSize: '0.75rem', 
                                            color: 'var(--text-dim)',
                                            textTransform: 'uppercase',
                                            letterSpacing: '0.5px',
                                            fontWeight: '600'
                                        }}>
                                            Live Preview
                                        </div>
                                        <div style={{
                                            flex: 1,
                                            background: 'var(--deeper)',
                                            border: '1px solid var(--border)',
                                            borderRadius: '6px',
                                            padding: '20px',
                                            overflowY: 'auto',
                                            fontSize: '0.85rem',
                                            color: 'var(--text-dim)'
                                        }}>
                                            <div style={{ marginBottom: '16px' }}>
                                                <div style={{ 
                                                    background: 'var(--card)', 
                                                    border: '1px solid var(--border)',
                                                    borderRadius: 'var(--radius)',
                                                    padding: '16px'
                                                }}>
                                                    <h3 style={{ color: 'var(--sky)', marginBottom: '8px' }}>Preview Panel</h3>
                                                    <p style={{ color: 'var(--text)' }}>This shows how your CSS affects the interface.</p>
                                                    <button style={{ marginTop: '12px' }}>Sample Button</button>
                                                </div>
                                            </div>
                                            <div style={{ 
                                                fontSize: '0.75rem', 
                                                color: 'var(--text-muted)',
                                                fontStyle: 'italic'
                                            }}>
                                                üí° Tip: Look at the main editor behind this modal to see real-time changes!
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div style={{ display: 'flex', gap: '8px', marginTop: '12px', flexWrap: 'wrap' }}>
                                    <button onClick={exportCSSToClipboard} style={{ background: 'var(--sky)', color: 'white' }}>
                                        üìã Copy CSS
                                    </button>
                                    <button onClick={saveCSS} style={{ background: 'var(--green)', color: 'white' }}>
                                        üíæ Save
                                    </button>
                                    <button onClick={loadSavedCSS} style={{ background: 'var(--amber)', color: 'white' }}>
                                        üìÇ Load Saved
                                    </button>
                                    <button onClick={resetCSS} style={{ background: 'var(--red)', color: 'white' }}>
                                        üîÑ Reset
                                    </button>
                                    <button onClick={() => setShowCSSEditor(false)}>
                                        ‚úï Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<XCTrackViewer />, document.getElementById('root'));
    </script>
</body>
</html>
