<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XCTrack Layout Editor</title>
    <!--
        XCTrack Layout Editor
        Created by: Laurent Fischer & Claude (Anthropic)
        For the paragliding community
        License: MIT - https://opensource.org/licenses/MIT
        GitHub: [Add your repo URL here]
    -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚úèÔ∏è</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            align-items: start;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .controls h3 {
            margin: 0 0 10px 0;
            color: #374151;
            font-size: 1.1rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .control-group.checkbox {
            flex-direction: row;
            align-items: center;
            gap: 10px;
        }

        .control-group.checkbox label {
            margin: 0;
        }

        .control-group.checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        select, button {
            padding: 10px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        select:hover, button:hover {
            border-color: #667eea;
        }

        select:focus, button:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            font-weight: 600;
        }

        button:hover {
            background: #5568d3;
        }

        button.full-width {
            width: 100%;
        }

        .stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 0.9rem;
            color: #6b7280;
            padding: 15px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat strong {
            color: #374151;
        }

        .viewer {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow-y: auto;
            overflow-x: hidden;
            height: calc(100vh - 140px);
        }

        .viewer::-webkit-scrollbar {
            width: 10px;
        }

        .viewer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .viewer::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .viewer::-webkit-scrollbar-thumb:hover {
            background: #5568d3;
        }

        .phone-container {
            position: relative;
            background: #1f2937;
            border-radius: 20px;
            padding: 15px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            width: fit-content;
        }

        .phone-screen {
            position: relative;
            background: #f3f4f6;
            border-radius: 8px;
            overflow: hidden;
        }

        .widget {
            position: absolute;
            border: 2px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
            transition: all 0.2s;
            overflow: hidden;
        }

        .widget:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #5568d3;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .widget-label {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 0.7rem;
            font-weight: 600;
            color: #374151;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 6px;
            border-radius: 3px;
            pointer-events: none;
            z-index: 50;
            max-width: calc(100% - 8px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .widget.selected {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.15);
            box-shadow: 0 0 0 2px #ef4444;
            z-index: 100;
        }

        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #ef4444;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 101;
        }

        .resize-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
        .resize-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .resize-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }

        .move-handle {
            position: absolute;
            width: 38px;
            height: 38px;
            border: 3px dashed #ef4444;
            border-radius: 50%;
            background: transparent;
            cursor: move;
            z-index: 101;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .move-handle:hover {
            border-color: #dc2626;
            background: rgba(239, 68, 68, 0.1);
        }

        .grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: 1;
        }

        .grid-line {
            position: absolute;
            background: rgba(102, 126, 234, 0.15);
        }

        .grid-line.vertical {
            width: 1px;
            height: 100%;
        }

        .grid-line.horizontal {
            height: 1px;
            width: 100%;
        }

        .widget-info-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .widget-info-panel h3 {
            color: #374151;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .widget-info-panel h4 {
            color: #374151;
            margin: 0 0 10px 0;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .widget-info-panel .coords {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #6b7280;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
        }

        .widget-info-panel .no-selection {
            color: #9ca3af;
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .action-buttons button {
            width: 100%;
        }

        .delete-btn {
            background: #ef4444;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .export-btn {
            background: #10b981;
        }

        .export-btn:hover {
            background: #059669;
        }

        .import-btn {
            background: #6366f1;
        }

        .import-btn:hover {
            background: #4f46e5;
        }

        .widget-library {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            max-height: 400px;
            overflow-y: auto;
        }

        .widget-library h3 {
            color: #374151;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .widget-library-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .widget-library-item {
            padding: 10px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            font-weight: 500;
            color: #374151;
        }

        .widget-library-item:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
            transform: translateX(4px);
        }

        .page-management {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .page-management h3 {
            color: #374151;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .page-type-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .page-type-btn {
            padding: 10px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .page-type-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .undo-toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #1f2937;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            font-weight: 600;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .view-mode-toggle {
            display: flex;
            gap: 0;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }

        .view-mode-toggle button {
            border-radius: 0;
            border: none;
            background: white;
            color: #6b7280;
            padding: 8px 16px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .view-mode-toggle button.active {
            background: #667eea;
            color: white;
        }

        .page-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .page-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
        }

        .page-card:hover {
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .page-card.active {
            border-color: #667eea;
        }

        .page-card h4 {
            color: #374151;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .page-preview {
            background: #f3f4f6;
            border-radius: 8px;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .page-preview.portrait {
            aspect-ratio: 9/16;
        }

        .page-preview-screen {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .page-widget-mini {
            position: absolute;
            border: 1px solid #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .page-info-mini {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 8px;
        }

        .drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s;
            cursor: pointer;
        }

        .drop-zone:hover, .drop-zone.drag-over {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .drop-zone h2 {
            color: #374151;
            margin-bottom: 15px;
        }

        .drop-zone p {
            color: #6b7280;
            margin-bottom: 20px;
        }

        .drop-zone button {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .drop-zone button:hover {
            background: #5568d3;
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
            }

            .viewer {
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useRef, useEffect } = React;

        const RESOLUTION_PRESETS = [
            { name: 'Samsung A51 (2400√ó1080)', width: 2400, height: 1080, gridCols: 44, gridRows: 22 },
            { name: 'Standard HD (1920√ó1080)', width: 1920, height: 1080, gridCols: 35, gridRows: 20 },
            { name: 'Standard (1080√ó1920)', width: 1080, height: 1920, gridCols: 20, gridRows: 35 },
        ];

        const getWidgetName = (className) => {
            const match = className.match(/\.([^.]+)$/);
            if (!match) return className;
            const name = match[1];
            // Retirer le pr√©fixe "W" pour les widgets et "WP" pour les pages
            if (name.startsWith('WP')) return name.substring(2);
            if (name.startsWith('W')) return name.substring(1);
            return name;
        };

        const calculateGridSize = (resolution) => {
            return {
                horizontal: 10000 / resolution.gridCols,
                vertical: 10000 / resolution.gridRows
            };
        };

        const snapToGrid = (value, gridSize, enabled) => {
            if (!enabled) return value;
            return Math.round(value / gridSize) * gridSize;
        };

        // Templates de widgets pour la biblioth√®que
        const WIDGET_LIBRARY = {
            "WAltitude": { CLASS: "org.xcontest.XCTrack.widget.w.WAltitude", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, _units: "SYS_UNIT" },
            "WSpeed": { CLASS: "org.xcontest.XCTrack.widget.w.WSpeed", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, _units: "SYS_UNIT", backwardDetection: false },
            "WVerticalSpeed": { CLASS: "org.xcontest.XCTrack.widget.w.WVerticalSpeed", _border: false, _bg: 100, _theme: "", _title: false, titletext: "", _unit: false, _hide_labels: false, avg: 2000 },
            "WGlide": { CLASS: "org.xcontest.XCTrack.widget.w.WGlide", _border: false, _bg: 100, _theme: "", _title: false, titletext: "", _unit: true, _hide_labels: false, showVario: false, avg: 2000, headless: true },
            "WTime": { CLASS: "org.xcontest.XCTrack.widget.w.WTime", _border: false, _bg: 100, _theme: "", _title: false, titletext: "", showSec: false },
            "WWindSpeed": { CLASS: "org.xcontest.XCTrack.widget.w.WWindSpeed", _border: true, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WAltitudeAboveGround": { CLASS: "org.xcontest.XCTrack.widget.w.WAltitudeAboveGround", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WAltitudeMaximum": { CLASS: "org.xcontest.XCTrack.widget.w.WAltitudeMaximum", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WThermalAltGain": { CLASS: "org.xcontest.XCTrack.widget.w.WThermalAltGain", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WAirTime": { CLASS: "org.xcontest.XCTrack.widget.w.WAirTime", _border: true, _bg: 100, _theme: "", _title: true, titletext: "" },
            "WStatusLine": { CLASS: "org.xcontest.XCTrack.widget.w.WStatusLine", _border: false, _bg: 100, _theme: "", showGps: true, showSensors: true, showLive: true, showLiveLabel: false, showBatteryIcon: true, showBatteryPercent: true, showTime: false },
            "WCompass": { CLASS: "org.xcontest.XCTrack.widget.w.WCompass", _border: true, _bg: 100, _theme: "", rotation: "BEARING", navigation_target: "OPTIMIZED", showWind: true, newWindArrow: true, showHeading: false, showBearing: false, showBackground: false },
            "WOptiResult": { CLASS: "org.xcontest.XCTrack.widget.w.WOptiResult", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WAirspaceProximity": { CLASS: "org.xcontest.XCTrack.widget.w.WAirspaceProximity", _border: true, _bg: 60, _theme: "", maxDistance: 5000, _shownearinside: true, _showoriginalheightline: true, _showrecomputedheightline: false, _splitdirection: "HORIZONTAL", postponedFloorLimit: 2500, postponedDisplayDistance: 300 },
            "WThermalAssistant": { CLASS: "org.xcontest.XCTrack.widget.w.WThermalAssistant", _border: false, _bg: 80, _theme: "", rotation: { value: "BEARING_AT_TOP", showCompass: false }, mapScale: { value: 36, auto: false }, drawScale: false, fontSize: "LARGE", mapWidget_heading_arrow_sizecoef: 152, mapWidget_showAirspaces: true, postponedFloorLimit: 2500, postponedDisplayDistance: 600, interval: 330, drawCircle: true, includeWindAlgorithm: "ALGO_PARTICLE_DRIFT", nav_target: "OPTIMIZED", nav_use_brackets: true, nav_line: true, thermals: 3, nav_showWind: true, nav_showSun: false, line_thickness: 20, mapWidget_drawBearing: true },
            "WCompDistanceToGoal": { CLASS: "org.xcontest.XCTrack.widget.w.WCompDistanceToGoal", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WCompGlideToGoal": { CLASS: "org.xcontest.XCTrack.widget.w.WCompGlideToGoal", _border: true, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, headless: false },
            "WCompAltitudeOverGoal": { CLASS: "org.xcontest.XCTrack.widget.w.WCompAltitudeOverGoal", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WCompTimeToStart": { CLASS: "org.xcontest.XCTrack.widget.w.WCompTimeToStart", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _hide_labels: false },
            "WCompTimeAtStart": { CLASS: "org.xcontest.XCTrack.widget.w.WCompTimeAtStart", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, navigation_target: "OPTIMIZED", use_brackets: true, speed_type: "GROUND", speed_avg: 10000, time_format: "COMPACT" },
            "WNextTurnpointDistance": { CLASS: "org.xcontest.XCTrack.widget.w.WNextTurnpointDistance", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, navigation_target: "OPTIMIZED", use_brackets: true },
            "WNextTurnpointAlt": { CLASS: "org.xcontest.XCTrack.widget.w.WNextTurnpointAlt", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, navigation_target: "OPTIMIZED", use_brackets: false, speed_avg: 8000, altitude: "AMSL", glide: "COMPUTED" },
            "WNextTurnpointGlideTo": { CLASS: "org.xcontest.XCTrack.widget.w.WNextTurnpointGlideTo", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, navigation_target: "OPTIMIZED", use_brackets: false, alt_above: 600, headless: false },
            "WNextTurnpointTimeOfArrival": { CLASS: "org.xcontest.XCTrack.widget.w.WNextTurnpointTimeOfArrival", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false, navigation_target: "OPTIMIZED", use_brackets: false, speed_type: "GROUND", speed_avg: 8000, time_format: "COMPACT" },
            "WXCSpeed": { CLASS: "org.xcontest.XCTrack.widget.w.WXCSpeed", _border: false, _bg: 100, _theme: "", _title: true, titletext: "", _unit: true, _hide_labels: false },
            "WFreeText": { CLASS: "org.xcontest.XCTrack.widget.w.WFreeText", _border: false, _theme: "BlackTheme", text: "Text", color_text: -5000269, color_bg: 16777215, text_size: 40, text_bold: true, text_italic: false, text_padding: 10 },
            "WVerticalGraph": { CLASS: "org.xcontest.XCTrack.widget.w.WVerticalGraph", _border: false, _bg: 100, _theme: "", interval: 90000, vertical_step: 50, dot_size: 10, dot_color: -8355585 },
            "WSideView": { CLASS: "org.xcontest.XCTrack.widget.w.WSideView", _border: false, _bg: 100, _theme: "", type: "SIDE_NAVIG", distance: 15000, finalGlideAvg: 9000 },
            "WAltitudeDataGraph": { CLASS: "org.xcontest.XCTrack.widget.w.WAltitudeDataGraph", _border: true, _bg: 100, _theme: "", type: "GRAPH_WIND", text_size: 20, line_thickness: 10, color_thermal: -2147483393, color_wind: -2136956896 },
            "WButtonZoom": { CLASS: "org.xcontest.XCTrack.widget.w.WButtonZoom", _border: true, _bg: 100, _theme: "", type: "ACTION_ZOOM_OUT" },
            "WButtonNavig": { CLASS: "org.xcontest.XCTrack.widget.w.WButtonNavig", _border: true, _bg: 100, _theme: "", longClick: true, type: "ACTION_PREV_WAYPOINT" },
        };

        // Types de pages disponibles
        const PAGE_TYPES = [
            { name: "Thermal Assistant", CLASS: "org.xcontest.XCTrack.widget.wp.WPThermalAssistant", navigations: "all" },
            { name: "XC Assistant", CLASS: "org.xcontest.XCTrack.widget.wp.WPXCAssistant", navigations: "all" },
            { name: "Competition", CLASS: "org.xcontest.XCTrack.widget.wp.WPCompetition", navigations: ["org.xcontest.XCTrack.navig.TaskCompetition"] },
            { name: "Empty (Blank)", CLASS: "org.xcontest.XCTrack.widget.wp.WPEmpty", navigations: "all" },
        ];

        // Previews pour les widgets
        const WIDGET_PREVIEWS = {
            "WAltitude": { text: "1234", unit: "m", baseSize: 2.5 },
            "WAltitudeAboveGround": { text: "856", unit: "m", baseSize: 2.5 },
            "WAltitudeMaximum": { text: "2891", unit: "m", baseSize: 2.5 },
            "WSpeed": { text: "24", unit: "km/h", baseSize: 2.5 },
            "WXCSpeed": { text: "32", unit: "km/h", baseSize: 2.5 },
            "WVerticalSpeed": { text: "+1.2", unit: "m/s", baseSize: 2.5 },
            "WGlide": { text: "8.5", unit: "", baseSize: 2.5 },
            "WWindSpeed": { text: "12", unit: "km/h", baseSize: 2 },
            "WTime": { text: "14:32", baseSize: 2.5 },
            "WAirTime": { text: "01:23:45", baseSize: 2 },
            "WThermalAltGain": { text: "+180", unit: "m", baseSize: 2 },
            "WOptiResult": { text: "42.3", unit: "km", baseSize: 2 },
            "WStatusLine": { icon: "üì∂ üîã üíö", baseSize: 1.2 },
            "WCompass": { icon: "üß≠", baseSize: 2.8 },
            "WThermalAssistant": { icon: "üåÄ", baseSize: 3 },
            "WXCAssistant": { icon: "üó∫Ô∏è", baseSize: 3 },
            "WCompMap": { icon: "üó∫Ô∏è", baseSize: 3 },
            "WAirspaceProximity": { text: "2.5km", unit: "", baseSize: 1.5 },
            "WCompDistanceToGoal": { text: "18.2", unit: "km", baseSize: 2 },
            "WCompGlideToGoal": { text: "7.2", unit: "", baseSize: 2 },
            "WCompAltitudeOverGoal": { text: "+450", unit: "m", baseSize: 2 },
            "WCompTimeToStart": { text: "12:30", unit: "", baseSize: 2 },
            "WCompTimeAtStart": { text: "00:15", unit: "", baseSize: 2 },
            "WNextTurnpointDistance": { text: "5.8", unit: "km", baseSize: 2 },
            "WNextTurnpointAlt": { text: "1650", unit: "m", baseSize: 2 },
            "WNextTurnpointGlideTo": { text: "9.2", unit: "", baseSize: 2 },
            "WNextTurnpointTimeOfArrival": { text: "15:45", unit: "", baseSize: 1.8 },
            "WVerticalGraph": { icon: "üìà", baseSize: 2 },
            "WSideView": { icon: "‚õ∞Ô∏è", baseSize: 2 },
            "WAltitudeDataGraph": { icon: "üìä", baseSize: 2 },
            "WFreeText": { text: "TEXT", unit: "", baseSize: 2 },
            "WButtonZoom": { icon: "üîç", baseSize: 1.75 },
            "WButtonNavig": { icon: "‚û°Ô∏è", baseSize: 3 },
        };

        const XCTrackViewer = () => {
            const [configData, setConfigData] = useState(null);
            const [orientation, setOrientation] = useState('landscape');
            const [selectedWidget, setSelectedWidget] = useState(null);
            const [selectedPage, setSelectedPage] = useState(0);
            const [showGrid, setShowGrid] = useState(true);
            const [snapEnabled, setSnapEnabled] = useState(true);
            const [resolutionIndex, setResolutionIndex] = useState(0);
            const [dragState, setDragState] = useState(null);
            const [isDragOver, setIsDragOver] = useState(false);
            const [copiedWidget, setCopiedWidget] = useState(null);
            const [showWidgetLibrary, setShowWidgetLibrary] = useState(false);
            
            // Undo/Redo history
            const [history, setHistory] = useState([]);
            const [historyIndex, setHistoryIndex] = useState(-1);
            const [undoMessage, setUndoMessage] = useState('');
            
            const screenRef = useRef(null);
            const fileInputRef = useRef(null);

            // D√©tection de la langue du navigateur
            const lang = navigator.language.startsWith('fr') ? 'fr' : 'en';
            
            // Traductions
            const t = {
                fr: {
                    title: "XCTrack Layout Editor",
                    subtitle: "Visualisez et √©ditez vos layouts XCTrack",
                    loadFile: "Chargez votre fichier de configuration",
                    dropFile: "Glissez-d√©posez votre fichier .xcfg ici",
                    selectFile: "S√©lectionner un fichier",
                    config: "Configuration",
                    undo: "Undo",
                    redo: "Redo",
                    resolution: "R√©solution",
                    orientation: "Orientation",
                    landscape: "Paysage",
                    portrait: "Portrait",
                    showGrid: "Afficher la grille",
                    snapToGrid: "Magn√©tisme grille",
                    export: "Exporter xcfg file",
                    widgetLibrary: "Biblioth√®que de widgets",
                    pages: "Pages",
                    selectedWidget: "Widget s√©lectionn√©",
                    noWidget: "Aucun widget s√©lectionn√©.",
                    clickWidget: "Cliquez sur un widget pour le modifier.",
                    ctrlClickTip: "Astuce : Utilisez",
                    ctrlClickTip2: "pour s√©lectionner des widgets superpos√©s",
                    copy: "Copier",
                    duplicate: "Dupliquer",
                    delete: "Supprimer",
                    deselect: "D√©s√©lectionner",
                    widgetCopied: "Widget copi√© :",
                    pasteCenter: "Coller au centre",
                    totalPages: "Total pages:",
                    totalWidgets: "Total widgets:",
                    widgets: "widgets",
                    moveUp: "Monter la page",
                    moveDown: "Descendre la page",
                    deletePage: "Supprimer cette page"
                },
                en: {
                    title: "XCTrack Layout Editor",
                    subtitle: "View and edit your XCTrack layouts",
                    loadFile: "Load your configuration file",
                    dropFile: "Drag and drop your .xcfg file here",
                    selectFile: "Select a file",
                    config: "Configuration",
                    undo: "Undo",
                    redo: "Redo",
                    resolution: "Resolution",
                    orientation: "Orientation",
                    landscape: "Landscape",
                    portrait: "Portrait",
                    showGrid: "Show grid",
                    snapToGrid: "Snap to grid",
                    export: "Export xcfg file",
                    widgetLibrary: "Widget Library",
                    pages: "Pages",
                    selectedWidget: "Selected Widget",
                    noWidget: "No widget selected.",
                    clickWidget: "Click on a widget to edit it.",
                    ctrlClickTip: "Tip: Use",
                    ctrlClickTip2: "to select overlapping widgets",
                    copy: "Copy",
                    duplicate: "Duplicate",
                    delete: "Delete",
                    deselect: "Deselect",
                    widgetCopied: "Widget copied:",
                    pasteCenter: "Paste at center",
                    totalPages: "Total pages:",
                    totalWidgets: "Total widgets:",
                    widgets: "widgets",
                    moveUp: "Move page up",
                    moveDown: "Move page down",
                    deletePage: "Delete this page"
                }
            }[lang];

            const currentResolution = RESOLUTION_PRESETS[resolutionIndex];

            const loadConfig = (jsonText) => {
                try {
                    const data = JSON.parse(jsonText);
                    setConfigData(data);
                    setSelectedWidget(null);
                    setSelectedPage(0);
                    // Initialiser l'historique
                    setHistory([data]);
                    setHistoryIndex(0);
                } catch (e) {
                    alert('Erreur de parsing JSON : ' + e.message);
                }
            };

            // Fonction pour ajouter une action dans l'historique
            const pushHistory = (newConfig, actionName = '') => {
                const newHistory = history.slice(0, historyIndex + 1);
                newHistory.push(JSON.parse(JSON.stringify(newConfig))); // Deep clone
                
                // Limiter l'historique √† 50 actions
                if (newHistory.length > 50) {
                    newHistory.shift();
                } else {
                    setHistoryIndex(historyIndex + 1);
                }
                
                setHistory(newHistory);
                
                // Afficher le message d'action
                if (actionName) {
                    showUndoMessage(actionName);
                }
            };

            // Fonction pour afficher un message temporaire
            const showUndoMessage = (message) => {
                setUndoMessage(message);
                setTimeout(() => setUndoMessage(''), 2000);
            };

            // Undo
            const undo = () => {
                if (historyIndex > 0) {
                    const newIndex = historyIndex - 1;
                    setHistoryIndex(newIndex);
                    setConfigData(JSON.parse(JSON.stringify(history[newIndex])));
                    localStorage.setItem('xctrackConfig', JSON.stringify(history[newIndex]));
                    showUndoMessage('Action annul√©e');
                    setSelectedWidget(null);
                }
            };

            // Redo
            const redo = () => {
                if (historyIndex < history.length - 1) {
                    const newIndex = historyIndex + 1;
                    setHistoryIndex(newIndex);
                    setConfigData(JSON.parse(JSON.stringify(history[newIndex])));
                    localStorage.setItem('xctrackConfig', JSON.stringify(history[newIndex]));
                    showUndoMessage('Action r√©tablie');
                    setSelectedWidget(null);
                }
            };

            useEffect(() => {
                const savedConfig = localStorage.getItem('xctrackConfig');
                if (savedConfig) {
                    loadConfig(savedConfig);
                }
            }, []);

            const allPages = useMemo(() => {
                if (!configData?.layout) return null;
                return configData.layout[orientation] || [];
            }, [configData, orientation]);

            const gridSize = useMemo(() => {
                const sizes = calculateGridSize(currentResolution);
                if (orientation === 'landscape') {
                    return { horizontal: sizes.horizontal, vertical: sizes.vertical };
                } else {
                    return { horizontal: sizes.vertical, vertical: sizes.horizontal };
                }
            }, [currentResolution, orientation]);

            const gridCols = orientation === 'landscape' ? currentResolution.gridCols : currentResolution.gridRows;
            const gridRows = orientation === 'landscape' ? currentResolution.gridRows : currentResolution.gridCols;

            const screenDimensions = useMemo(() => {
                const scale = 0.3;
                if (orientation === 'portrait') {
                    return { 
                        width: currentResolution.height * scale, 
                        height: currentResolution.width * scale 
                    };
                } else {
                    return { 
                        width: currentResolution.width * scale, 
                        height: currentResolution.height * scale 
                    };
                }
            }, [orientation, currentResolution]);

            const handleFileUpload = (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const text = event.target.result;
                        loadConfig(text);
                        localStorage.setItem('xctrackConfig', text);
                    };
                    reader.readAsText(file);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(false);
                
                const file = e.dataTransfer.files[0];
                if (file && (file.name.endsWith('.xcfg') || file.name.endsWith('.json'))) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        const text = event.target.result;
                        loadConfig(text);
                        localStorage.setItem('xctrackConfig', text);
                    };
                    reader.readAsText(file);
                } else {
                    alert('Veuillez d√©poser un fichier .xcfg ou .json');
                }
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragOver(false);
            };

            const handleMouseDown = (e, pageIdx, widgetIndex, handleType) => {
                e.stopPropagation();
                setSelectedWidget(widgetIndex);
                setSelectedPage(pageIdx);
                
                const widget = allPages[pageIdx].widgets[widgetIndex];
                const rect = e.currentTarget.closest('.phone-screen').getBoundingClientRect();
                
                setDragState({
                    type: handleType,
                    pageIndex: pageIdx,
                    widgetIndex,
                    startX: e.clientX,
                    startY: e.clientY,
                    originalWidget: { ...widget },
                    screenRect: rect
                });
            };

            const handleMouseMove = (e) => {
                if (!dragState) return;
                
                const deltaX = e.clientX - dragState.startX;
                const deltaY = e.clientY - dragState.startY;
                
                const rect = dragState.screenRect;
                const deltaXNorm = (deltaX / rect.width) * 10000;
                const deltaYNorm = (deltaY / rect.height) * 10000;
                
                const widget = { ...dragState.originalWidget };
                
                if (dragState.type === 'move') {
                    const newX1 = snapToGrid(widget.X1 + deltaXNorm, gridSize.horizontal, snapEnabled);
                    const newY1 = snapToGrid(widget.Y1 + deltaYNorm, gridSize.vertical, snapEnabled);
                    const width = widget.X2 - widget.X1;
                    const height = widget.Y2 - widget.Y1;
                    
                    widget.X1 = Math.max(0, Math.min(10000 - width, newX1));
                    widget.Y1 = Math.max(0, Math.min(10000 - height, newY1));
                    widget.X2 = widget.X1 + width;
                    widget.Y2 = widget.Y1 + height;
                } else {
                    const minSize = Math.max(gridSize.horizontal, gridSize.vertical);
                    
                    if (dragState.type.includes('n')) {
                        widget.Y1 = snapToGrid(
                            Math.max(0, Math.min(widget.Y2 - minSize, widget.Y1 + deltaYNorm)), 
                            gridSize.vertical, 
                            snapEnabled
                        );
                    }
                    if (dragState.type.includes('s')) {
                        widget.Y2 = snapToGrid(
                            Math.max(widget.Y1 + minSize, Math.min(10000, widget.Y2 + deltaYNorm)), 
                            gridSize.vertical, 
                            snapEnabled
                        );
                    }
                    if (dragState.type.includes('w')) {
                        widget.X1 = snapToGrid(
                            Math.max(0, Math.min(widget.X2 - minSize, widget.X1 + deltaXNorm)), 
                            gridSize.horizontal, 
                            snapEnabled
                        );
                    }
                    if (dragState.type.includes('e')) {
                        widget.X2 = snapToGrid(
                            Math.max(widget.X1 + minSize, Math.min(10000, widget.X2 + deltaXNorm)), 
                            gridSize.horizontal, 
                            snapEnabled
                        );
                    }
                }
                
                updateWidget(dragState.pageIndex, dragState.widgetIndex, widget);
            };

            const handleMouseUp = () => {
                if (dragState) {
                    // Sauvegarder dans l'historique √† la fin du drag
                    const actionType = dragState.type === 'move' ? 'D√©placement' : 'Redimensionnement';
                    pushHistory(configData, actionType);
                }
                setDragState(null);
            };

            useEffect(() => {
                if (dragState) {
                    window.addEventListener('mousemove', handleMouseMove);
                    window.addEventListener('mouseup', handleMouseUp);
                    return () => {
                        window.removeEventListener('mousemove', handleMouseMove);
                        window.removeEventListener('mouseup', handleMouseUp);
                    };
                }
            }, [dragState, configData]);

            const updateWidget = (pageIdx, widgetIndex, newWidget) => {
                const newConfigData = { ...configData };
                newConfigData.layout[orientation][pageIdx].widgets[widgetIndex] = newWidget;
                setConfigData(newConfigData);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const deleteWidget = (pageIdx, widgetIndex) => {
                const newConfigData = { ...configData };
                const widgetName = getWidgetName(newConfigData.layout[orientation][pageIdx].widgets[widgetIndex].CLASS);
                newConfigData.layout[orientation][pageIdx].widgets.splice(widgetIndex, 1);
                setConfigData(newConfigData);
                setSelectedWidget(null);
                pushHistory(newConfigData, `Suppression ${widgetName}`);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const copyWidget = () => {
                if (selectedWidget === null || selectedPage === null) return;
                const widget = allPages[selectedPage].widgets[selectedWidget];
                setCopiedWidget({ ...widget });
            };

            const pasteWidget = (targetPageIdx = null) => {
                if (!copiedWidget) return;
                
                const pageIdx = targetPageIdx !== null ? targetPageIdx : selectedPage;
                
                const centerX = 5000;
                const centerY = 5000;
                
                const widgetWidth = copiedWidget.X2 - copiedWidget.X1;
                const widgetHeight = copiedWidget.Y2 - copiedWidget.Y1;
                
                const newWidget = {
                    ...copiedWidget,
                    X1: snapToGrid(centerX - widgetWidth / 2, gridSize.horizontal, snapEnabled),
                    Y1: snapToGrid(centerY - widgetHeight / 2, gridSize.vertical, snapEnabled),
                };
                newWidget.X2 = newWidget.X1 + widgetWidth;
                newWidget.Y2 = newWidget.Y1 + widgetHeight;
                
                if (newWidget.X2 > 10000) {
                    const overflow = newWidget.X2 - 10000;
                    newWidget.X1 -= overflow;
                    newWidget.X2 -= overflow;
                }
                if (newWidget.Y2 > 10000) {
                    const overflow = newWidget.Y2 - 10000;
                    newWidget.Y1 -= overflow;
                    newWidget.Y2 -= overflow;
                }
                
                const newConfigData = { ...configData };
                newConfigData.layout[orientation][pageIdx].widgets.push(newWidget);
                setConfigData(newConfigData);
                setSelectedWidget(newConfigData.layout[orientation][pageIdx].widgets.length - 1);
                setSelectedPage(pageIdx);
                pushHistory(newConfigData, `Collage ${getWidgetName(newWidget.CLASS)}`);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const duplicateWidget = () => {
                copyWidget();
                setTimeout(() => pasteWidget(), 10);
            };

            const addWidgetFromLibrary = (widgetKey) => {
                const template = WIDGET_LIBRARY[widgetKey];
                if (!template || selectedPage === null) return;
                
                // Taille par d√©faut : 2√ó2 cellules de grille
                const widgetWidth = gridSize.horizontal * 2;
                const widgetHeight = gridSize.vertical * 2;
                
                const centerX = 5000;
                const centerY = 5000;
                
                const newWidget = {
                    ...template,
                    X1: snapToGrid(centerX - widgetWidth / 2, gridSize.horizontal, true),
                    Y1: snapToGrid(centerY - widgetHeight / 2, gridSize.vertical, true),
                };
                newWidget.X2 = newWidget.X1 + widgetWidth;
                newWidget.Y2 = newWidget.Y1 + widgetHeight;
                
                const newConfigData = { ...configData };
                newConfigData.layout[orientation][selectedPage].widgets.push(newWidget);
                setConfigData(newConfigData);
                setSelectedWidget(newConfigData.layout[orientation][selectedPage].widgets.length - 1);
                pushHistory(newConfigData, `Ajout ${widgetKey}`);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const addNewPage = (pageType) => {
                const newConfigData = { ...configData };
                const newPage = {
                    CLASS: pageType.CLASS,
                    navigations: pageType.navigations,
                    widgets: []
                };
                newConfigData.layout[orientation].push(newPage);
                setConfigData(newConfigData);
                setSelectedPage(newConfigData.layout[orientation].length - 1);
                pushHistory(newConfigData, `Nouvelle page ${pageType.name}`);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const deletePage = (pageIdx) => {
                if (allPages.length <= 1) {
                    alert("Impossible de supprimer la derni√®re page !");
                    return;
                }
                
                const newConfigData = { ...configData };
                const pageName = getWidgetName(newConfigData.layout[orientation][pageIdx].CLASS);
                newConfigData.layout[orientation].splice(pageIdx, 1);
                setConfigData(newConfigData);
                setSelectedWidget(null);
                setSelectedPage(Math.max(0, pageIdx - 1));
                pushHistory(newConfigData, `Suppression page ${pageName}`);
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const movePageUp = (pageIdx) => {
                if (pageIdx === 0) return;
                
                const newConfigData = { ...configData };
                const pages = newConfigData.layout[orientation];
                [pages[pageIdx - 1], pages[pageIdx]] = [pages[pageIdx], pages[pageIdx - 1]];
                
                setConfigData(newConfigData);
                setSelectedPage(pageIdx - 1);
                pushHistory(newConfigData, 'R√©organisation pages');
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            const movePageDown = (pageIdx) => {
                if (pageIdx === allPages.length - 1) return;
                
                const newConfigData = { ...configData };
                const pages = newConfigData.layout[orientation];
                [pages[pageIdx], pages[pageIdx + 1]] = [pages[pageIdx + 1], pages[pageIdx]];
                
                setConfigData(newConfigData);
                setSelectedPage(pageIdx + 1);
                pushHistory(newConfigData, 'R√©organisation pages');
                localStorage.setItem('xctrackConfig', JSON.stringify(newConfigData));
            };

            // Fonction pour obtenir le contenu preview d'un widget
            const getWidgetPreview = (widgetClass, width, height) => {
                const widgetKey = widgetClass.split('.').pop(); // Extraire WSpeed, WAltitude, etc.
                const preview = WIDGET_PREVIEWS[widgetKey];
                
                if (!preview) return null;
                
                // Taille de police = 60% de la hauteur du widget * facteur de base
                const fontSize = Math.max(10, height * 0.6 * (preview.baseSize / 2.5)); // Normalis√© sur baseSize 2.5
                const unitSize = fontSize * 0.35;
                
                return { ...preview, fontSize, unitSize };
            };

            // Fonction pour trouver les widgets √† une position donn√©e (pour Ctrl+Click)
            const getWidgetsAtPosition = (pageIdx, clientX, clientY, screenRect) => {
                if (!allPages[pageIdx]) return [];
                
                const relX = ((clientX - screenRect.left) / screenRect.width) * 10000;
                const relY = ((clientY - screenRect.top) / screenRect.height) * 10000;
                
                const overlapping = [];
                allPages[pageIdx].widgets.forEach((widget, idx) => {
                    if (relX >= widget.X1 && relX <= widget.X2 && 
                        relY >= widget.Y1 && relY <= widget.Y2) {
                        overlapping.push(idx);
                    }
                });
                
                return overlapping;
            };

            // Gestion des raccourcis clavier
            useEffect(() => {
                const handleKeyDown = (e) => {
                    // Ignorer si on est dans un input/textarea
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                    
                    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                    const cmdOrCtrl = isMac ? e.metaKey : e.ctrlKey;
                    
                    if (cmdOrCtrl && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        undo();
                    } else if (cmdOrCtrl && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                        e.preventDefault();
                        redo();
                    } else if (cmdOrCtrl && e.key === 'c') {
                        e.preventDefault();
                        copyWidget();
                    } else if (cmdOrCtrl && e.key === 'v') {
                        e.preventDefault();
                        pasteWidget();
                    } else if (cmdOrCtrl && e.key === 'd') {
                        e.preventDefault();
                        duplicateWidget();
                    } else if (e.key === 'Delete' || e.key === 'Backspace') {
                        if (selectedWidget !== null && selectedPage !== null) {
                            e.preventDefault();
                            deleteWidget(selectedPage, selectedWidget);
                        }
                    }
                };
                
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [selectedWidget, selectedPage, copiedWidget, configData, orientation, historyIndex]);

            const exportConfig = () => {
                const dataStr = JSON.stringify(configData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'xctrack-layout-edited.xcfg';
                link.click();
            };

            if (!configData) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>XCTrack Layout Editor</h1>
                            <p>Visualisez et √©ditez vos layouts XCTrack</p>
                        </div>
                        <div className="viewer">
                            <div 
                                className={`drop-zone ${isDragOver ? 'drag-over' : ''}`}
                                onDrop={handleDrop}
                                onDragOver={handleDragOver}
                                onDragLeave={handleDragLeave}
                                onClick={() => fileInputRef.current?.click()}
                            >
                                <h2>üìÇ Chargez votre fichier de configuration</h2>
                                <p>Glissez-d√©posez votre fichier .xcfg ici<br/>ou cliquez pour parcourir</p>
                                <button>S√©lectionner un fichier</button>
                                <input 
                                    ref={fileInputRef}
                                    type="file" 
                                    accept=".xcfg,.json"
                                    onChange={handleFileUpload}
                                    style={{ display: 'none' }}
                                />
                            </div>
                        </div>
                    </div>
                );
            }

            console.log('Config loaded:', configData);
            console.log('Orientation:', orientation);
            console.log('All pages:', allPages);

            if (!allPages || allPages.length === 0) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1>XCTrack Layout Editor</h1>
                        </div>
                        <div style={{ 
                            background: '#fee2e2', 
                            border: '2px solid #ef4444', 
                            borderRadius: '8px', 
                            padding: '20px', 
                            color: '#991b1b', 
                            textAlign: 'center' 
                        }}>
                            <h2>Aucune page trouv√©e pour cette orientation</h2>
                            <button onClick={() => setConfigData(null)} style={{ marginTop: '20px' }}>
                                Charger un autre fichier
                            </button>
                        </div>
                    </div>
                );
            }

            const selectedWidgetData = (selectedWidget !== null && selectedPage !== null) 
                ? allPages[selectedPage]?.widgets[selectedWidget] 
                : null;

            return (
                <div className="container">
                    <div className="header">
                        <h1>XCTrack Layout Editor</h1>
                        <p>Visualisez et √©ditez vos layouts XCTrack</p>
                    </div>

                    <div className="main-layout">
                        <div className="sidebar">
                            <div className="controls">
                                <h3>‚öôÔ∏è Configuration</h3>

                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <button 
                                        onClick={undo}
                                        disabled={historyIndex <= 0}
                                        style={{ 
                                            flex: 1,
                                            opacity: historyIndex <= 0 ? 0.5 : 1,
                                            cursor: historyIndex <= 0 ? 'not-allowed' : 'pointer'
                                        }}
                                        title="Annuler (Ctrl+Z)"
                                    >
                                        ‚Ü∂ Undo
                                    </button>
                                    <button 
                                        onClick={redo}
                                        disabled={historyIndex >= history.length - 1}
                                        style={{ 
                                            flex: 1,
                                            opacity: historyIndex >= history.length - 1 ? 0.5 : 1,
                                            cursor: historyIndex >= history.length - 1 ? 'not-allowed' : 'pointer'
                                        }}
                                        title="R√©tablir (Ctrl+Y)"
                                    >
                                        ‚Ü∑ Redo
                                    </button>
                                </div>
                                
                                <div className="control-group">
                                    <label>R√©solution</label>
                                    <select 
                                        value={resolutionIndex} 
                                        onChange={(e) => setResolutionIndex(parseInt(e.target.value))}
                                    >
                                        {RESOLUTION_PRESETS.map((preset, idx) => (
                                            <option key={idx} value={idx}>
                                                {preset.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                <div className="control-group">
                                    <label>Orientation</label>
                                    <select 
                                        value={orientation} 
                                        onChange={(e) => {
                                            setOrientation(e.target.value);
                                            setSelectedWidget(null);
                                            setSelectedPage(0);
                                        }}
                                    >
                                        <option value="landscape">Paysage</option>
                                        <option value="portrait">Portrait</option>
                                    </select>
                                </div>

                                <div className="control-group checkbox">
                                    <input 
                                        type="checkbox" 
                                        id="showGrid"
                                        checked={showGrid}
                                        onChange={(e) => setShowGrid(e.target.checked)}
                                    />
                                    <label htmlFor="showGrid">
                                        Afficher la grille ({gridCols}√ó{gridRows})
                                    </label>
                                </div>

                                <div className="control-group checkbox">
                                    <input 
                                        type="checkbox" 
                                        id="snapEnabled"
                                        checked={snapEnabled}
                                        onChange={(e) => setSnapEnabled(e.target.checked)}
                                    />
                                    <label htmlFor="snapEnabled">
                                        Snap sur la grille
                                    </label>
                                </div>

                                <button 
                                    onClick={() => fileInputRef.current?.click()} 
                                    className="full-width import-btn"
                                >
                                    üìÇ Importer xcfg file
                                </button>
                                <input 
                                    ref={fileInputRef}
                                    type="file" 
                                    accept=".xcfg,.json"
                                    onChange={handleFileUpload}
                                    style={{ display: 'none' }}
                                />

                                <button onClick={exportConfig} className="full-width export-btn">
                                    üíæ Exporter xcfg file
                                </button>
                            </div>

                            {/* Biblioth√®que de widgets */}
                            <div className="widget-library">
                                <h3 style={{ cursor: 'pointer' }} onClick={() => setShowWidgetLibrary(!showWidgetLibrary)}>
                                    üìö Biblioth√®que de widgets {showWidgetLibrary ? '‚ñº' : '‚ñ∂'}
                                </h3>
                                {showWidgetLibrary && (
                                    <div className="widget-library-grid">
                                        {/* Data/Metrics */}
                                        <div style={{ 
                                            fontWeight: 'bold', 
                                            color: '#374151', 
                                            marginTop: '10px',
                                            marginBottom: '5px',
                                            fontSize: '0.9rem',
                                            borderBottom: '1px solid #e5e7eb',
                                            paddingBottom: '3px'
                                        }}>
                                            üìä Data / Metrics
                                        </div>
                                        {['WAltitude', 'WAltitudeAboveGround', 'WAltitudeMaximum', 'WSpeed', 'WXCSpeed', 'WVerticalSpeed', 'WGlide', 'WWindSpeed', 'WTime', 'WAirTime'].map(widgetKey => {
                                            const displayName = widgetKey.startsWith('W') ? widgetKey.substring(1) : widgetKey;
                                            return (
                                                <div
                                                    key={widgetKey}
                                                    className="widget-library-item"
                                                    onClick={() => addWidgetFromLibrary(widgetKey)}
                                                    title={`Cliquer pour ajouter ${displayName}`}
                                                >
                                                    + {displayName}
                                                </div>
                                            );
                                        })}

                                        {/* Navigation */}
                                        <div style={{ 
                                            fontWeight: 'bold', 
                                            color: '#374151', 
                                            marginTop: '15px',
                                            marginBottom: '5px',
                                            fontSize: '0.9rem',
                                            borderBottom: '1px solid #e5e7eb',
                                            paddingBottom: '3px'
                                        }}>
                                            üéØ Navigation
                                        </div>
                                        {['WNextTurnpointDistance', 'WNextTurnpointAlt', 'WNextTurnpointGlideTo', 'WNextTurnpointTimeOfArrival'].map(widgetKey => {
                                            const displayName = widgetKey.startsWith('W') ? widgetKey.substring(1) : widgetKey;
                                            return (
                                                <div
                                                    key={widgetKey}
                                                    className="widget-library-item"
                                                    onClick={() => addWidgetFromLibrary(widgetKey)}
                                                    title={`Cliquer pour ajouter ${displayName}`}
                                                >
                                                    + {displayName}
                                                </div>
                                            );
                                        })}

                                        {/* Competition */}
                                        <div style={{ 
                                            fontWeight: 'bold', 
                                            color: '#374151', 
                                            marginTop: '15px',
                                            marginBottom: '5px',
                                            fontSize: '0.9rem',
                                            borderBottom: '1px solid #e5e7eb',
                                            paddingBottom: '3px'
                                        }}>
                                            üèÅ Competition
                                        </div>
                                        {['WCompDistanceToGoal', 'WCompGlideToGoal', 'WCompAltitudeOverGoal', 'WCompTimeToStart', 'WCompTimeAtStart'].map(widgetKey => {
                                            const displayName = widgetKey.startsWith('W') ? widgetKey.substring(1) : widgetKey;
                                            return (
                                                <div
                                                    key={widgetKey}
                                                    className="widget-library-item"
                                                    onClick={() => addWidgetFromLibrary(widgetKey)}
                                                    title={`Cliquer pour ajouter ${displayName}`}
                                                >
                                                    + {displayName}
                                                </div>
                                            );
                                        })}

                                        {/* Maps/Visual */}
                                        <div style={{ 
                                            fontWeight: 'bold', 
                                            color: '#374151', 
                                            marginTop: '15px',
                                            marginBottom: '5px',
                                            fontSize: '0.9rem',
                                            borderBottom: '1px solid #e5e7eb',
                                            paddingBottom: '3px'
                                        }}>
                                            üó∫Ô∏è Maps / Visual
                                        </div>
                                        {['WXCAssistant', 'WThermalAssistant', 'WCompMap', 'WCompass', 'WSideView', 'WAltitudeDataGraph'].map(widgetKey => {
                                            const displayName = widgetKey.startsWith('W') ? widgetKey.substring(1) : widgetKey;
                                            return (
                                                <div
                                                    key={widgetKey}
                                                    className="widget-library-item"
                                                    onClick={() => addWidgetFromLibrary(widgetKey)}
                                                    title={`Cliquer pour ajouter ${displayName}`}
                                                >
                                                    + {displayName}
                                                </div>
                                            );
                                        })}

                                        {/* Graphs/Stats */}
                                        <div style={{ 
                                            fontWeight: 'bold', 
                                            color: '#374151', 
                                            marginTop: '15px',
                                            marginBottom: '5px',
                                            fontSize: '0.9rem',
                                            borderBottom: '1px solid #e5e7eb',
                                            paddingBottom: '3px'
                                        }}>
                                            üìà Graphs / Stats
                                        </div>
                                        {['WVerticalGraph', 'WThermalAltGain', 'WOptiResult'].map(widgetKey => {
                                            const displayName = widgetKey.startsWith('W') ? widgetKey.substring(1) : widgetKey;
                                            return (
                                                <div
                                                    key={widgetKey}
                                                    className="widget-library-item"
                                                    onClick={() => addWidgetFromLibrary(widgetKey)}
                                                    title={`Cliquer pour ajouter ${displayName}`}
                                                >
                                                    + {displayName}
                                                </div>
                                            );
                                        })}

                                        {/* UI/Controls */}
                                        <div style={{ 
                                            fontWeight: 'bold', 
                                            color: '#374151', 
                                            marginTop: '15px',
                                            marginBottom: '5px',
                                            fontSize: '0.9rem',
                                            borderBottom: '1px solid #e5e7eb',
                                            paddingBottom: '3px'
                                        }}>
                                            ‚öôÔ∏è UI / Controls
                                        </div>
                                        {['WStatusLine', 'WFreeText', 'WButtonZoom', 'WButtonNavig', 'WAirspaceProximity'].map(widgetKey => {
                                            const displayName = widgetKey.startsWith('W') ? widgetKey.substring(1) : widgetKey;
                                            return (
                                                <div
                                                    key={widgetKey}
                                                    className="widget-library-item"
                                                    onClick={() => addWidgetFromLibrary(widgetKey)}
                                                    title={`Cliquer pour ajouter ${displayName}`}
                                                >
                                                    + {displayName}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>

                            {/* Gestion des pages */}
                            <div className="page-management">
                                <h3>üìÑ Pages</h3>
                                <div className="page-type-buttons">
                                    {PAGE_TYPES.map((pageType, idx) => (
                                        <button
                                            key={idx}
                                            className="page-type-btn"
                                            onClick={() => addNewPage(pageType)}
                                        >
                                            ‚ûï {pageType.name}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Info widget s√©lectionn√© */}
                            <div className="widget-info-panel">
                                <h3>üì¶ Widget s√©lectionn√©</h3>
                                {selectedWidgetData ? (
                                    <>
                                        <h4>{getWidgetName(selectedWidgetData.CLASS)}</h4>
                                        <div className="coords">
                                            <div>X1: {selectedWidgetData.X1}</div>
                                            <div>Y1: {selectedWidgetData.Y1}</div>
                                            <div>X2: {selectedWidgetData.X2}</div>
                                            <div>Y2: {selectedWidgetData.Y2}</div>
                                        </div>
                                        <div className="action-buttons">
                                            <button onClick={copyWidget}>
                                                üìã Copier (Ctrl+C)
                                            </button>
                                            <button onClick={duplicateWidget}>
                                                üìë Dupliquer (Ctrl+D)
                                            </button>
                                            <button 
                                                className="delete-btn"
                                                onClick={() => deleteWidget(selectedPage, selectedWidget)}
                                            >
                                                üóëÔ∏è Supprimer (Del)
                                            </button>
                                            <button onClick={() => setSelectedWidget(null)}>
                                                ‚úï D√©s√©lectionner
                                            </button>
                                        </div>
                                    </>
                                ) : (
                                    <div className="no-selection">
                                        {copiedWidget ? (
                                            <>
                                                <p>Widget copi√© : <strong>{getWidgetName(copiedWidget.CLASS)}</strong></p>
                                                <button 
                                                    onClick={() => pasteWidget()}
                                                    style={{ marginTop: '10px' }}
                                                >
                                                    üìã Coller au centre (Ctrl+V)
                                                </button>
                                            </>
                                        ) : (
                                            <>
                                                Aucun widget s√©lectionn√©.<br/>
                                                Cliquez sur un widget pour le modifier.
                                            </>
                                        )}
                                    </div>
                                )}
                                {/* Tip toujours visible */}
                                <div style={{
                                    marginTop: '10px',
                                    padding: '8px',
                                    background: '#eff6ff',
                                    borderRadius: '6px',
                                    fontSize: '0.85rem',
                                    color: '#1e40af'
                                }}>
                                    üí° Astuce : Utilisez <strong>Ctrl+Clic</strong> pour s√©lectionner des widgets superpos√©s
                                </div>
                            </div>

                            <div className="stats">
                                <div className="stat">
                                    <span>Total pages:</span>
                                    <strong>{allPages.length}</strong>
                                </div>
                                <div className="stat">
                                    <span>Total widgets:</span>
                                    <strong>{allPages.reduce((sum, page) => sum + (page.widgets?.length || 0), 0)}</strong>
                                </div>
                            </div>
                        </div>

                        <div className="viewer">
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '30px', alignItems: 'center' }}>
                                {allPages.map((page, pageIdx) => (
                                    <div key={pageIdx} style={{ 
                                        display: 'flex',
                                        flexDirection: 'column',
                                        alignItems: 'center',
                                        gap: '15px'
                                    }}>
                                        {/* Titre et boutons */}
                                        <div style={{ 
                                            display: 'flex', 
                                            alignItems: 'center', 
                                            justifyContent: 'center',
                                            gap: '10px',
                                            width: '100%'
                                        }}>
                                            <h3 style={{ 
                                                color: '#374151', 
                                                fontSize: '1.2rem',
                                                margin: 0
                                            }}>
                                                Page {pageIdx + 1} - {getWidgetName(page.CLASS)}
                                                <span style={{ 
                                                    fontSize: '0.9rem', 
                                                    color: '#6b7280',
                                                    marginLeft: '10px'
                                                }}>
                                                    ({page.widgets?.length || 0} widgets)
                                                </span>
                                            </h3>
                                            <div style={{ display: 'flex', gap: '8px' }}>
                                                <button
                                                    onClick={() => movePageUp(pageIdx)}
                                                    disabled={pageIdx === 0}
                                                    style={{
                                                        padding: '6px 12px',
                                                        background: pageIdx === 0 ? '#d1d5db' : '#3b82f6',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: pageIdx === 0 ? 'not-allowed' : 'pointer',
                                                        fontWeight: '600',
                                                        fontSize: '0.9rem'
                                                    }}
                                                    title="Monter la page"
                                                >
                                                    ‚Üë
                                                </button>
                                                <button
                                                    onClick={() => movePageDown(pageIdx)}
                                                    disabled={pageIdx === allPages.length - 1}
                                                    style={{
                                                        padding: '6px 12px',
                                                        background: pageIdx === allPages.length - 1 ? '#d1d5db' : '#3b82f6',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: pageIdx === allPages.length - 1 ? 'not-allowed' : 'pointer',
                                                        fontWeight: '600',
                                                        fontSize: '0.9rem'
                                                    }}
                                                    title="Descendre la page"
                                                >
                                                    ‚Üì
                                                </button>
                                                <button
                                                    onClick={() => deletePage(pageIdx)}
                                                    style={{
                                                        padding: '6px 12px',
                                                        background: '#ef4444',
                                                        color: 'white',
                                                        border: 'none',
                                                        borderRadius: '6px',
                                                        cursor: 'pointer',
                                                        fontWeight: '600',
                                                        fontSize: '0.9rem',
                                                        whiteSpace: 'nowrap'
                                                    }}
                                                    title="Supprimer cette page"
                                                >
                                                    üóëÔ∏è
                                                </button>
                                            </div>
                                        </div>
                                        
                                        {/* Phone container - centr√© ind√©pendamment */}
                                        <div className="phone-container">
                                            <div 
                                                className="phone-screen"
                                                style={{
                                                    width: `${screenDimensions.width}px`,
                                                    height: `${screenDimensions.height}px`,
                                                    cursor: 'default'
                                                }}
                                                onClick={() => {
                                                    setSelectedWidget(null);
                                                    setSelectedPage(pageIdx);
                                                }}
                                            >
                                                {showGrid && (
                                                    <div className="grid-overlay">
                                                        {Array.from({ length: gridCols + 1 }).map((_, i) => (
                                                            <div
                                                                key={`v${i}`}
                                                                className="grid-line vertical"
                                                                style={{ left: `${(i / gridCols) * 100}%` }}
                                                            />
                                                        ))}
                                                        {Array.from({ length: gridRows + 1 }).map((_, i) => (
                                                            <div
                                                                key={`h${i}`}
                                                                className="grid-line horizontal"
                                                                style={{ top: `${(i / gridRows) * 100}%` }}
                                                            />
                                                        ))}
                                                    </div>
                                                )}

                                                {page.widgets?.map((widget, idx) => {
                                                    const x = (widget.X1 / 10000) * screenDimensions.width;
                                                    const y = (widget.Y1 / 10000) * screenDimensions.height;
                                                    const width = ((widget.X2 - widget.X1) / 10000) * screenDimensions.width;
                                                    const height = ((widget.Y2 - widget.Y1) / 10000) * screenDimensions.height;
                                                    const isSelected = selectedWidget === idx && selectedPage === pageIdx;
                                                    
                                                    // Obtenir le preview
                                                    const preview = getWidgetPreview(widget.CLASS, width, height);

                                                    return (
                                                        <div
                                                            key={idx}
                                                            className={`widget ${isSelected ? 'selected' : ''}`}
                                                            style={{
                                                                left: `${x}px`,
                                                                top: `${y}px`,
                                                                width: `${width}px`,
                                                                height: `${height}px`,
                                                                cursor: 'pointer',
                                                                zIndex: isSelected ? 100 : 10
                                                            }}
                                                            title={widget.CLASS}
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                
                                                                // Ctrl+Click: cycle through overlapping widgets
                                                                if (e.ctrlKey || e.metaKey) {
                                                                    const rect = e.currentTarget.closest('.phone-screen').getBoundingClientRect();
                                                                    const overlapping = getWidgetsAtPosition(pageIdx, e.clientX, e.clientY, rect);
                                                                    
                                                                    if (overlapping.length > 1) {
                                                                        // Trouver l'index actuel et passer au suivant
                                                                        const currentIdx = overlapping.indexOf(selectedWidget);
                                                                        const nextIdx = (currentIdx + 1) % overlapping.length;
                                                                        setSelectedWidget(overlapping[nextIdx]);
                                                                        setSelectedPage(pageIdx);
                                                                        return;
                                                                    }
                                                                }
                                                                
                                                                // Click normal
                                                                setSelectedWidget(idx);
                                                                setSelectedPage(pageIdx);
                                                            }}
                                                        >
                                                            {/* Label du widget en haut √† gauche */}
                                                            <div className="widget-label">
                                                                {getWidgetName(widget.CLASS)}
                                                            </div>

                                                            {/* Preview du contenu */}
                                                            {preview && (
                                                                <div style={{
                                                                    position: 'absolute',
                                                                    top: 0,
                                                                    left: 0,
                                                                    width: '100%',
                                                                    height: '100%',
                                                                    display: 'flex',
                                                                    flexDirection: 'column',
                                                                    alignItems: 'center',
                                                                    justifyContent: 'center',
                                                                    pointerEvents: 'none'
                                                                }}>
                                                                    {preview.icon ? (
                                                                        <div style={{ fontSize: `${preview.fontSize}px` }}>
                                                                            {preview.icon}
                                                                        </div>
                                                                    ) : (
                                                                        <>
                                                                            <div style={{
                                                                                display: 'flex',
                                                                                alignItems: 'center',
                                                                                gap: '6px'
                                                                            }}>
                                                                                <div style={{
                                                                                    fontSize: `${preview.fontSize}px`,
                                                                                    fontWeight: 'bold',
                                                                                    color: '#374151',
                                                                                    lineHeight: 1
                                                                                }}>
                                                                                    {preview.text}
                                                                                </div>
                                                                                {preview.unit && (
                                                                                    preview.unit.includes('/') ? (
                                                                                        // Affichage fraction verticale pour km/h, m/s, etc.
                                                                                        <div style={{
                                                                                            display: 'flex',
                                                                                            flexDirection: 'column',
                                                                                            alignItems: 'center',
                                                                                            fontSize: `${preview.unitSize}px`,
                                                                                            color: '#6b7280',
                                                                                            lineHeight: 0.8,
                                                                                            gap: '1px'
                                                                                        }}>
                                                                                            <div>{preview.unit.split('/')[0]}</div>
                                                                                            <div style={{ 
                                                                                                borderTop: '1px solid #6b7280',
                                                                                                width: '100%',
                                                                                                margin: '0'
                                                                                            }}></div>
                                                                                            <div>{preview.unit.split('/')[1]}</div>
                                                                                        </div>
                                                                                    ) : (
                                                                                        // Affichage simple pour m, km, etc.
                                                                                        <div style={{
                                                                                            fontSize: `${preview.unitSize}px`,
                                                                                            color: '#6b7280',
                                                                                            lineHeight: 1
                                                                                        }}>
                                                                                            {preview.unit}
                                                                                        </div>
                                                                                    )
                                                                                )}
                                                                            </div>
                                                                            {preview.subtext && (
                                                                                <div style={{
                                                                                    fontSize: `${preview.unitSize}px`,
                                                                                    color: '#9ca3af',
                                                                                    marginTop: '4px'
                                                                                }}>
                                                                                    {preview.subtext}
                                                                                </div>
                                                                            )}
                                                                        </>
                                                                    )}
                                                                </div>
                                                            )}

                                                            {isSelected && (
                                                                <>
                                                                    <div 
                                                                        className="resize-handle nw"
                                                                        onMouseDown={(e) => handleMouseDown(e, pageIdx, idx, 'nw')}
                                                                    />
                                                                    <div 
                                                                        className="resize-handle ne"
                                                                        onMouseDown={(e) => handleMouseDown(e, pageIdx, idx, 'ne')}
                                                                    />
                                                                    <div 
                                                                        className="resize-handle sw"
                                                                        onMouseDown={(e) => handleMouseDown(e, pageIdx, idx, 'sw')}
                                                                    />
                                                                    <div 
                                                                        className="resize-handle se"
                                                                        onMouseDown={(e) => handleMouseDown(e, pageIdx, idx, 'se')}
                                                                    />
                                                                    
                                                                    <div 
                                                                        className="move-handle"
                                                                        onMouseDown={(e) => handleMouseDown(e, pageIdx, idx, 'move')}
                                                                    />
                                                                </>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Toast de notification undo/redo */}
                    {undoMessage && (
                        <div className="undo-toast">
                            {undoMessage}
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<XCTrackViewer />, document.getElementById('root'));
    </script>
</body>
</html>