<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XCTrack Layout Library</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --sky: #0ea5e9;
            --sky-dim: #0284c7;
            --horizon: #1e3a5f;
            --deep: #0a1628;
            --deeper: #060d1a;
            --card: #111d2e;
            --card-hover: #162540;
            --border: rgba(14, 165, 233, 0.15);
            --text: #e2eaf5;
            --text-dim: #7a9bbf;
            --cross: #34d399;
            --compete: #f59e0b;
            --casual: #a78bfa;
            --experimental: #fb7185;
            --tag-radius: 4px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: var(--deeper);
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Atmospheric background */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 400px;
            background: radial-gradient(ellipse at 50% -20%, rgba(14,165,233,0.12) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        /* Header */
        header {
            position: relative;
            z-index: 10;
            padding: 40px 60px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 20px;
        }

        .logo {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .logo-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3.5rem;
            letter-spacing: 3px;
            color: #fff;
            line-height: 1;
        }

        .logo-title span {
            color: var(--sky);
        }

        .logo-sub {
            font-size: 0.85rem;
            color: var(--text-dim);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .lang-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .lang-btn:hover {
            border-color: var(--sky);
            color: var(--sky);
        }

        .editor-btn {
            background: var(--sky);
            border: none;
            color: #fff;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .editor-btn:hover { background: var(--sky-dim); }

        /* Stats bar */
        .stats-bar {
            position: relative;
            z-index: 10;
            display: flex;
            gap: 40px;
            padding: 20px 60px;
            border-bottom: 1px solid var(--border);
            background: rgba(10, 22, 40, 0.5);
        }

        .stat {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            color: var(--sky);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Controls */
        .controls {
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 24px 60px;
            flex-wrap: wrap;
        }

        .sort-group {
            display: flex;
            gap: 6px;
        }

        .sort-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.85rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .sort-btn.active, .sort-btn:hover {
            border-color: var(--sky);
            color: var(--sky);
            background: rgba(14, 165, 233, 0.08);
        }

        .divider {
            width: 1px;
            height: 30px;
            background: var(--border);
        }

        .tag-filters {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tag-btn {
            background: transparent;
            border: 1px solid;
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s;
            opacity: 0.5;
        }

        .tag-btn[data-tag="cross"]        { border-color: var(--cross); color: var(--cross); }
        .tag-btn[data-tag="compete"]      { border-color: var(--compete); color: var(--compete); }
        .tag-btn[data-tag="casual"]       { border-color: var(--casual); color: var(--casual); }
        .tag-btn[data-tag="experimental"] { border-color: var(--experimental); color: var(--experimental); }

        .tag-btn.active { opacity: 1; }
        .tag-btn[data-tag="cross"].active        { background: rgba(52,211,153,0.12); }
        .tag-btn[data-tag="compete"].active      { background: rgba(245,158,11,0.12); }
        .tag-btn[data-tag="casual"].active       { background: rgba(167,139,250,0.12); }
        .tag-btn[data-tag="experimental"].active { background: rgba(251,113,133,0.12); }

        .mode-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 6px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            transition: all 0.2s;
            margin-left: 4px;
        }
        .mode-btn:hover, .mode-btn.and { border-color: var(--sky); color: var(--sky); background: rgba(14,165,233,0.08); }

        /* Grid */
        .grid-container {
            position: relative;
            z-index: 10;
            padding: 0 60px 60px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        /* Card */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.25s;
            animation: fadeUp 0.4s ease both;
        }

        .card:hover {
            background: var(--card-hover);
            border-color: rgba(14, 165, 233, 0.35);
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 0 1px rgba(14,165,233,0.1);
        }

        .card-thumb {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            display: block;
            background: var(--deep);
        }

        .card-thumb-placeholder {
            width: 100%;
            aspect-ratio: 16/9;
            background: var(--deep);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--text-dim);
            opacity: 0.3;
        }

        .card-body {
            padding: 14px 16px;
        }

        .card-name {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .card-author {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 10px;
        }

        .card-tags {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .tag-pill {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: var(--tag-radius);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tag-pill.cross        { background: rgba(52,211,153,0.15); color: var(--cross); }
        .tag-pill.compete      { background: rgba(245,158,11,0.15); color: var(--compete); }
        .tag-pill.casual       { background: rgba(167,139,250,0.15); color: var(--casual); }
        .tag-pill.experimental { background: rgba(251,113,133,0.15); color: var(--experimental); }
        .tag-pill.versatile    { background: rgba(14,165,233,0.15); color: var(--sky); }

        .card-stats {
            display: flex;
            gap: 14px;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .card-stats span { display: flex; align-items: center; gap: 4px; }

        /* Top contributors */
        .contributors {
            position: relative;
            z-index: 10;
            padding: 0 60px 40px;
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.4rem;
            letter-spacing: 2px;
            color: var(--text-dim);
            margin-bottom: 16px;
        }

        .contributors-list {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .contributor {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.85rem;
        }

        .contributor-rank {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.1rem;
            color: var(--sky);
            width: 20px;
        }

        .contributor-name { font-weight: 500; }
        .contributor-count { color: var(--text-dim); font-size: 0.8rem; }

        /* Loading */
        .loading {
            text-align: center;
            padding: 80px;
            color: var(--text-dim);
            font-size: 0.9rem;
            grid-column: 1/-1;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 2px solid var(--border);
            border-top-color: var(--sky);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(6, 13, 26, 0.92);
            backdrop-filter: blur(8px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .modal-overlay.visible { opacity: 1; }

        .modal {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.2s;
        }

        .modal-overlay.visible .modal { transform: translateY(0); }

        .nav-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(14, 165, 233, 0.15);
            border: 1px solid rgba(14, 165, 233, 0.3);
            color: var(--sky);
            font-size: 3rem;
            line-height: 1;
            width: 52px;
            height: 80px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 101;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-arrow:hover { background: rgba(14, 165, 233, 0.3); }
        .nav-arrow:disabled { opacity: 0.15; cursor: default; pointer-events: none; }
        .nav-arrow-left  { left: 12px; }
        .nav-arrow-right { right: 12px; }

        .modal-nav-info {
            font-size: 0.75rem;
            color: var(--text-dim);
            text-align: right;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .modal-thumb {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            background: var(--deep);
            border-radius: 12px 12px 0 0;
            display: block;
            cursor: zoom-in;
        }

        .modal-thumb.zoomed { cursor: zoom-out; max-height: none; }

        .modal-body { padding: 28px; }

        .modal-name {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 2px;
            margin-bottom: 6px;
        }

        .modal-meta {
            color: var(--text-dim);
            font-size: 0.85rem;
            margin-bottom: 16px;
        }

        .modal-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }

        .modal-stats {
            display: flex;
            gap: 24px;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .warning-box {
            background: rgba(245, 158, 11, 0.08);
            border: 1px solid rgba(245, 158, 11, 0.25);
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 0.85rem;
            color: #fbbf24;
            margin-bottom: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-ghost {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
        }

        .btn-ghost:hover { border-color: var(--text-dim); color: var(--text); }

        .btn-primary {
            background: var(--sky);
            color: white;
        }

        .btn-primary:hover { background: var(--sky-dim); }

        .btn-danger {
            background: rgba(251,113,133,0.12);
            border: 1px solid rgba(251,113,133,0.3);
            color: #fb7185;
        }

        .btn-danger:hover { background: rgba(251,113,133,0.2); }

        .btn-vote {
            background: rgba(14,165,233,0.08);
            border: 1px solid rgba(14,165,233,0.25);
            color: var(--sky);
            min-width: 80px;
        }

        .btn-vote:hover { background: rgba(14,165,233,0.15); }
        .btn-vote.voted { background: rgba(14,165,233,0.2); border-color: var(--sky); font-weight: 600; }

        .edit-tag-btn {
            padding: 5px 12px;
            border-radius: 4px;
            border: 1px solid;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: transparent;
            opacity: 0.35;
            transition: all 0.15s;
        }
        .edit-tag-btn.active { opacity: 1; }
        .edit-tag-btn[data-tag="cross"]        { border-color: var(--cross); color: var(--cross); }
        .edit-tag-btn[data-tag="compete"]      { border-color: var(--compete); color: var(--compete); }
        .edit-tag-btn[data-tag="casual"]       { border-color: var(--casual); color: var(--casual); }
        .edit-tag-btn[data-tag="experimental"] { border-color: var(--experimental); color: var(--experimental); }
        .edit-tag-btn[data-tag="cross"].active        { background: rgba(52,211,153,0.12); }
        .edit-tag-btn[data-tag="compete"].active      { background: rgba(245,158,11,0.12); }
        .edit-tag-btn[data-tag="casual"].active       { background: rgba(167,139,250,0.12); }
        .edit-tag-btn[data-tag="experimental"].active { background: rgba(251,113,133,0.12); }

        /* Empty state */
        .empty {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-dim);
            grid-column: 1/-1;
        }

        .empty-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.4; }
        .empty-text { font-size: 0.9rem; }

        /* Animations */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(16px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .card:nth-child(1)  { animation-delay: 0.05s; }
        .card:nth-child(2)  { animation-delay: 0.10s; }
        .card:nth-child(3)  { animation-delay: 0.15s; }
        .card:nth-child(4)  { animation-delay: 0.20s; }
        .card:nth-child(5)  { animation-delay: 0.25s; }
        .card:nth-child(6)  { animation-delay: 0.30s; }
        .card:nth-child(7)  { animation-delay: 0.35s; }
        .card:nth-child(8)  { animation-delay: 0.40s; }
        .card:nth-child(9)  { animation-delay: 0.45s; }
        .card:nth-child(10) { animation-delay: 0.50s; }
        .card:nth-child(11) { animation-delay: 0.55s; }
        .card:nth-child(12) { animation-delay: 0.60s; }

        /* Upload button */
        .upload-btn {
            background: var(--cross);
            border: none;
            color: #000;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            margin-right: 12px;
        }
        
        .upload-btn:hover { 
            background: #22c55e;
        }

        /* Upload Modal */
        .upload-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .upload-modal.active { display: flex; }
        
        .upload-modal-content {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 500px;
            width: 100%;
            padding: 30px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .upload-modal h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 2px;
            color: var(--sky);
            margin-bottom: 20px;
        }
        
        .upload-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .upload-modal-close:hover { color: var(--text); }
        
        .upload-form-group {
            margin-bottom: 20px;
        }
        
        .upload-form-group label {
            display: block;
            color: var(--text-dim);
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .upload-form-group input[type="text"] {
            width: 100%;
            background: var(--deeper);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 12px;
            color: var(--text);
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
        }
        
        .upload-form-group input[type="text"]:focus {
            outline: none;
            border-color: var(--sky);
        }
        
        .upload-file-drop {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--deeper);
        }
        
        .upload-file-drop:hover,
        .upload-file-drop.drag-over {
            border-color: var(--sky);
            background: rgba(14,165,233,0.05);
        }
        
        .upload-file-drop.has-file {
            border-color: var(--cross);
            background: rgba(52,211,153,0.05);
        }
        
        .upload-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .upload-tag-checkbox {
            display: none;
        }
        
        .upload-tag-label {
            padding: 8px 16px;
            border-radius: var(--tag-radius);
            border: 1px solid var(--border);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            background: var(--deeper);
        }
        
        .upload-tag-checkbox:checked + .upload-tag-label {
            border-color: currentColor;
            font-weight: 600;
            border-width: 2px;
        }
        
        .upload-tag-label[data-tag="cross"] { color: var(--cross); }
        .upload-tag-label[data-tag="compete"] { color: var(--compete); }
        .upload-tag-label[data-tag="casual"] { color: var(--casual); }
        .upload-tag-label[data-tag="experimental"] { color: var(--experimental); }
        
        .upload-submit {
            width: 100%;
            background: var(--sky);
            border: none;
            color: white;
            padding: 14px;
            border-radius: 6px;
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 20px;
        }
        
        .upload-submit:hover {
            background: var(--sky-dim);
            transform: translateY(-2px);
        }
        
        .upload-submit:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }
        
        .upload-error {
            background: rgba(239,68,68,0.1);
            border: 1px solid #ef4444;
            border-radius: 6px;
            padding: 12px;
            color: #ef4444;
            margin-top: 16px;
            display: none;
        }
        
        .upload-error.active { display: block; }

        @media (max-width: 768px) {
            header, .stats-bar, .controls, .grid-container, .contributors {
                padding-left: 20px;
                padding-right: 20px;
            }
            .logo-title { font-size: 2.2rem; }
            .grid { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); }
        }
    </style>
</head>
<body>

<header>
    <div class="logo">
        <div class="logo-title">XCTRACK <span>LIBRARY</span></div>
        <div class="logo-sub" id="logo-sub">Community Layout Configs</div>
    </div>
    <div class="header-right">
        <button class="lang-btn" id="langBtn" onclick="toggleLang()">üá¨üáß EN</button>
        <button class="upload-btn" onclick="openUploadModal()">
            üì§ <span id="uploadBtnLabel">Uploader ma config</span>
        </button>
        <a href="./editor.html" class="editor-btn" target="_blank" rel="noopener noreferrer">
            ‚úèÔ∏è <span id="editorBtnLabel">Ouvrir l'√©diteur</span>
        </a>
    </div>
</header>

<div class="stats-bar">
    <div class="stat">
        <div class="stat-value" id="totalConfigs">‚Äî</div>
        <div class="stat-label" id="labelConfigs">Configurations</div>
    </div>
    <div class="stat">
        <div class="stat-value" id="totalContributors">‚Äî</div>
        <div class="stat-label" id="labelContributors">Contributeurs</div>
    </div>
    <div class="stat">
        <div class="stat-value" id="totalDownloads">‚Äî</div>
        <div class="stat-label" id="labelDownloads">T√©l√©chargements</div>
    </div>
</div>

<div class="controls">
    <div class="sort-group">
        <button class="sort-btn active" data-sort="upvotes" onclick="setSort('upvotes')">üî• <span class="i18n-popular">Populaire</span></button>
        <button class="sort-btn" data-sort="created_at" onclick="setSort('created_at')">‚≠ê <span class="i18n-recent">R√©cent</span></button>
        <button class="sort-btn" data-sort="downloads" onclick="setSort('downloads')">‚¨áÔ∏è <span class="i18n-downloads">T√©l√©charg√©</span></button>
    </div>
    <div class="divider"></div>
    <div class="tag-filters">
        <button class="tag-btn" data-tag="cross"        onclick="toggleTagFilter('cross')">üèîÔ∏è Cross</button>
        <button class="tag-btn" data-tag="compete"      onclick="toggleTagFilter('compete')">üèÅ <span class="i18n-compete">Comp√©tition</span></button>
        <button class="tag-btn" data-tag="casual"       onclick="toggleTagFilter('casual')">‚òÄÔ∏è <span class="i18n-casual">Loisir</span></button>
        <button class="tag-btn" data-tag="experimental" onclick="toggleTagFilter('experimental')">üÜï <span class="i18n-experimental">Exp√©rimental</span></button>
    </div>
    <button class="mode-btn" id="tagModeBtn" onclick="toggleTagMode()" title="OR = any tag matches / AND = all tags required">
        <span id="tagModeLabel">OR</span>
    </button>
</div>

<div class="contributors" id="contributorsSection" style="display:none">
    <div class="section-title" id="topContribLabel">üèÜ TOP CONTRIBUTEURS</div>
    <div class="contributors-list" id="contributorsList"></div>
</div>

<div class="grid-container">
    <div class="grid" id="grid">
        <div class="loading"><div class="spinner"></div><div id="loadingText">Chargement...</div></div>
    </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOnBg(event)">
    <button class="nav-arrow nav-arrow-left" id="arrowLeft" onclick="navigateModal(-1)">&#8249;</button>
    <div class="modal" id="modal">
        <img id="modalThumb" class="modal-thumb" src="" alt="" onclick="toggleZoom(this)" style="display:none"/>
        <div class="modal-body">
            <div class="modal-nav-info" id="modalNavInfo"></div>
            <div class="modal-name" id="modalName"></div>
            <div class="modal-meta" id="modalMeta"></div>
            <div class="modal-tags" id="modalTags"></div>
            <div id="editTagsSection" style="display:none; margin-bottom:16px;">
                <div style="font-size:0.75rem; color:var(--text-dim); margin-bottom:8px; text-transform:uppercase; letter-spacing:1px;">Modifier les tags</div>
                <div id="editTagsBtns" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
            </div>
            <div class="modal-stats" id="modalStats"></div>
            <div class="warning-box" id="warningBox"></div>
            <div class="modal-actions">
                <button class="btn btn-ghost" onclick="closeModal()" id="btnClose">Fermer</button>
                <button class="btn btn-vote" id="btnVote" onclick="toggleVote()">üëç <span id="btnVoteCount">0</span></button>
                <button class="btn btn-danger" id="btnDelete" style="display:none" onclick="deleteConfig()">üóëÔ∏è</button>
                <button class="btn btn-primary" onclick="loadInEditor()" id="btnLoad">‚¨áÔ∏è <span id="btnLoadLabel">Charger dans l'√©diteur</span></button>
            </div>
        </div>
    </div>
    <button class="nav-arrow nav-arrow-right" id="arrowRight" onclick="navigateModal(1)">&#8250;</button>
</div>

<script>
    const SUPABASE_URL = 'https://ovhbpujablpfunnpkuxh.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92aGJwdWphYmxwZnVubnBrdXhoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MDE2MDIsImV4cCI6MjA4NjQ3NzYwMn0.3wKwiUyUMOKR3RFIlFPlLFiQFwrH6aOf7NQ8OKvLZ0U';
    const EDITOR_URL = './editor.html';
    const ADMIN_EMAIL = 'thrombose@gmail.com';

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let lang = localStorage.getItem('xctrackLang') || (navigator.language.startsWith('fr') ? 'fr' : 'en');
    let sortBy = 'upvotes';
    let activeFilters = [];
    let tagMode = 'or'; // 'or' | 'and'
    let currentConfig = null;
    let currentUser = null;
    let userVotes = new Set();
    let currentModalIndex = -1; // index in window._configs array

    const i18n = {
        fr: {
            logoSub: 'Biblioth√®que de layouts communautaires',
            editorBtn: 'Ouvrir l\'√©diteur',
            loading: 'Chargement...',
            popular: 'Populaire', recent: 'R√©cent', downloads: 'T√©l√©charg√©',
            compete: 'Comp√©tition', casual: 'Loisir', experimental: 'Exp√©rimental',
            topContrib: 'üèÜ TOP CONTRIBUTEURS',
            configs: 'Configurations', contributors: 'Contributeurs', totalDl: 'T√©l√©chargements',
            by: 'par', noPreview: 'Pas d\'aper√ßu',
            warning: '‚ö†Ô∏è Charger cette configuration remplacera votre configuration actuelle dans l\'√©diteur.',
            close: 'Fermer', load: 'Charger dans l\'√©diteur',
            empty: 'Aucune configuration trouv√©e',
            confirmDelete: 'Supprimer cette configuration ?',
            upvotes: 'votes', dlCount: 't√©l√©chargements',
            voteLogin: 'Connectez-vous pour voter',
            voted: 'Votre vote a √©t√© pris en compte !'
        },
        en: {
            logoSub: 'Community Layout Library',
            editorBtn: 'Open editor',
            loading: 'Loading...',
            popular: 'Popular', recent: 'Recent', downloads: 'Downloaded',
            compete: 'Competition', casual: 'Casual', experimental: 'Experimental',
            topContrib: 'üèÜ TOP CONTRIBUTORS',
            configs: 'Configurations', contributors: 'Contributors', totalDl: 'Downloads',
            by: 'by', noPreview: 'No preview',
            warning: '‚ö†Ô∏è Loading this configuration will replace your current configuration in the editor.',
            close: 'Close', load: 'Load in editor',
            empty: 'No configurations found',
            confirmDelete: 'Delete this configuration?',
            upvotes: 'votes', dlCount: 'downloads',
            voteLogin: 'Sign in to vote',
            voted: 'Your vote has been counted!'
        }
    };

    function t(key) { return i18n[lang][key] || key; }

    function toggleLang() {
        lang = lang === 'fr' ? 'en' : 'fr';
        localStorage.setItem('xctrackLang', lang);
        applyLang();
    }

    function applyLang() {
        const T = i18n[lang];
        document.getElementById('langBtn').textContent = lang === 'fr' ? 'üá¨üáß EN' : 'üá´üá∑ FR';
        document.getElementById('logo-sub').textContent = T.logoSub;
        document.getElementById('editorBtnLabel').textContent = T.editorBtn;
        document.getElementById('loadingText').textContent = T.loading;
        document.getElementById('labelConfigs').textContent = T.configs;
        document.getElementById('labelContributors').textContent = T.contributors;
        document.getElementById('labelDownloads').textContent = T.totalDl;
        document.getElementById('topContribLabel').textContent = T.topContrib;
        document.getElementById('btnClose').textContent = T.close;
        document.getElementById('btnLoadLabel').textContent = T.load;
        document.querySelectorAll('.i18n-popular').forEach(el => el.textContent = T.popular);
        document.querySelectorAll('.i18n-recent').forEach(el => el.textContent = T.recent);
        document.querySelectorAll('.i18n-downloads').forEach(el => el.textContent = T.downloads);
        document.querySelectorAll('.i18n-compete').forEach(el => el.textContent = T.compete);
        document.querySelectorAll('.i18n-casual').forEach(el => el.textContent = T.casual);
        document.querySelectorAll('.i18n-experimental').forEach(el => el.textContent = T.experimental);
    }

    function setSort(s) {
        sortBy = s;
        document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === s));
        loadConfigs();
    }

    function toggleTagMode() {
        tagMode = tagMode === 'or' ? 'and' : 'or';
        const btn = document.getElementById('tagModeBtn');
        document.getElementById('tagModeLabel').textContent = tagMode.toUpperCase();
        btn.classList.toggle('and', tagMode === 'and');
        loadConfigs();
    }

    function navigateModal(dir) {
        if (!window._configs) return;
        const newIndex = currentModalIndex + dir;
        if (newIndex < 0 || newIndex >= window._configs.length) return;
        openModalByIndex(newIndex);
    }

    function updateNavArrows() {
        const configs = window._configs || [];
        document.getElementById('arrowLeft').disabled  = currentModalIndex <= 0;
        document.getElementById('arrowRight').disabled = currentModalIndex >= configs.length - 1;
        document.getElementById('modalNavInfo').textContent = `${currentModalIndex + 1} / ${configs.length}`;
    }

    function toggleTagFilter(tag) {
        const btn = document.querySelector(`.tag-btn[data-tag="${tag}"]`);
        if (activeFilters.includes(tag)) {
            activeFilters = activeFilters.filter(t => t !== tag);
            btn.classList.remove('active');
        } else {
            activeFilters.push(tag);
            btn.classList.add('active');
        }
        loadConfigs();
    }

    function tagColor(tag) {
        const map = { cross: 'cross', compete: 'compete', casual: 'casual', experimental: 'experimental', versatile: 'versatile' };
        return map[tag] || 'cross';
    }

    function tagLabel(tag) {
        const map = {
            cross: 'üèîÔ∏è Cross', compete: `üèÅ ${t('compete')}`,
            casual: `‚òÄÔ∏è ${t('casual')}`, experimental: `üÜï ${t('experimental')}`,
            versatile: 'üéØ Versatile'
        };
        return map[tag] || tag;
    }

    async function loadConfigs() {
        const grid = document.getElementById('grid');
        grid.innerHTML = `<div class="loading"><div class="spinner"></div><div>${t('loading')}</div></div>`;

        let query = sb.from('configs').select('id, name, user_email, tags, screenshot, upvotes, downloads, created_at');

        if (activeFilters.length > 0) {
            if (tagMode === 'and') {
                // AND: must contain ALL selected tags
                query = query.contains('tags', activeFilters);
            } else {
                // OR: must contain ANY of the selected tags
                query = query.overlaps('tags', activeFilters);
            }
        }

        query = query.order(sortBy, { ascending: false }).limit(50);

        const { data, error } = await query;
        if (error || !data || data.length === 0) {
            grid.innerHTML = `<div class="empty"><div class="empty-icon">ü™Ç</div><div class="empty-text">${t('empty')}</div></div>`;
            window._configs = [];
            return;
        }

        window._configs = data;

        grid.innerHTML = data.map((config, i) => `
            <div class="card" onclick="openModalByIndex(${i})" style="animation-delay: ${Math.min(i * 0.05, 0.6)}s">
                ${config.screenshot
                    ? `<img class="card-thumb" src="${config.screenshot}" alt="${config.name}" loading="lazy"/>`
                    : `<div class="card-thumb-placeholder">ü™Ç</div>`
                }
                <div class="card-body">
                    <div class="card-name">${config.name}</div>
                    <div class="card-author">${t('by')} ${config.user_email || '‚Äî'}</div>
                    <div class="card-tags">
                        ${(config.tags || []).map(tag => `<span class="tag-pill ${tagColor(tag)}">${tagLabel(tag)}</span>`).join('')}
                    </div>
                    <div class="card-stats">
                        <span>üëç ${config.upvotes || 0}</span>
                        <span>‚¨áÔ∏è ${config.downloads || 0}</span>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async function loadStats() {
        const { data, error } = await sb.from('configs').select('user_email, downloads');
        if (error || !data) return;

        document.getElementById('totalConfigs').textContent = data.length;

        const contributors = {};
        let totalDl = 0;
        data.forEach(c => {
            totalDl += c.downloads || 0;
            const u = c.user_email || 'anonymous';
            contributors[u] = (contributors[u] || 0) + 1;
        });

        document.getElementById('totalDownloads').textContent = totalDl;

        const sorted = Object.entries(contributors).sort((a, b) => b[1] - a[1]);
        document.getElementById('totalContributors').textContent = sorted.length;

        if (sorted.length > 0) {
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            document.getElementById('contributorsList').innerHTML = sorted.slice(0, 8).map(([name, count], i) => `
                <div class="contributor">
                    <div class="contributor-rank">${medals[i] || (i+1)}</div>
                    <div class="contributor-name">${name}</div>
                    <div class="contributor-count">${count} config${count > 1 ? 's' : ''}</div>
                </div>
            `).join('');
            document.getElementById('contributorsSection').style.display = 'block';
        }
    }

    async function openModalByIndex(index) {
        const configs = window._configs || [];
        if (index < 0 || index >= configs.length) return;
        currentModalIndex = index;

        // Fetch full config (including config_json)
        const { data, error } = await sb.from('configs').select('*').eq('id', configs[index].id).single();
        if (error || !data) return;
        currentConfig = data;

        const overlay = document.getElementById('modalOverlay');
        const thumb = document.getElementById('modalThumb');

        if (data.screenshot) {
            thumb.src = data.screenshot;
            thumb.style.display = 'block';
            thumb.classList.remove('zoomed');
        } else {
            thumb.style.display = 'none';
        }

        document.getElementById('modalName').textContent = data.name;
        document.getElementById('modalMeta').textContent = `${t('by')} ${data.user_email || '‚Äî'}`;
        document.getElementById('modalTags').innerHTML = (data.tags || [])
            .map(tag => `<span class="tag-pill ${tagColor(tag)}">${tagLabel(tag)}</span>`).join('');
        document.getElementById('modalStats').innerHTML = `
            <span>üëç ${data.upvotes || 0} ${t('upvotes')}</span>
            <span>‚¨áÔ∏è ${data.downloads || 0} ${t('dlCount')}</span>
        `;
        document.getElementById('warningBox').textContent = t('warning');

        // Show delete if owner or admin
        const canDelete = currentUser && (currentUser.id === data.user_id || currentUser.email === ADMIN_EMAIL);
        document.getElementById('btnDelete').style.display = canDelete ? 'block' : 'none';

        // Show edit tags if owner or admin
        const editSection = document.getElementById('editTagsSection');
        if (canDelete) {
            editSection.style.display = 'block';
            renderEditTags();
        } else {
            editSection.style.display = 'none';
        }

        // Vote button
        document.getElementById('btnVoteCount').textContent = data.upvotes || 0;
        updateVoteButton();

        // Nav arrows
        updateNavArrows();

        // Show overlay
        overlay.style.display = 'flex';
        requestAnimationFrame(() => overlay.classList.add('visible'));

        // Increment download count on open
        await sb.from('configs').update({ downloads: (data.downloads || 0) + 1 }).eq('id', data.id);
    }

    // Keep old openModal for compatibility
    async function openModal(id) {
        const configs = window._configs || [];
        const index = configs.findIndex(c => c.id === id);
        await openModalByIndex(index >= 0 ? index : 0);
    }

    function closeModal() {
        const overlay = document.getElementById('modalOverlay');
        overlay.classList.remove('visible');
        setTimeout(() => { overlay.style.display = 'none'; currentConfig = null; }, 200);
    }

    function closeModalOnBg(e) {
        if (e.target === document.getElementById('modalOverlay')) closeModal();
    }

    function toggleZoom(img) {
        img.classList.toggle('zoomed');
    }

    async function toggleVote() {
        if (!currentUser) {
            alert(t('voteLogin'));
            return;
        }
        const id = currentConfig.id;
        const btn = document.getElementById('btnVote');
        const hasVoted = userVotes.has(id);

        if (hasVoted) {
            // Remove vote
            await sb.from('upvotes').delete().eq('config_id', id).eq('user_id', currentUser.id);
            const newCount = Math.max(0, (currentConfig.upvotes || 0) - 1);
            await sb.from('configs').update({ upvotes: newCount }).eq('id', id);
            currentConfig.upvotes = newCount;
            userVotes.delete(id);
        } else {
            // Add vote
            await sb.from('upvotes').insert({ config_id: id, user_id: currentUser.id });
            const newCount = (currentConfig.upvotes || 0) + 1;
            await sb.from('configs').update({ upvotes: newCount }).eq('id', id);
            currentConfig.upvotes = newCount;
            userVotes.add(id);
        }

        updateVoteButton();
        loadConfigs(); // refresh grid
    }

    function updateVoteButton() {
        if (!currentConfig) return;
        const btn = document.getElementById('btnVote');
        const hasVoted = userVotes.has(currentConfig.id);
        btn.classList.toggle('voted', hasVoted);
        btn.innerHTML = `${hasVoted ? 'üëç' : 'üëç'} <span id="btnVoteCount">${currentConfig.upvotes || 0}</span>`;
    }

    async function loadUserVotes() {
        if (!currentUser) return;
        const { data } = await sb.from('upvotes').select('config_id').eq('user_id', currentUser.id);
        if (data) userVotes = new Set(data.map(v => v.config_id));
    }

    function loadInEditor() {
        if (!currentConfig) return;
        const json = JSON.stringify(currentConfig.config_json);
        localStorage.setItem('xctrackConfig', json);
        // Detect and save orientation from config
        const cfg = currentConfig.config_json;
        if (cfg?.layout) {
            const hasLandscape = cfg.layout.landscape && cfg.layout.landscape.length > 0;
            const hasPortrait  = cfg.layout.portrait  && cfg.layout.portrait.length  > 0;
            // Prefer landscape if both exist, otherwise use the one that exists
            if (hasLandscape) localStorage.setItem('xctrackOrientation', 'landscape');
            else if (hasPortrait) localStorage.setItem('xctrackOrientation', 'portrait');
        }
        window.open(EDITOR_URL, '_blank');
    }

    const ALL_TAGS = ['cross', 'compete', 'casual', 'experimental'];
    const TAG_LABELS = { cross: 'üèîÔ∏è Cross', compete: 'üèÅ', casual: '‚òÄÔ∏è', experimental: 'üÜï' };

    let editingTags = [];

    function renderEditTags() {
        editingTags = [...(currentConfig.tags || [])];
        const container = document.getElementById('editTagsBtns');
        container.innerHTML = ALL_TAGS.map(tag => `
            <button class="edit-tag-btn ${editingTags.includes(tag) ? 'active' : ''}"
                    data-tag="${tag}"
                    onclick="toggleEditTag('${tag}')">
                ${TAG_LABELS[tag]} ${tagLabel(tag).replace(/^[^\s]+\s/, '')}
            </button>
        `).join('');
    }

    function toggleEditTag(tag) {
        if (editingTags.includes(tag)) {
            if (editingTags.length === 1) return; // at least 1 tag required
            editingTags = editingTags.filter(t => t !== tag);
        } else {
            editingTags.push(tag);
        }
        // Update buttons
        document.querySelectorAll('.edit-tag-btn').forEach(btn => {
            btn.classList.toggle('active', editingTags.includes(btn.dataset.tag));
        });
        // Auto-save
        saveTagEdit();
    }

    async function saveTagEdit() {
        if (!currentConfig) return;
        const { error } = await sb.from('configs')
            .update({ tags: editingTags, category: editingTags[0] })
            .eq('id', currentConfig.id);
        if (!error) {
            currentConfig.tags = editingTags;
            // Refresh tag pills in modal
            document.getElementById('modalTags').innerHTML = editingTags
                .map(tag => `<span class="tag-pill ${tagColor(tag)}">${tagLabel(tag)}</span>`).join('');
            loadConfigs();
        }
    }

    async function deleteConfig() {
        if (!currentConfig) return;
        if (!confirm(t('confirmDelete'))) return;
        const { error } = await sb.from('configs').delete().eq('id', currentConfig.id);
        if (!error) {
            closeModal();
            loadConfigs();
            loadStats();
        }
    }

    // ESC to close modal, arrows to navigate
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') closeModal();
        if (e.key === 'ArrowLeft')  navigateModal(-1);
        if (e.key === 'ArrowRight') navigateModal(1);
    });

    // Init auth (for delete button visibility and votes)
    sb.auth.getSession().then(({ data: { session } }) => {
        currentUser = session?.user ?? null;
        if (currentUser) loadUserVotes();
    });
    sb.auth.onAuthStateChange((_event, session) => {
        currentUser = session?.user ?? null;
        if (currentUser) loadUserVotes();
    });

    // Init
    applyLang();
    loadStats();
    loadConfigs();
</script>

<!-- Upload Modal -->
<div class="upload-modal" id="uploadModal">
    <div class="upload-modal-content">
        <button class="upload-modal-close" id="uploadModalClose">√ó</button>
        <h2 id="uploadModalTitle">Uploader ma config</h2>
        
        <div class="upload-form-group">
            <label id="uploadLabelFile">Fichier .xcfg</label>
            <div class="upload-file-drop" id="fileDrop">
                <div id="fileDropText">üìÇ Glissez-d√©posez votre fichier .xcfg<br>ou cliquez pour parcourir</div>
            </div>
            <input type="file" id="fileInput" accept=".xcfg,.json" style="display:none">
        </div>
        
        <div class="upload-form-group">
            <label id="uploadLabelName">Nom de la configuration</label>
            <input type="text" id="configName" placeholder="Ex: Ma config comp√©tition" maxlength="100">
        </div>
        
        <div class="upload-form-group">
            <label id="uploadLabelTags">Tags (cochez tous ceux qui s'appliquent)</label>
            <div class="upload-tags">
                <input type="checkbox" id="tagCross" class="upload-tag-checkbox" checked>
                <label for="tagCross" class="upload-tag-label" data-tag="cross">üèîÔ∏è Cross</label>
                
                <input type="checkbox" id="tagCompete" class="upload-tag-checkbox" checked>
                <label for="tagCompete" class="upload-tag-label" data-tag="compete">üèÅ <span class="i18n-compete">Comp√©tition</span></label>
                
                <input type="checkbox" id="tagCasual" class="upload-tag-checkbox" checked>
                <label for="tagCasual" class="upload-tag-label" data-tag="casual">‚òÄÔ∏è <span class="i18n-casual">Loisir</span></label>
                
                <input type="checkbox" id="tagExperimental" class="upload-tag-checkbox" checked>
                <label for="tagExperimental" class="upload-tag-label" data-tag="experimental">üÜï <span class="i18n-experimental">Exp√©rimental</span></label>
            </div>
        </div>
        
        <button class="upload-submit" id="uploadSubmit" disabled>
            <span id="uploadBtnSubmit">üì§ Uploader vers la biblioth√®que</span>
        </button>
        
        <div class="upload-error" id="uploadError"></div>
    </div>
</div>

<script>
    // Upload Modal Management
    let selectedFile = null;
    let parsedConfig = null;

    // Setup event listeners (script is at end of body, DOM is ready)
    const fileDrop = document.getElementById('fileDrop');
    const fileInput = document.getElementById('fileInput');
    const uploadSubmit = document.getElementById('uploadSubmit');
    const uploadModalClose = document.getElementById('uploadModalClose');
    
    fileDrop.addEventListener('click', () => fileInput.click());
    fileDrop.addEventListener('drop', handleFileDrop);
    fileDrop.addEventListener('dragover', handleDragOver);
    fileDrop.addEventListener('dragleave', handleDragLeave);
    
    fileInput.addEventListener('change', handleFileSelect);
    uploadSubmit.addEventListener('click', handleUpload);
    uploadModalClose.addEventListener('click', closeUploadModal);

    function openUploadModal() {
        // DISABLED: Login requirement - trusting community for now
        // Uncomment if abuse happens
        /*
        if (!currentUser) {
            alert(lang === 'fr' 
                ? 'Vous devez √™tre connect√© avec Google pour uploader une configuration. Utilisez l\'√©diteur pour vous connecter.'
                : 'You must be logged in with Google to upload a configuration. Use the editor to log in.');
            return;
        }
        */
        
        document.getElementById('uploadModal').classList.add('active');
        resetUploadForm();
    }

    function closeUploadModal() {
        document.getElementById('uploadModal').classList.remove('active');
        resetUploadForm();
    }

    function resetUploadForm() {
        selectedFile = null;
        parsedConfig = null;
        document.getElementById('fileInput').value = '';
        document.getElementById('configName').value = '';
        document.getElementById('fileDrop').classList.remove('has-file');
        document.getElementById('fileDropText').innerHTML = lang === 'fr'
            ? 'üìÇ Glissez-d√©posez votre fichier .xcfg<br>ou cliquez pour parcourir'
            : 'üìÇ Drag & drop your .xcfg file<br>or click to browse';
        document.getElementById('uploadSubmit').disabled = true;
        document.getElementById('uploadError').classList.remove('active');
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('fileDrop').classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('fileDrop').classList.remove('drag-over');
    }

    function handleFileDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById('fileDrop').classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            processFile(files[0]);
        }
    }

    function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            processFile(files[0]);
        }
    }

    // Auto-detect tags from config content
    function detectTags(config) {
        if (!config?.layout) return ['casual'];
        
        const tags = new Set();
        let hasCompetition = false;
        let hasCross = false;
        let totalWidgets = 0;
        
        // Scan all orientations and pages
        Object.keys(config.layout).forEach(orientation => {
            const pages = config.layout[orientation] || [];
            pages.forEach(page => {
                const widgets = page.widgets || [];
                totalWidgets += widgets.length;
                
                widgets.forEach(widget => {
                    const cls = (widget.CLASS || '').toLowerCase();
                    
                    // Competition indicators
                    if (cls.includes('competition') || 
                        cls.includes('opti') || 
                        cls.includes('compmap') ||
                        cls.includes('compdistance') ||
                        cls.includes('compglide')) {
                        hasCompetition = true;
                    }
                    
                    // Cross country indicators
                    if (cls.includes('xcassistant') || 
                        cls.includes('xcspeed') ||
                        cls.includes('thermalassistant')) {
                        hasCross = true;
                    }
                });
            });
        });
        
        // Apply tags based on detection
        if (hasCompetition) tags.add('compete');
        if (hasCross) tags.add('cross');
        
        // If many widgets, likely not casual
        // If few widgets or no specific indicators, it's casual
        if (totalWidgets < 15 || tags.size === 0) {
            tags.add('casual');
        }
        
        return Array.from(tags);
    }

    function applyDetectedTags(detectedTags) {
        // Uncheck all first
        document.getElementById('tagCross').checked = false;
        document.getElementById('tagCompete').checked = false;
        document.getElementById('tagCasual').checked = false;
        document.getElementById('tagExperimental').checked = false;
        
        // Check detected tags
        detectedTags.forEach(tag => {
            if (tag === 'cross') document.getElementById('tagCross').checked = true;
            if (tag === 'compete') document.getElementById('tagCompete').checked = true;
            if (tag === 'casual') document.getElementById('tagCasual').checked = true;
            if (tag === 'experimental') document.getElementById('tagExperimental').checked = true;
        });
    }

    async function processFile(file) {
        if (!file.name.endsWith('.xcfg') && !file.name.endsWith('.json')) {
            showUploadError(lang === 'fr'
                ? 'Seuls les fichiers .xcfg sont accept√©s'
                : 'Only .xcfg files are accepted');
            return;
        }

        try {
            const text = await file.text();
            const config = JSON.parse(text);
            
            // Validate structure (just check it's a valid XCTrack config)
            if (!config.layout) {
                throw new Error('Invalid config structure - missing layout field');
            }

            selectedFile = file;
            parsedConfig = config;
            
            // Auto-detect and apply tags
            const detectedTags = detectTags(config);
            applyDetectedTags(detectedTags);
            
            // Update UI
            document.getElementById('fileDrop').classList.add('has-file');
            document.getElementById('fileDropText').innerHTML = `‚úÖ ${file.name}`;
            
            // Auto-fill name if empty
            if (!document.getElementById('configName').value) {
                const baseName = file.name.replace('.xcfg', '').replace('.json', '');
                document.getElementById('configName').value = baseName;
            }
            
            // Enable submit
            document.getElementById('uploadSubmit').disabled = false;
            
        } catch (err) {
            showUploadError(lang === 'fr'
                ? 'Fichier invalide ou corrompu'
                : 'Invalid or corrupted file');
            console.error('Parse error:', err);
        }
    }

    async function handleUpload() {
        if (!selectedFile || !parsedConfig) return;

        const configName = document.getElementById('configName').value.trim();
        if (!configName) {
            showUploadError(lang === 'fr'
                ? 'Veuillez entrer un nom pour la configuration'
                : 'Please enter a name for the configuration');
            return;
        }

        // Get selected tags
        const tags = [];
        if (document.getElementById('tagCross').checked) tags.push('cross');
        if (document.getElementById('tagCompete').checked) tags.push('compete');
        if (document.getElementById('tagCasual').checked) tags.push('casual');
        if (document.getElementById('tagExperimental').checked) tags.push('experimental');

        if (tags.length === 0) {
            showUploadError(lang === 'fr'
                ? 'Veuillez s√©lectionner au moins un tag'
                : 'Please select at least one tag');
            return;
        }

        // Disable button
        const submitBtn = document.getElementById('uploadSubmit');
        submitBtn.disabled = true;
        submitBtn.innerHTML = lang === 'fr' ? '‚è≥ Upload en cours...' : '‚è≥ Uploading...';

        try {
            // Generate screenshot (use first page)
            const screenshot = await generateScreenshot(parsedConfig);
            
            // Upload to Supabase (user_id/email optional if not logged in)
            const { data, error } = await sb
                .from('configs')
                .insert({
                    name: configName,
                    user_id: currentUser?.id || null,
                    user_email: currentUser?.email || null,
                    config_json: parsedConfig,
                    screenshot: screenshot,
                    category: tags[0] || 'casual',  // Required field - use first tag or default to casual
                    tags: tags
                })
                .select()
                .single();

            if (error) throw error;

            // Success!
            alert(lang === 'fr'
                ? '‚úÖ Configuration upload√©e avec succ√®s !'
                : '‚úÖ Configuration uploaded successfully!');
            
            closeUploadModal();
            loadConfigs(); // Reload configs to show new one
            
        } catch (err) {
            console.error('Upload error:', err);
            showUploadError(lang === 'fr'
                ? `Erreur lors de l'upload: ${err.message}`
                : `Upload error: ${err.message}`);
            submitBtn.disabled = false;
            submitBtn.innerHTML = lang === 'fr' ? 'üì§ Uploader vers la biblioth√®que' : 'üì§ Upload to Library';
        }
    }

    async function generateScreenshot(config) {
        // Simple SVG screenshot generator
        // This creates a basic representation - could be enhanced
        const width = config.screenResolution?.width || 1440;
        const height = config.screenResolution?.height || 2560;
        const orientation = config.screenResolution?.orientation || 0;
        
        // Get first page widgets
        const firstPage = Object.keys(config.layout || {}).sort()[0];
        const widgets = config.layout[firstPage] || [];
        
        // Create simple SVG
        let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">`;
        svg += `<rect width="${width}" height="${height}" fill="#e0f2fe"/>`;
        
        // Draw widgets as simple rectangles
        widgets.forEach(w => {
            const x = (w.X1 / 10000) * width;
            const y = (w.Y1 / 10000) * height;
            const w2 = ((w.X2 - w.X1) / 10000) * width;
            const h2 = ((w.Y2 - w.Y1) / 10000) * height;
            svg += `<rect x="${x}" y="${y}" width="${w2}" height="${h2}" fill="rgba(100,116,139,0.2)" stroke="rgba(100,116,139,0.5)" stroke-width="2"/>`;
        });
        
        svg += `</svg>`;
        
        return `data:image/svg+xml;base64,${btoa(svg)}`;
    }

    function showUploadError(message) {
        const errorEl = document.getElementById('uploadError');
        errorEl.textContent = message;
        errorEl.classList.add('active');
    }

    // Add translations for upload modal
    const uploadTranslations = {
        fr: {
            uploadBtn: 'Uploader ma config',
            uploadModalTitle: 'Uploader ma config',
            uploadLabelFile: 'Fichier .xcfg',
            uploadLabelName: 'Nom de la configuration',
            uploadLabelTags: 'Tags (cochez tous ceux qui s\'appliquent)',
            uploadBtnSubmit: 'üì§ Uploader vers la biblioth√®que',
            fileDropText: 'üìÇ Glissez-d√©posez votre fichier .xcfg<br>ou cliquez pour parcourir'
        },
        en: {
            uploadBtn: 'Upload My Config',
            uploadModalTitle: 'Upload My Config',
            uploadLabelFile: '.xcfg File',
            uploadLabelName: 'Configuration Name',
            uploadLabelTags: 'Tags (check all that apply)',
            uploadBtnSubmit: 'üì§ Upload to Library',
            fileDropText: 'üìÇ Drag & drop your .xcfg file<br>or click to browse'
        }
    };

    // Extend applyLang to include upload translations
    const originalApplyLang = applyLang;
    applyLang = function() {
        originalApplyLang();
        const t = uploadTranslations[lang];
        document.getElementById('uploadBtnLabel').textContent = t.uploadBtn;
        document.getElementById('uploadModalTitle').textContent = t.uploadModalTitle;
        document.getElementById('uploadLabelFile').textContent = t.uploadLabelFile;
        document.getElementById('uploadLabelName').textContent = t.uploadLabelName;
        document.getElementById('uploadLabelTags').textContent = t.uploadLabelTags;
        document.getElementById('uploadBtnSubmit').textContent = t.uploadBtnSubmit;
        if (!selectedFile) {
            document.getElementById('fileDropText').innerHTML = t.fileDropText;
        }
    };
</script>

</body>
</html>
